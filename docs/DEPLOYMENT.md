# Deployment Guide

## Overview

This guide covers deploying the Ho Yu College platform to AWS using CDK and CloudFront.

## Architecture

The deployment consists of:
- **Backend**: API Gateway + Lambda functions + DynamoDB tables (deployed via CDK)
- **Frontend**: React SPA hosted on S3 + CloudFront distribution
- **Build Output**: All CDK artifacts stored in `infra/build/` directory

## Prerequisites

1. **AWS CLI** configured with appropriate credentials
   ```bash
   aws configure
   ```

2. **Node.js** v18+ and **Yarn** package manager
   ```bash
   yarn --version  # Should be 1.22.0 or higher
   ```

3. **AWS CDK** bootstrap (one-time setup per AWS account/region)
   ```bash
   cd infra
   yarn cdk bootstrap
   ```

4. **Email for Budget Alerts** (optional but recommended)
   - You'll be prompted for an email address during deployment
   - You'll receive a confirmation email from AWS to activate alerts

## Deployment Process

The deployment script (`infra/scripts/deploy.sh`) automates the entire process:

### One-Command Deployment

From the **project root** or **infra directory**:

```bash
yarn deploy
```

This will:
1. ‚úÖ Build backend Lambda functions
2. ‚úÖ Deploy CDK infrastructure (API Gateway, Lambda, DynamoDB, S3, CloudFront)
3. ‚úÖ Extract API Gateway endpoint from CDK outputs
4. ‚úÖ Create frontend `.env` file with API URL
5. ‚úÖ Build frontend with environment variables
6. ‚úÖ Upload frontend to S3 bucket
7. ‚úÖ Invalidate CloudFront cache

### Manual Step-by-Step

If you prefer manual control:

```bash
# 1. Build and deploy backend infrastructure
cd infra
yarn build:backend  # Build Lambda functions
yarn build          # Compile CDK TypeScript
yarn cdk deploy     # Deploy to AWS

# 2. Get API Gateway URL from CDK outputs
# (Check AWS Console or build/cdk-outputs.json)

# 3. Create frontend .env file
cd ../frontend
cat > .env << EOF
VITE_API_URL=https://your-api-id.execute-api.region.amazonaws.com/prod/
VITE_FRONTEND_URL=https://your-distribution.cloudfront.net
EOF

# 4. Build frontend
yarn build

# 5. Upload to S3
aws s3 sync dist/ s3://your-bucket-name --delete

# 6. Invalidate CloudFront cache
aws cloudfront create-invalidation --distribution-id YOUR_DIST_ID --paths "/*"
```

## CDK Output Directory

All CDK build artifacts are stored in:
```
infra/build/
‚îú‚îÄ‚îÄ cdk.out/              # CloudFormation templates
‚îú‚îÄ‚îÄ cdk-outputs.json      # Stack outputs (API URL, CloudFront URL, etc.)
‚îî‚îÄ‚îÄ ...
```

This is configured in `infra/cdk.json`:
```json
{
  "output": "build/cdk.out"
}
```

## Environment Variables

The deployment script automatically creates `frontend/.env` with:

```bash
# Auto-generated by deploy script
VITE_API_URL=https://xxxxx.execute-api.us-east-1.amazonaws.com/prod/
VITE_FRONTEND_URL=https://xxxxx.cloudfront.net
```

For local development, copy `.env.example` to `.env`:
```bash
cd frontend
cp .env.example .env
# Edit .env with local API URL (http://localhost:3000)
```

## CloudFront Configuration

The deployment includes:
- ‚úÖ **Origin Access Control (OAC)** for secure S3 access
- ‚úÖ **HTTPS only** (redirects HTTP to HTTPS)
- ‚úÖ **SPA routing** (404/403 ‚Üí index.html)
- ‚úÖ **Optimized caching**:
  - Static assets: 1 year cache
  - `index.html`: No cache (always fresh)

## Budget Alerts

The stack includes AWS Budget monitoring to help control costs:

### Configuration
- **Budget Limit**: $10 USD per month
- **Alerts**: Email notifications at 80%, 100%, and forecasted 100%
- **Email Setup**: You'll be prompted for an email during first deployment

### Setting Your Email

**During deployment:**
```bash
yarn deploy
# You'll be prompted: "BudgetAlertEmail: your-email@example.com"
# Enter your email address
```

**Or specify during CDK deploy:**
```bash
cd infra
yarn cdk deploy --parameters BudgetAlertEmail=your-email@example.com
```

### Email Confirmation

1. After deployment, check your email for an AWS Budgets subscription confirmation
2. Click the confirmation link to activate budget alerts
3. You'll receive notifications when:
   - **80% threshold**: Warning that you're approaching the limit ($8 USD)
   - **100% threshold**: Alert that you've exceeded the budget ($10 USD)
   - **Forecasted 100%**: Prediction that you'll exceed the budget this month

### Viewing Budget

Check your budget in the AWS Console:
```bash
# Open AWS Budgets console
aws budgets describe-budgets --account-id $(aws sts get-caller-identity --query Account --output text)
```

Or visit: [AWS Budgets Console](https://console.aws.amazon.com/billing/home#/budgets)

### Adjusting Budget

To change the budget limit, edit `infra/lib/backend-stack.ts`:
```typescript
budgetLimit: {
  amount: 20,  // Change from 10 to 20 USD
  unit: 'USD',
}
```

Then redeploy:
```bash
yarn deploy
```

## Deployment Outputs

After successful deployment, you'll see:

```
‚úì Deployment completed successfully! üéâ

Frontend URL: https://xxxxx.cloudfront.net
API URL: https://xxxxx.execute-api.region.amazonaws.com/prod/
S3 Bucket: ho-yu-college-frontend-123456789
CloudFront Distribution: E1234567890ABC
```

## Troubleshooting

### CDK Deployment Fails

```bash
# Check AWS credentials
aws sts get-caller-identity

# Check CDK version
yarn cdk --version

# Re-bootstrap if needed
yarn cdk bootstrap
```

### Frontend Not Updating

```bash
# CloudFront cache takes 5-15 minutes to invalidate
# Check invalidation status:
aws cloudfront get-invalidation \
  --distribution-id YOUR_DIST_ID \
  --id INVALIDATION_ID
```

### API Gateway Not Working

```bash
# Check API Gateway endpoint
aws apigateway get-rest-apis

# Test endpoint directly
curl https://your-api-url.execute-api.region.amazonaws.com/prod/games
```

### Build Directory Permissions

```bash
# If you get permission errors:
cd infra
mkdir -p build
chmod 755 build
```

## Updating the Application

To deploy updates:

```bash
# From project root
yarn deploy
```

The script will:
1. Rebuild all changed Lambda functions
2. Update CDK stack (if infrastructure changed)
3. Rebuild and redeploy frontend
4. Invalidate CloudFront cache

## Rollback

To rollback to a previous version:

```bash
cd infra

# List available CloudFormation stack versions
aws cloudformation list-stack-resources --stack-name BackendStack

# Rollback is not directly supported by CDK
# Best practice: Deploy previous Git commit
git checkout <previous-commit>
yarn deploy
```

## Cost Considerations

- **CloudFront**: Free tier includes 1TB data transfer + 10M requests/month
- **API Gateway**: $3.50 per million requests
- **Lambda**: Free tier includes 1M requests + 400,000 GB-seconds/month
- **DynamoDB**: Free tier includes 25GB storage + 25 read/write capacity units
- **S3**: ~$0.023 per GB/month

Typical monthly cost for low-traffic educational use: **$0-5**

## Clean Up

To destroy all AWS resources:

```bash
cd infra
yarn cdk destroy

# This will delete:
# - CloudFront distribution
# - S3 bucket and contents
# - API Gateway
# - Lambda functions
# - DynamoDB tables
```

‚ö†Ô∏è **Warning**: This is permanent and will delete all data!

## Additional Resources

- [AWS CDK Documentation](https://docs.aws.amazon.com/cdk/)
- [CloudFront Developer Guide](https://docs.aws.amazon.com/cloudfront/)
- [Vite Environment Variables](https://vitejs.dev/guide/env-and-mode.html)
