"use strict";
/**
 * Login Lambda Function Tests
 * Unit tests for authentication logic
 */
Object.defineProperty(exports, "__esModule", { value: true });
const login_1 = require("../../lambda/auth/login");
const mocks_1 = require("../mocks");
// Mock AWS SDK
jest.mock('@aws-sdk/client-dynamodb');
jest.mock('@aws-sdk/lib-dynamodb', () => {
    return {
        DynamoDBDocumentClient: {
            from: jest.fn(() => ({
                send: jest.fn((command) => {
                    // Mock implementation to return data based on command
                    const tableName = command.input?.TableName;
                    const key = command.input?.Key;
                    if (tableName === process.env.STUDENTS_TABLE_NAME && key?.student_id) {
                        const student = mocks_1.mockStudents.find((s) => s.student_id === key.student_id);
                        return Promise.resolve({ Item: student });
                    }
                    if (tableName === process.env.TEACHERS_TABLE_NAME && key?.teacher_id) {
                        const teacher = mocks_1.mockTeachers.find((t) => t.teacher_id === key.teacher_id);
                        return Promise.resolve({ Item: teacher });
                    }
                    return Promise.resolve({ Item: undefined });
                }),
            })),
        },
        GetCommand: jest.fn((input) => ({ input })),
    };
});
// Set environment variables
process.env.STUDENTS_TABLE_NAME = 'ho-yu-students';
process.env.TEACHERS_TABLE_NAME = 'ho-yu-teachers';
describe('Login Lambda Handler', () => {
    const createEvent = (body) => ({
        body: JSON.stringify(body),
        headers: {},
        multiValueHeaders: {},
        httpMethod: 'POST',
        isBase64Encoded: false,
        path: '/auth/login',
        pathParameters: null,
        queryStringParameters: null,
        multiValueQueryStringParameters: null,
        stageVariables: null,
        requestContext: {},
        resource: '',
    });
    describe('Input Validation', () => {
        test('should return 400 if id is missing', async () => {
            const event = createEvent({ password: 'test123' });
            const result = await (0, login_1.handler)(event);
            expect(result.statusCode).toBe(400);
            expect(JSON.parse(result.body)).toEqual({ message: 'Missing id or password' });
        });
        test('should return 400 if password is missing', async () => {
            const event = createEvent({ id: 'STU001' });
            const result = await (0, login_1.handler)(event);
            expect(result.statusCode).toBe(400);
            expect(JSON.parse(result.body)).toEqual({ message: 'Missing id or password' });
        });
        test('should return 400 if both id and password are missing', async () => {
            const event = createEvent({});
            const result = await (0, login_1.handler)(event);
            expect(result.statusCode).toBe(400);
            expect(JSON.parse(result.body)).toEqual({ message: 'Missing id or password' });
        });
    });
    describe('Student Authentication', () => {
        test('should successfully authenticate valid student', async () => {
            const event = createEvent({
                id: 'STU001',
                password: mocks_1.MOCK_STUDENT_PASSWORD,
            });
            const result = await (0, login_1.handler)(event);
            expect(result.statusCode).toBe(200);
            const body = JSON.parse(result.body);
            expect(body.success).toBe(true);
            expect(body.role).toBe('student');
            expect(body.user).toBeDefined();
            expect(body.user.student_id).toBe('STU001');
            expect(body.user.password).toBeUndefined(); // Password should be removed
        });
        test('should fail authentication with wrong password', async () => {
            const event = createEvent({
                id: 'STU001',
                password: 'wrongpassword',
            });
            const result = await (0, login_1.handler)(event);
            expect(result.statusCode).toBe(401);
            expect(JSON.parse(result.body)).toEqual({ message: 'Invalid credentials' });
        });
        test('should fail authentication for non-existent student', async () => {
            const event = createEvent({
                id: 'STU999',
                password: mocks_1.MOCK_STUDENT_PASSWORD,
            });
            const result = await (0, login_1.handler)(event);
            expect(result.statusCode).toBe(401);
            expect(JSON.parse(result.body)).toEqual({ message: 'Invalid credentials' });
        });
        test('should authenticate multiple students with same password', async () => {
            for (const student of mocks_1.mockStudents.slice(0, 3)) {
                const event = createEvent({
                    id: student.student_id,
                    password: mocks_1.MOCK_STUDENT_PASSWORD,
                });
                const result = await (0, login_1.handler)(event);
                expect(result.statusCode).toBe(200);
                const body = JSON.parse(result.body);
                expect(body.user.student_id).toBe(student.student_id);
            }
        });
    });
    describe('Teacher Authentication', () => {
        test('should successfully authenticate valid teacher', async () => {
            const event = createEvent({
                id: 'TCH001',
                password: mocks_1.MOCK_TEACHER_PASSWORD,
            });
            const result = await (0, login_1.handler)(event);
            expect(result.statusCode).toBe(200);
            const body = JSON.parse(result.body);
            expect(body.success).toBe(true);
            expect(body.role).toBe('teacher');
            expect(body.user).toBeDefined();
            expect(body.user.teacher_id).toBe('TCH001');
            expect(body.user.password).toBeUndefined(); // Password should be removed
        });
        test('should fail authentication with wrong password', async () => {
            const event = createEvent({
                id: 'TCH001',
                password: 'wrongpassword',
            });
            const result = await (0, login_1.handler)(event);
            expect(result.statusCode).toBe(401);
            expect(JSON.parse(result.body)).toEqual({ message: 'Invalid credentials' });
        });
        test('should fail authentication for non-existent teacher', async () => {
            const event = createEvent({
                id: 'TCH999',
                password: mocks_1.MOCK_TEACHER_PASSWORD,
            });
            const result = await (0, login_1.handler)(event);
            expect(result.statusCode).toBe(401);
            expect(JSON.parse(result.body)).toEqual({ message: 'Invalid credentials' });
        });
    });
    describe('Admin Authentication', () => {
        test('should successfully authenticate admin and return admin role', async () => {
            const event = createEvent({
                id: 'TCH003',
                password: mocks_1.MOCK_ADMIN_PASSWORD,
            });
            const result = await (0, login_1.handler)(event);
            expect(result.statusCode).toBe(200);
            const body = JSON.parse(result.body);
            expect(body.success).toBe(true);
            expect(body.role).toBe('admin');
            expect(body.user).toBeDefined();
            expect(body.user.teacher_id).toBe('TCH003');
            expect(body.user.is_admin).toBe(true);
            expect(body.user.password).toBeUndefined();
        });
        test('should not authenticate admin with teacher password', async () => {
            const event = createEvent({
                id: 'TCH003',
                password: mocks_1.MOCK_TEACHER_PASSWORD,
            });
            const result = await (0, login_1.handler)(event);
            expect(result.statusCode).toBe(401);
            expect(JSON.parse(result.body)).toEqual({ message: 'Invalid credentials' });
        });
    });
    describe('Response Headers', () => {
        test('should include CORS headers in successful response', async () => {
            const event = createEvent({
                id: 'STU001',
                password: mocks_1.MOCK_STUDENT_PASSWORD,
            });
            const result = await (0, login_1.handler)(event);
            expect(result.headers).toBeDefined();
            expect(result.headers['Content-Type']).toBe('application/json');
            expect(result.headers['Access-Control-Allow-Origin']).toBe('*');
        });
        test('should include CORS headers in error response', async () => {
            const event = createEvent({
                id: 'STU001',
                password: 'wrongpassword',
            });
            const result = await (0, login_1.handler)(event);
            expect(result.headers).toBeDefined();
            expect(result.headers['Content-Type']).toBe('application/json');
            expect(result.headers['Access-Control-Allow-Origin']).toBe('*');
        });
    });
    describe('Security', () => {
        test('should not return password in successful response', async () => {
            const event = createEvent({
                id: 'STU001',
                password: mocks_1.MOCK_STUDENT_PASSWORD,
            });
            const result = await (0, login_1.handler)(event);
            const body = JSON.parse(result.body);
            expect(body.user.password).toBeUndefined();
        });
        test('should not return password hash in response', async () => {
            const event = createEvent({
                id: 'STU001',
                password: mocks_1.MOCK_STUDENT_PASSWORD,
            });
            const result = await (0, login_1.handler)(event);
            const responseStr = result.body;
            // Ensure no SHA-256 hash (64 hex chars) is in response
            expect(responseStr).not.toMatch(/[a-f0-9]{64}/);
        });
    });
    describe('Edge Cases', () => {
        test('should handle empty body gracefully', async () => {
            const event = createEvent(null);
            const result = await (0, login_1.handler)(event);
            expect(result.statusCode).toBe(500);
        });
        test('should handle malformed JSON body', async () => {
            const event = {
                body: 'not valid json',
                headers: {},
                multiValueHeaders: {},
                httpMethod: 'POST',
                isBase64Encoded: false,
                path: '/auth/login',
                pathParameters: null,
                queryStringParameters: null,
                multiValueQueryStringParameters: null,
                stageVariables: null,
                requestContext: {},
                resource: '',
            };
            const result = await (0, login_1.handler)(event);
            expect(result.statusCode).toBe(500);
        });
        test('should treat empty strings as missing credentials', async () => {
            const event = createEvent({ id: '', password: '' });
            const result = await (0, login_1.handler)(event);
            expect(result.statusCode).toBe(400);
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9naW4udGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImxvZ2luLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7QUFHSCxtREFBa0Q7QUFDbEQsb0NBQXlIO0FBRXpILGVBQWU7QUFDZixJQUFJLENBQUMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLENBQUM7QUFDdEMsSUFBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUU7SUFDdEMsT0FBTztRQUNMLHNCQUFzQixFQUFFO1lBQ3RCLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBQ25CLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBWSxFQUFFLEVBQUU7b0JBQzdCLHNEQUFzRDtvQkFDdEQsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLEtBQUssRUFBRSxTQUFTLENBQUM7b0JBQzNDLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDO29CQUUvQixJQUFJLFNBQVMsS0FBSyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLEdBQUcsRUFBRSxVQUFVLEVBQUUsQ0FBQzt3QkFDckUsTUFBTSxPQUFPLEdBQUcsb0JBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFNLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLEtBQUssR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO3dCQUMvRSxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztvQkFDNUMsQ0FBQztvQkFFRCxJQUFJLFNBQVMsS0FBSyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLEdBQUcsRUFBRSxVQUFVLEVBQUUsQ0FBQzt3QkFDckUsTUFBTSxPQUFPLEdBQUcsb0JBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxD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QUFTO2dCQUN6QixRQUFRLEVBQUUsRUFBRTthQUNiLENBQUM7WUFDRixNQUFNLE1BQU0sR0FBMEIsTUFBTSxJQUFBLGVBQU8sRUFBQyxLQUFLLENBQUMsQ0FBQztZQUUzRCxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN0QyxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxtREFBbUQsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNuRSxNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ3BELE1BQU0sTUFBTSxHQUEwQixNQUFNLElBQUEsZUFBTyxFQUFDLEtBQUssQ0FBQyxDQUFDO1lBRTNELE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogTG9naW4gTGFtYmRhIEZ1bmN0aW9uIFRlc3RzXG4gKiBVbml0IHRlc3RzIGZvciBhdXRoZW50aWNhdGlvbiBsb2dpY1xuICovXG5cbmltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IGhhbmRsZXIgfSBmcm9tICcuLi8uLi9sYW1iZGEvYXV0aC9sb2dpbic7XG5pbXBvcnQgeyBtb2NrU3R1ZGVudHMsIG1vY2tUZWFjaGVycywgTU9DS19TVFVERU5UX1BBU1NXT1JELCBNT0NLX1RFQUNIRVJfUEFTU1dPUkQsIE1PQ0tfQURNSU5fUEFTU1dPUkQgfSBmcm9tICcuLi9tb2Nrcyc7XG5cbi8vIE1vY2sgQVdTIFNES1xuamVzdC5tb2NrKCdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInKTtcbmplc3QubW9jaygnQGF3cy1zZGsvbGliLWR5bmFtb2RiJywgKCkgPT4ge1xuICByZXR1cm4ge1xuICAgIER5bmFtb0RCRG9jdW1lbnRDbGllbnQ6IHtcbiAgICAgIGZyb206IGplc3QuZm4oKCkgPT4gKHtcbiAgICAgICAgc2VuZDogamVzdC5mbigoY29tbWFuZDogYW55KSA9PiB7XG4gICAgICAgICAgLy8gTW9jayBpbXBsZW1lbnRhdGlvbiB0byByZXR1cm4gZGF0YSBiYXNlZCBvbiBjb21tYW5kXG4gICAgICAgICAgY29uc3QgdGFibGVOYW1lID0gY29tbWFuZC5pbnB1dD8uVGFibGVOYW1lO1xuICAgICAgICAgIGNvbnN0IGtleSA9IGNvbW1hbmQuaW5wdXQ/LktleTtcbiAgICAgICAgICBcbiAgICAgICAgICBpZiAodGFibGVOYW1lID09PSBwcm9jZXNzLmVudi5TVFVERU5UU19UQUJMRV9OQU1FICYmIGtleT8uc3R1ZGVudF9pZCkge1xuICAgICAgICAgICAgY29uc3Qgc3R1ZGVudCA9IG1vY2tTdHVkZW50cy5maW5kKChzOiBhbnkpID0+IHMuc3R1ZGVudF9pZCA9PT0ga2V5LnN0dWRlbnRfaWQpO1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IEl0ZW06IHN0dWRlbnQgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIFxuICAgICAgICAgIGlmICh0YWJsZU5hbWUgPT09IHByb2Nlc3MuZW52LlRFQUNIRVJTX1RBQkxFX05BTUUgJiYga2V5Py50ZWFjaGVyX2lkKSB7XG4gICAgICAgICAgICBjb25zdCB0ZWFjaGVyID0gbW9ja1RlYWNoZXJzLmZpbmQoKHQ6IGFueSkgPT4gdC50ZWFjaGVyX2lkID09PSBrZXkudGVhY2hlcl9pZCk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgSXRlbTogdGVhY2hlciB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgXG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IEl0ZW06IHVuZGVmaW5lZCB9KTtcbiAgICAgICAgfSksXG4gICAgICB9KSksXG4gICAgfSxcbiAgICBHZXRDb21tYW5kOiBqZXN0LmZuKChpbnB1dDogYW55KSA9PiAoeyBpbnB1dCB9KSksXG4gIH07XG59KTtcblxuLy8gU2V0IGVudmlyb25tZW50IHZhcmlhYmxlc1xucHJvY2Vzcy5lbnYuU1RVREVOVFNfVEFCTEVfTkFNRSA9ICdoby15dS1zdHVkZW50cyc7XG5wcm9jZXNzLmVudi5URUFDSEVSU19UQUJMRV9OQU1FID0gJ2hvLXl1LXRlYWNoZXJzJztcblxuZGVzY3JpYmUoJ0xvZ2luIExhbWJkYSBIYW5kbGVyJywgKCkgPT4ge1xuICBjb25zdCBjcmVhdGVFdmVudCA9IChib2R5OiBhbnkpOiBBUElHYXRld2F5UHJveHlFdmVudCA9PiAoe1xuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KGJvZHkpLFxuICAgIGhlYWRlcnM6IHt9LFxuICAgIG11bHRpVmFsdWVIZWFkZXJzOiB7fSxcbiAgICBodHRwTWV0aG9kOiAnUE9TVCcsXG4gICAgaXNCYXNlNjRFbmNvZGVkOiBmYWxzZSxcbiAgICBwYXRoOiAnL2F1dGgvbG9naW4nLFxuICAgIHBhdGhQYXJhbWV0ZXJzOiBudWxsLFxuICAgIHF1ZXJ5U3RyaW5nUGFyYW1ldGVyczogbnVsbCxcbiAgICBtdWx0aVZhbHVlUXVlcnlTdHJpbmdQYXJhbWV0ZXJzOiBudWxsLFxuICAgIHN0YWdlVmFyaWFibGVzOiBudWxsLFxuICAgIHJlcXVlc3RDb250ZXh0OiB7fSBhcyBhbnksXG4gICAgcmVzb3VyY2U6ICcnLFxuICB9KTtcblxuICBkZXNjcmliZSgnSW5wdXQgVmFsaWRhdGlvbicsICgpID0+IHtcbiAgICB0ZXN0KCdzaG91bGQgcmV0dXJuIDQwMCBpZiBpZCBpcyBtaXNzaW5nJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudCh7IHBhc3N3b3JkOiAndGVzdDEyMycgfSk7XG4gICAgICBjb25zdCByZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoNDAwKTtcbiAgICAgIGV4cGVjdChKU09OLnBhcnNlKHJlc3VsdC5ib2R5KSkudG9FcXVhbCh7IG1lc3NhZ2U6ICdNaXNzaW5nIGlkIG9yIHBhc3N3b3JkJyB9KTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Nob3VsZCByZXR1cm4gNDAwIGlmIHBhc3N3b3JkIGlzIG1pc3NpbmcnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHsgaWQ6ICdTVFUwMDEnIH0pO1xuICAgICAgY29uc3QgcmVzdWx0OiBBUElHYXRld2F5UHJveHlSZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDQwMCk7XG4gICAgICBleHBlY3QoSlNPTi5wYXJzZShyZXN1bHQuYm9keSkpLnRvRXF1YWwoeyBtZXNzYWdlOiAnTWlzc2luZyBpZCBvciBwYXNzd29yZCcgfSk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdzaG91bGQgcmV0dXJuIDQwMCBpZiBib3RoIGlkIGFuZCBwYXNzd29yZCBhcmUgbWlzc2luZycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoe30pO1xuICAgICAgY29uc3QgcmVzdWx0OiBBUElHYXRld2F5UHJveHlSZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDQwMCk7XG4gICAgICBleHBlY3QoSlNPTi5wYXJzZShyZXN1bHQuYm9keSkpLnRvRXF1YWwoeyBtZXNzYWdlOiAnTWlzc2luZyBpZCBvciBwYXNzd29yZCcgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdTdHVkZW50IEF1dGhlbnRpY2F0aW9uJywgKCkgPT4ge1xuICAgIHRlc3QoJ3Nob3VsZCBzdWNjZXNzZnVsbHkgYXV0aGVudGljYXRlIHZhbGlkIHN0dWRlbnQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHtcbiAgICAgICAgaWQ6ICdTVFUwMDEnLFxuICAgICAgICBwYXNzd29yZDogTU9DS19TVFVERU5UX1BBU1NXT1JELFxuICAgICAgfSk7XG4gICAgICBjb25zdCByZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoMjAwKTtcbiAgICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKHJlc3VsdC5ib2R5KTtcbiAgICAgIGV4cGVjdChib2R5LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QoYm9keS5yb2xlKS50b0JlKCdzdHVkZW50Jyk7XG4gICAgICBleHBlY3QoYm9keS51c2VyKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGJvZHkudXNlci5zdHVkZW50X2lkKS50b0JlKCdTVFUwMDEnKTtcbiAgICAgIGV4cGVjdChib2R5LnVzZXIucGFzc3dvcmQpLnRvQmVVbmRlZmluZWQoKTsgLy8gUGFzc3dvcmQgc2hvdWxkIGJlIHJlbW92ZWRcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Nob3VsZCBmYWlsIGF1dGhlbnRpY2F0aW9uIHdpdGggd3JvbmcgcGFzc3dvcmQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHtcbiAgICAgICAgaWQ6ICdTVFUwMDEnLFxuICAgICAgICBwYXNzd29yZDogJ3dyb25ncGFzc3dvcmQnLFxuICAgICAgfSk7XG4gICAgICBjb25zdCByZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoNDAxKTtcbiAgICAgIGV4cGVjdChKU09OLnBhcnNlKHJlc3VsdC5ib2R5KSkudG9FcXVhbCh7IG1lc3NhZ2U6ICdJbnZhbGlkIGNyZWRlbnRpYWxzJyB9KTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Nob3VsZCBmYWlsIGF1dGhlbnRpY2F0aW9uIGZvciBub24tZXhpc3RlbnQgc3R1ZGVudCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoe1xuICAgICAgICBpZDogJ1NUVTk5OScsXG4gICAgICAgIHBhc3N3b3JkOiBNT0NLX1NUVURFTlRfUEFTU1dPUkQsXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHJlc3VsdDogQVBJR2F0ZXdheVByb3h5UmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg0MDEpO1xuICAgICAgZXhwZWN0KEpTT04ucGFyc2UocmVzdWx0LmJvZHkpKS50b0VxdWFsKHsgbWVzc2FnZTogJ0ludmFsaWQgY3JlZGVudGlhbHMnIH0pO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnc2hvdWxkIGF1dGhlbnRpY2F0ZSBtdWx0aXBsZSBzdHVkZW50cyB3aXRoIHNhbWUgcGFzc3dvcmQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBmb3IgKGNvbnN0IHN0dWRlbnQgb2YgbW9ja1N0dWRlbnRzLnNsaWNlKDAsIDMpKSB7XG4gICAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoe1xuICAgICAgICAgIGlkOiBzdHVkZW50LnN0dWRlbnRfaWQsXG4gICAgICAgICAgcGFzc3dvcmQ6IE1PQ0tfU1RVREVOVF9QQVNTV09SRCxcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IHJlc3VsdDogQVBJR2F0ZXdheVByb3h5UmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCk7XG5cbiAgICAgICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDIwMCk7XG4gICAgICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKHJlc3VsdC5ib2R5KTtcbiAgICAgICAgZXhwZWN0KGJvZHkudXNlci5zdHVkZW50X2lkKS50b0JlKHN0dWRlbnQuc3R1ZGVudF9pZCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdUZWFjaGVyIEF1dGhlbnRpY2F0aW9uJywgKCkgPT4ge1xuICAgIHRlc3QoJ3Nob3VsZCBzdWNjZXNzZnVsbHkgYXV0aGVudGljYXRlIHZhbGlkIHRlYWNoZXInLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHtcbiAgICAgICAgaWQ6ICdUQ0gwMDEnLFxuICAgICAgICBwYXNzd29yZDogTU9DS19URUFDSEVSX1BBU1NXT1JELFxuICAgICAgfSk7XG4gICAgICBjb25zdCByZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoMjAwKTtcbiAgICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKHJlc3VsdC5ib2R5KTtcbiAgICAgIGV4cGVjdChib2R5LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QoYm9keS5yb2xlKS50b0JlKCd0ZWFjaGVyJyk7XG4gICAgICBleHBlY3QoYm9keS51c2VyKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGJvZHkudXNlci50ZWFjaGVyX2lkKS50b0JlKCdUQ0gwMDEnKTtcbiAgICAgIGV4cGVjdChib2R5LnVzZXIucGFzc3dvcmQpLnRvQmVVbmRlZmluZWQoKTsgLy8gUGFzc3dvcmQgc2hvdWxkIGJlIHJlbW92ZWRcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Nob3VsZCBmYWlsIGF1dGhlbnRpY2F0aW9uIHdpdGggd3JvbmcgcGFzc3dvcmQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHtcbiAgICAgICAgaWQ6ICdUQ0gwMDEnLFxuICAgICAgICBwYXNzd29yZDogJ3dyb25ncGFzc3dvcmQnLFxuICAgICAgfSk7XG4gICAgICBjb25zdCByZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoNDAxKTtcbiAgICAgIGV4cGVjdChKU09OLnBhcnNlKHJlc3VsdC5ib2R5KSkudG9FcXVhbCh7IG1lc3NhZ2U6ICdJbnZhbGlkIGNyZWRlbnRpYWxzJyB9KTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Nob3VsZCBmYWlsIGF1dGhlbnRpY2F0aW9uIGZvciBub24tZXhpc3RlbnQgdGVhY2hlcicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoe1xuICAgICAgICBpZDogJ1RDSDk5OScsXG4gICAgICAgIHBhc3N3b3JkOiBNT0NLX1RFQUNIRVJfUEFTU1dPUkQsXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHJlc3VsdDogQVBJR2F0ZXdheVByb3h5UmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg0MDEpO1xuICAgICAgZXhwZWN0KEpTT04ucGFyc2UocmVzdWx0LmJvZHkpKS50b0VxdWFsKHsgbWVzc2FnZTogJ0ludmFsaWQgY3JlZGVudGlhbHMnIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnQWRtaW4gQXV0aGVudGljYXRpb24nLCAoKSA9PiB7XG4gICAgdGVzdCgnc2hvdWxkIHN1Y2Nlc3NmdWxseSBhdXRoZW50aWNhdGUgYWRtaW4gYW5kIHJldHVybiBhZG1pbiByb2xlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudCh7XG4gICAgICAgIGlkOiAnVENIMDAzJyxcbiAgICAgICAgcGFzc3dvcmQ6IE1PQ0tfQURNSU5fUEFTU1dPUkQsXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHJlc3VsdDogQVBJR2F0ZXdheVByb3h5UmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSgyMDApO1xuICAgICAgY29uc3QgYm9keSA9IEpTT04ucGFyc2UocmVzdWx0LmJvZHkpO1xuICAgICAgZXhwZWN0KGJvZHkuc3VjY2VzcykudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChib2R5LnJvbGUpLnRvQmUoJ2FkbWluJyk7XG4gICAgICBleHBlY3QoYm9keS51c2VyKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGJvZHkudXNlci50ZWFjaGVyX2lkKS50b0JlKCdUQ0gwMDMnKTtcbiAgICAgIGV4cGVjdChib2R5LnVzZXIuaXNfYWRtaW4pLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QoYm9keS51c2VyLnBhc3N3b3JkKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdzaG91bGQgbm90IGF1dGhlbnRpY2F0ZSBhZG1pbiB3aXRoIHRlYWNoZXIgcGFzc3dvcmQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHtcbiAgICAgICAgaWQ6ICdUQ0gwMDMnLFxuICAgICAgICBwYXNzd29yZDogTU9DS19URUFDSEVSX1BBU1NXT1JELFxuICAgICAgfSk7XG4gICAgICBjb25zdCByZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoNDAxKTtcbiAgICAgIGV4cGVjdChKU09OLnBhcnNlKHJlc3VsdC5ib2R5KSkudG9FcXVhbCh7IG1lc3NhZ2U6ICdJbnZhbGlkIGNyZWRlbnRpYWxzJyB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1Jlc3BvbnNlIEhlYWRlcnMnLCAoKSA9PiB7XG4gICAgdGVzdCgnc2hvdWxkIGluY2x1ZGUgQ09SUyBoZWFkZXJzIGluIHN1Y2Nlc3NmdWwgcmVzcG9uc2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHtcbiAgICAgICAgaWQ6ICdTVFUwMDEnLFxuICAgICAgICBwYXNzd29yZDogTU9DS19TVFVERU5UX1BBU1NXT1JELFxuICAgICAgfSk7XG4gICAgICBjb25zdCByZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LmhlYWRlcnMpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocmVzdWx0LmhlYWRlcnMhWydDb250ZW50LVR5cGUnXSkudG9CZSgnYXBwbGljYXRpb24vanNvbicpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5oZWFkZXJzIVsnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJ10pLnRvQmUoJyonKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Nob3VsZCBpbmNsdWRlIENPUlMgaGVhZGVycyBpbiBlcnJvciByZXNwb25zZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoe1xuICAgICAgICBpZDogJ1NUVTAwMScsXG4gICAgICAgIHBhc3N3b3JkOiAnd3JvbmdwYXNzd29yZCcsXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHJlc3VsdDogQVBJR2F0ZXdheVByb3h5UmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuaGVhZGVycykudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuaGVhZGVycyFbJ0NvbnRlbnQtVHlwZSddKS50b0JlKCdhcHBsaWNhdGlvbi9qc29uJyk7XG4gICAgICBleHBlY3QocmVzdWx0LmhlYWRlcnMhWydBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nXSkudG9CZSgnKicpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnU2VjdXJpdHknLCAoKSA9PiB7XG4gICAgdGVzdCgnc2hvdWxkIG5vdCByZXR1cm4gcGFzc3dvcmQgaW4gc3VjY2Vzc2Z1bCByZXNwb25zZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoe1xuICAgICAgICBpZDogJ1NUVTAwMScsXG4gICAgICAgIHBhc3N3b3JkOiBNT0NLX1NUVURFTlRfUEFTU1dPUkQsXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHJlc3VsdDogQVBJR2F0ZXdheVByb3h5UmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCk7XG5cbiAgICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKHJlc3VsdC5ib2R5KTtcbiAgICAgIGV4cGVjdChib2R5LnVzZXIucGFzc3dvcmQpLnRvQmVVbmRlZmluZWQoKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Nob3VsZCBub3QgcmV0dXJuIHBhc3N3b3JkIGhhc2ggaW4gcmVzcG9uc2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHtcbiAgICAgICAgaWQ6ICdTVFUwMDEnLFxuICAgICAgICBwYXNzd29yZDogTU9DS19TVFVERU5UX1BBU1NXT1JELFxuICAgICAgfSk7XG4gICAgICBjb25zdCByZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuXG4gICAgICBjb25zdCByZXNwb25zZVN0ciA9IHJlc3VsdC5ib2R5O1xuICAgICAgLy8gRW5zdXJlIG5vIFNIQS0yNTYgaGFzaCAoNjQgaGV4IGNoYXJzKSBpcyBpbiByZXNwb25zZVxuICAgICAgZXhwZWN0KHJlc3BvbnNlU3RyKS5ub3QudG9NYXRjaCgvW2EtZjAtOV17NjR9Lyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdFZGdlIENhc2VzJywgKCkgPT4ge1xuICAgIHRlc3QoJ3Nob3VsZCBoYW5kbGUgZW1wdHkgYm9keSBncmFjZWZ1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudChudWxsKTtcbiAgICAgIGNvbnN0IHJlc3VsdDogQVBJR2F0ZXdheVByb3h5UmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg1MDApO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnc2hvdWxkIGhhbmRsZSBtYWxmb3JtZWQgSlNPTiBib2R5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50ID0ge1xuICAgICAgICBib2R5OiAnbm90IHZhbGlkIGpzb24nLFxuICAgICAgICBoZWFkZXJzOiB7fSxcbiAgICAgICAgbXVsdGlWYWx1ZUhlYWRlcnM6IHt9LFxuICAgICAgICBodHRwTWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIGlzQmFzZTY0RW5jb2RlZDogZmFsc2UsXG4gICAgICAgIHBhdGg6ICcvYXV0aC9sb2dpbicsXG4gICAgICAgIHBhdGhQYXJhbWV0ZXJzOiBudWxsLFxuICAgICAgICBxdWVyeVN0cmluZ1BhcmFtZXRlcnM6IG51bGwsXG4gICAgICAgIG11bHRpVmFsdWVRdWVyeVN0cmluZ1BhcmFtZXRlcnM6IG51bGwsXG4gICAgICAgIHN0YWdlVmFyaWFibGVzOiBudWxsLFxuICAgICAgICByZXF1ZXN0Q29udGV4dDoge30gYXMgYW55LFxuICAgICAgICByZXNvdXJjZTogJycsXG4gICAgICB9O1xuICAgICAgY29uc3QgcmVzdWx0OiBBUElHYXRld2F5UHJveHlSZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDUwMCk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdzaG91bGQgdHJlYXQgZW1wdHkgc3RyaW5ncyBhcyBtaXNzaW5nIGNyZWRlbnRpYWxzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudCh7IGlkOiAnJywgcGFzc3dvcmQ6ICcnIH0pO1xuICAgICAgY29uc3QgcmVzdWx0OiBBUElHYXRld2F5UHJveHlSZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDQwMCk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=