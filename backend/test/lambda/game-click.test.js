"use strict";
/**
 * Game Click Lambda Function Tests
 * Unit tests for game click increment logic
 */
Object.defineProperty(exports, "__esModule", { value: true });
const click_1 = require("../../lambda/games/click");
const mocks_1 = require("../mocks");
// Store click counts in memory for testing - outside the mock to share across tests
const clickCounts = new Map();
// Mock AWS SDK
jest.mock('@aws-sdk/client-dynamodb');
jest.mock('@aws-sdk/lib-dynamodb', () => {
    return {
        DynamoDBDocumentClient: {
            from: jest.fn(() => ({
                send: jest.fn((command) => {
                    const { mockGames } = require('../mocks');
                    // Handle GetCommand - check if game exists
                    if (command.input?.TableName && command.input?.Key?.game_id) {
                        const gameId = command.input.Key.game_id;
                        const game = mockGames.find((g) => g.game_id === gameId);
                        // If UpdateExpression is present, it's an UpdateCommand
                        if (command.input.UpdateExpression) {
                            if (!game) {
                                return Promise.resolve({ Attributes: undefined });
                            }
                            // Simulate atomic ADD operation
                            const currentCount = clickCounts.get(gameId) || game.accumulated_click;
                            const newCount = currentCount + 1;
                            clickCounts.set(gameId, newCount);
                            return Promise.resolve({
                                Attributes: {
                                    ...game,
                                    accumulated_click: newCount,
                                },
                            });
                        }
                        // It's a GetCommand
                        return Promise.resolve({ Item: game });
                    }
                    return Promise.resolve({ Item: undefined });
                }),
            })),
        },
        GetCommand: jest.fn((input) => ({ input })),
        UpdateCommand: jest.fn((input) => ({ input })),
    };
});
// Set environment variables
process.env.GAMES_TABLE_NAME = 'ho-yu-games';
describe('Game Click Lambda Handler', () => {
    // Reset click counts before each test
    beforeEach(() => {
        clickCounts.clear();
        // Initialize with mock data
        mocks_1.mockGames.forEach((game) => {
            clickCounts.set(game.game_id, game.accumulated_click);
        });
    });
    const createEvent = (gameId) => ({
        body: null,
        headers: {},
        multiValueHeaders: {},
        httpMethod: 'POST',
        isBase64Encoded: false,
        path: `/games/${gameId}/click`,
        pathParameters: gameId ? { gameId } : null,
        queryStringParameters: null,
        multiValueQueryStringParameters: null,
        stageVariables: null,
        requestContext: {},
        resource: '',
    });
    describe('Input Validation', () => {
        test('should return 400 if gameId is missing', async () => {
            const event = createEvent(null);
            const result = await (0, click_1.handler)(event);
            expect(result.statusCode).toBe(400);
            expect(JSON.parse(result.body)).toEqual({ message: 'Missing gameId parameter' });
        });
    });
    describe('Game Existence Check', () => {
        test('should return 404 if game does not exist', async () => {
            const event = createEvent('nonexistent-game-id');
            const result = await (0, click_1.handler)(event);
            expect(result.statusCode).toBe(404);
            expect(JSON.parse(result.body)).toEqual({ message: 'Game not found' });
        });
    });
    describe('Click Increment', () => {
        test('should successfully increment click count for existing game', async () => {
            const game = mocks_1.mockGames[0];
            const event = createEvent(game.game_id);
            const result = await (0, click_1.handler)(event);
            expect(result.statusCode).toBe(200);
            const body = JSON.parse(result.body);
            expect(body.success).toBe(true);
            expect(body.accumulated_click).toBe(game.accumulated_click + 1);
        });
        test('should increment click count multiple times', async () => {
            const game = mocks_1.mockGames[1];
            const initialCount = game.accumulated_click;
            // First increment
            let event = createEvent(game.game_id);
            let result = await (0, click_1.handler)(event);
            let body = JSON.parse(result.body);
            expect(body.accumulated_click).toBe(initialCount + 1);
            // Second increment
            event = createEvent(game.game_id);
            result = await (0, click_1.handler)(event);
            body = JSON.parse(result.body);
            expect(body.accumulated_click).toBe(initialCount + 2);
            // Third increment
            event = createEvent(game.game_id);
            result = await (0, click_1.handler)(event);
            body = JSON.parse(result.body);
            expect(body.accumulated_click).toBe(initialCount + 3);
        });
        test('should work for different games independently', async () => {
            const game1 = mocks_1.mockGames[0];
            const game2 = mocks_1.mockGames[1];
            const initialCount1 = game1.accumulated_click;
            const initialCount2 = game2.accumulated_click;
            // Increment game 1
            let event = createEvent(game1.game_id);
            let result = await (0, click_1.handler)(event);
            let body = JSON.parse(result.body);
            expect(body.accumulated_click).toBe(initialCount1 + 1);
            // Increment game 2
            event = createEvent(game2.game_id);
            result = await (0, click_1.handler)(event);
            body = JSON.parse(result.body);
            expect(body.accumulated_click).toBe(initialCount2 + 1);
            // Increment game 1 again - should be independent
            event = createEvent(game1.game_id);
            result = await (0, click_1.handler)(event);
            body = JSON.parse(result.body);
            expect(body.accumulated_click).toBe(initialCount1 + 2);
        });
        test('should work with all mock games', async () => {
            // Test a few random games to ensure it works across the board
            const testGames = [mocks_1.mockGames[2], mocks_1.mockGames[5], mocks_1.mockGames[10], mocks_1.mockGames[15]];
            for (const game of testGames) {
                const event = createEvent(game.game_id);
                const result = await (0, click_1.handler)(event);
                expect(result.statusCode).toBe(200);
                const body = JSON.parse(result.body);
                expect(body.success).toBe(true);
                expect(body.accumulated_click).toBeGreaterThan(game.accumulated_click);
            }
        });
    });
    describe('Response Headers', () => {
        test('should include CORS headers in successful response', async () => {
            const game = mocks_1.mockGames[0];
            const event = createEvent(game.game_id);
            const result = await (0, click_1.handler)(event);
            expect(result.headers).toBeDefined();
            expect(result.headers['Content-Type']).toBe('application/json');
            expect(result.headers['Access-Control-Allow-Origin']).toBe('*');
        });
        test('should include CORS headers in error response', async () => {
            const event = createEvent('nonexistent-game');
            const result = await (0, click_1.handler)(event);
            expect(result.headers).toBeDefined();
            expect(result.headers['Content-Type']).toBe('application/json');
            expect(result.headers['Access-Control-Allow-Origin']).toBe('*');
        });
    });
    describe('Concurrent Clicks Simulation', () => {
        test('should handle rapid sequential clicks correctly', async () => {
            const game = mocks_1.mockGames[3];
            const initialCount = game.accumulated_click;
            const numClicks = 10;
            // Simulate rapid clicks
            for (let i = 0; i < numClicks; i++) {
                const event = createEvent(game.game_id);
                const result = await (0, click_1.handler)(event);
                expect(result.statusCode).toBe(200);
            }
            // Verify final count
            const event = createEvent(game.game_id);
            const result = await (0, click_1.handler)(event);
            const body = JSON.parse(result.body);
            // Should have incremented by numClicks + 1 (for the final verification call)
            expect(body.accumulated_click).toBe(initialCount + numClicks + 1);
        });
    });
    describe('Response Format', () => {
        test('should return success flag and click count', async () => {
            const game = mocks_1.mockGames[0];
            const event = createEvent(game.game_id);
            const result = await (0, click_1.handler)(event);
            const body = JSON.parse(result.body);
            expect(body).toHaveProperty('success');
            expect(body).toHaveProperty('accumulated_click');
            expect(typeof body.success).toBe('boolean');
            expect(typeof body.accumulated_click).toBe('number');
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2FtZS1jbGljay50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZ2FtZS1jbGljay50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7O0FBR0gsb0RBQW1EO0FBQ25ELG9DQUFxQztBQUVyQyxvRkFBb0Y7QUFDcEYsTUFBTSxXQUFXLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUM7QUFFOUMsZUFBZTtBQUNmLElBQUksQ0FBQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsQ0FBQztBQUN0QyxJQUFJLENBQUMsSUFBSSxDQUFDLHVCQUF1QixFQUFFLEdBQUcsRUFBRTtJQUN0QyxPQUFPO1FBQ0wsc0JBQXNCLEVBQUU7WUFDdEIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDbkIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxPQUFZLEVBQUUsRUFBRTtvQkFDN0IsTUFBTSxFQUFFLFNBQVMsRUFBRSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztvQkFFMUMsMkNBQTJDO29CQUMzQyxJQUFJLE9BQU8sQ0FBQyxLQUFLLEVBQUUsU0FBUyxJQUFJLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxDQUFDO3dCQUM1RCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUM7d0JBQ3pDLE1BQU0sSUFBSSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFNLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLEtBQUssTUFBTSxDQUFDLENBQUM7d0JBRTlELHdEQUF3RDt3QkFDeEQsSUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDLGdCQUFnQixFQUFFLENBQUM7NEJBQ25DLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQ0FDVixPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFB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QixFQUFFLEdBQUcsRUFBRTtRQUMvQixJQUFJLENBQUMsNENBQTRDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDNUQsTUFBTSxJQUFJLEdBQUcsaUJBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMxQixNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3hDLE1BQU0sTUFBTSxHQUEwQixNQUFNLElBQUEsZUFBTyxFQUFDLEtBQUssQ0FBQyxDQUFDO1lBRTNELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3JDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDdkMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1lBQ2pELE1BQU0sQ0FBQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDNUMsTUFBTSxDQUFDLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogR2FtZSBDbGljayBMYW1iZGEgRnVuY3Rpb24gVGVzdHNcbiAqIFVuaXQgdGVzdHMgZm9yIGdhbWUgY2xpY2sgaW5jcmVtZW50IGxvZ2ljXG4gKi9cblxuaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgaGFuZGxlciB9IGZyb20gJy4uLy4uL2xhbWJkYS9nYW1lcy9jbGljayc7XG5pbXBvcnQgeyBtb2NrR2FtZXMgfSBmcm9tICcuLi9tb2Nrcyc7XG5cbi8vIFN0b3JlIGNsaWNrIGNvdW50cyBpbiBtZW1vcnkgZm9yIHRlc3RpbmcgLSBvdXRzaWRlIHRoZSBtb2NrIHRvIHNoYXJlIGFjcm9zcyB0ZXN0c1xuY29uc3QgY2xpY2tDb3VudHMgPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyPigpO1xuXG4vLyBNb2NrIEFXUyBTREtcbmplc3QubW9jaygnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJyk7XG5qZXN0Lm1vY2soJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYicsICgpID0+IHtcbiAgcmV0dXJuIHtcbiAgICBEeW5hbW9EQkRvY3VtZW50Q2xpZW50OiB7XG4gICAgICBmcm9tOiBqZXN0LmZuKCgpID0+ICh7XG4gICAgICAgIHNlbmQ6IGplc3QuZm4oKGNvbW1hbmQ6IGFueSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHsgbW9ja0dhbWVzIH0gPSByZXF1aXJlKCcuLi9tb2NrcycpO1xuICAgICAgICAgIFxuICAgICAgICAgIC8vIEhhbmRsZSBHZXRDb21tYW5kIC0gY2hlY2sgaWYgZ2FtZSBleGlzdHNcbiAgICAgICAgICBpZiAoY29tbWFuZC5pbnB1dD8uVGFibGVOYW1lICYmIGNvbW1hbmQuaW5wdXQ/LktleT8uZ2FtZV9pZCkge1xuICAgICAgICAgICAgY29uc3QgZ2FtZUlkID0gY29tbWFuZC5pbnB1dC5LZXkuZ2FtZV9pZDtcbiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSBtb2NrR2FtZXMuZmluZCgoZzogYW55KSA9PiBnLmdhbWVfaWQgPT09IGdhbWVJZCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIElmIFVwZGF0ZUV4cHJlc3Npb24gaXMgcHJlc2VudCwgaXQncyBhbiBVcGRhdGVDb21tYW5kXG4gICAgICAgICAgICBpZiAoY29tbWFuZC5pbnB1dC5VcGRhdGVFeHByZXNzaW9uKSB7XG4gICAgICAgICAgICAgIGlmICghZ2FtZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBBdHRyaWJ1dGVzOiB1bmRlZmluZWQgfSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgIC8vIFNpbXVsYXRlIGF0b21pYyBBREQgb3BlcmF0aW9uXG4gICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRDb3VudCA9IGNsaWNrQ291bnRzLmdldChnYW1lSWQpIHx8IGdhbWUuYWNjdW11bGF0ZWRfY2xpY2s7XG4gICAgICAgICAgICAgIGNvbnN0IG5ld0NvdW50ID0gY3VycmVudENvdW50ICsgMTtcbiAgICAgICAgICAgICAgY2xpY2tDb3VudHMuc2V0KGdhbWVJZCwgbmV3Q291bnQpO1xuICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgICAgICAgICAgQXR0cmlidXRlczoge1xuICAgICAgICAgICAgICAgICAgLi4uZ2FtZSxcbiAgICAgICAgICAgICAgICAgIGFjY3VtdWxhdGVkX2NsaWNrOiBuZXdDb3VudCxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gSXQncyBhIEdldENvbW1hbmRcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBJdGVtOiBnYW1lIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgSXRlbTogdW5kZWZpbmVkIH0pO1xuICAgICAgICB9KSxcbiAgICAgIH0pKSxcbiAgICB9LFxuICAgIEdldENvbW1hbmQ6IGplc3QuZm4oKGlucHV0OiBhbnkpID0+ICh7IGlucHV0IH0pKSxcbiAgICBVcGRhdGVDb21tYW5kOiBqZXN0LmZuKChpbnB1dDogYW55KSA9PiAoeyBpbnB1dCB9KSksXG4gIH07XG59KTtcblxuLy8gU2V0IGVudmlyb25tZW50IHZhcmlhYmxlc1xucHJvY2Vzcy5lbnYuR0FNRVNfVEFCTEVfTkFNRSA9ICdoby15dS1nYW1lcyc7XG5cbmRlc2NyaWJlKCdHYW1lIENsaWNrIExhbWJkYSBIYW5kbGVyJywgKCkgPT4ge1xuICAvLyBSZXNldCBjbGljayBjb3VudHMgYmVmb3JlIGVhY2ggdGVzdFxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBjbGlja0NvdW50cy5jbGVhcigpO1xuICAgIC8vIEluaXRpYWxpemUgd2l0aCBtb2NrIGRhdGFcbiAgICBtb2NrR2FtZXMuZm9yRWFjaCgoZ2FtZTogYW55KSA9PiB7XG4gICAgICBjbGlja0NvdW50cy5zZXQoZ2FtZS5nYW1lX2lkLCBnYW1lLmFjY3VtdWxhdGVkX2NsaWNrKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgY29uc3QgY3JlYXRlRXZlbnQgPSAoZ2FtZUlkOiBzdHJpbmcgfCBudWxsKTogQVBJR2F0ZXdheVByb3h5RXZlbnQgPT4gKHtcbiAgICBib2R5OiBudWxsLFxuICAgIGhlYWRlcnM6IHt9LFxuICAgIG11bHRpVmFsdWVIZWFkZXJzOiB7fSxcbiAgICBodHRwTWV0aG9kOiAnUE9TVCcsXG4gICAgaXNCYXNlNjRFbmNvZGVkOiBmYWxzZSxcbiAgICBwYXRoOiBgL2dhbWVzLyR7Z2FtZUlkfS9jbGlja2AsXG4gICAgcGF0aFBhcmFtZXRlcnM6IGdhbWVJZCA/IHsgZ2FtZUlkIH0gOiBudWxsLFxuICAgIHF1ZXJ5U3RyaW5nUGFyYW1ldGVyczogbnVsbCxcbiAgICBtdWx0aVZhbHVlUXVlcnlTdHJpbmdQYXJhbWV0ZXJzOiBudWxsLFxuICAgIHN0YWdlVmFyaWFibGVzOiBudWxsLFxuICAgIHJlcXVlc3RDb250ZXh0OiB7fSBhcyBhbnksXG4gICAgcmVzb3VyY2U6ICcnLFxuICB9KTtcblxuICBkZXNjcmliZSgnSW5wdXQgVmFsaWRhdGlvbicsICgpID0+IHtcbiAgICB0ZXN0KCdzaG91bGQgcmV0dXJuIDQwMCBpZiBnYW1lSWQgaXMgbWlzc2luZycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQobnVsbCk7XG4gICAgICBjb25zdCByZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoNDAwKTtcbiAgICAgIGV4cGVjdChKU09OLnBhcnNlKHJlc3VsdC5ib2R5KSkudG9FcXVhbCh7IG1lc3NhZ2U6ICdNaXNzaW5nIGdhbWVJZCBwYXJhbWV0ZXInIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnR2FtZSBFeGlzdGVuY2UgQ2hlY2snLCAoKSA9PiB7XG4gICAgdGVzdCgnc2hvdWxkIHJldHVybiA0MDQgaWYgZ2FtZSBkb2VzIG5vdCBleGlzdCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoJ25vbmV4aXN0ZW50LWdhbWUtaWQnKTtcbiAgICAgIGNvbnN0IHJlc3VsdDogQVBJR2F0ZXdheVByb3h5UmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg0MDQpO1xuICAgICAgZXhwZWN0KEpTT04ucGFyc2UocmVzdWx0LmJvZHkpKS50b0VxdWFsKHsgbWVzc2FnZTogJ0dhbWUgbm90IGZvdW5kJyB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0NsaWNrIEluY3JlbWVudCcsICgpID0+IHtcbiAgICB0ZXN0KCdzaG91bGQgc3VjY2Vzc2Z1bGx5IGluY3JlbWVudCBjbGljayBjb3VudCBmb3IgZXhpc3RpbmcgZ2FtZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGdhbWUgPSBtb2NrR2FtZXNbMF07XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KGdhbWUuZ2FtZV9pZCk7XG4gICAgICBjb25zdCByZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoMjAwKTtcbiAgICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKHJlc3VsdC5ib2R5KTtcbiAgICAgIGV4cGVjdChib2R5LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QoYm9keS5hY2N1bXVsYXRlZF9jbGljaykudG9CZShnYW1lLmFjY3VtdWxhdGVkX2NsaWNrICsgMSk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdzaG91bGQgaW5jcmVtZW50IGNsaWNrIGNvdW50IG11bHRpcGxlIHRpbWVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZ2FtZSA9IG1vY2tHYW1lc1sxXTtcbiAgICAgIGNvbnN0IGluaXRpYWxDb3VudCA9IGdhbWUuYWNjdW11bGF0ZWRfY2xpY2s7XG4gICAgICBcbiAgICAgIC8vIEZpcnN0IGluY3JlbWVudFxuICAgICAgbGV0IGV2ZW50ID0gY3JlYXRlRXZlbnQoZ2FtZS5nYW1lX2lkKTtcbiAgICAgIGxldCByZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuICAgICAgbGV0IGJvZHkgPSBKU09OLnBhcnNlKHJlc3VsdC5ib2R5KTtcbiAgICAgIGV4cGVjdChib2R5LmFjY3VtdWxhdGVkX2NsaWNrKS50b0JlKGluaXRpYWxDb3VudCArIDEpO1xuXG4gICAgICAvLyBTZWNvbmQgaW5jcmVtZW50XG4gICAgICBldmVudCA9IGNyZWF0ZUV2ZW50KGdhbWUuZ2FtZV9pZCk7XG4gICAgICByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KTtcbiAgICAgIGJvZHkgPSBKU09OLnBhcnNlKHJlc3VsdC5ib2R5KTtcbiAgICAgIGV4cGVjdChib2R5LmFjY3VtdWxhdGVkX2NsaWNrKS50b0JlKGluaXRpYWxDb3VudCArIDIpO1xuXG4gICAgICAvLyBUaGlyZCBpbmNyZW1lbnRcbiAgICAgIGV2ZW50ID0gY3JlYXRlRXZlbnQoZ2FtZS5nYW1lX2lkKTtcbiAgICAgIHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuICAgICAgYm9keSA9IEpTT04ucGFyc2UocmVzdWx0LmJvZHkpO1xuICAgICAgZXhwZWN0KGJvZHkuYWNjdW11bGF0ZWRfY2xpY2spLnRvQmUoaW5pdGlhbENvdW50ICsgMyk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdzaG91bGQgd29yayBmb3IgZGlmZmVyZW50IGdhbWVzIGluZGVwZW5kZW50bHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBnYW1lMSA9IG1vY2tHYW1lc1swXTtcbiAgICAgIGNvbnN0IGdhbWUyID0gbW9ja0dhbWVzWzFdO1xuICAgICAgY29uc3QgaW5pdGlhbENvdW50MSA9IGdhbWUxLmFjY3VtdWxhdGVkX2NsaWNrO1xuICAgICAgY29uc3QgaW5pdGlhbENvdW50MiA9IGdhbWUyLmFjY3VtdWxhdGVkX2NsaWNrO1xuXG4gICAgICAvLyBJbmNyZW1lbnQgZ2FtZSAxXG4gICAgICBsZXQgZXZlbnQgPSBjcmVhdGVFdmVudChnYW1lMS5nYW1lX2lkKTtcbiAgICAgIGxldCByZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuICAgICAgbGV0IGJvZHkgPSBKU09OLnBhcnNlKHJlc3VsdC5ib2R5KTtcbiAgICAgIGV4cGVjdChib2R5LmFjY3VtdWxhdGVkX2NsaWNrKS50b0JlKGluaXRpYWxDb3VudDEgKyAxKTtcblxuICAgICAgLy8gSW5jcmVtZW50IGdhbWUgMlxuICAgICAgZXZlbnQgPSBjcmVhdGVFdmVudChnYW1lMi5nYW1lX2lkKTtcbiAgICAgIHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuICAgICAgYm9keSA9IEpTT04ucGFyc2UocmVzdWx0LmJvZHkpO1xuICAgICAgZXhwZWN0KGJvZHkuYWNjdW11bGF0ZWRfY2xpY2spLnRvQmUoaW5pdGlhbENvdW50MiArIDEpO1xuXG4gICAgICAvLyBJbmNyZW1lbnQgZ2FtZSAxIGFnYWluIC0gc2hvdWxkIGJlIGluZGVwZW5kZW50XG4gICAgICBldmVudCA9IGNyZWF0ZUV2ZW50KGdhbWUxLmdhbWVfaWQpO1xuICAgICAgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCk7XG4gICAgICBib2R5ID0gSlNPTi5wYXJzZShyZXN1bHQuYm9keSk7XG4gICAgICBleHBlY3QoYm9keS5hY2N1bXVsYXRlZF9jbGljaykudG9CZShpbml0aWFsQ291bnQxICsgMik7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdzaG91bGQgd29yayB3aXRoIGFsbCBtb2NrIGdhbWVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gVGVzdCBhIGZldyByYW5kb20gZ2FtZXMgdG8gZW5zdXJlIGl0IHdvcmtzIGFjcm9zcyB0aGUgYm9hcmRcbiAgICAgIGNvbnN0IHRlc3RHYW1lcyA9IFttb2NrR2FtZXNbMl0sIG1vY2tHYW1lc1s1XSwgbW9ja0dhbWVzWzEwXSwgbW9ja0dhbWVzWzE1XV07XG4gICAgICBcbiAgICAgIGZvciAoY29uc3QgZ2FtZSBvZiB0ZXN0R2FtZXMpIHtcbiAgICAgICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudChnYW1lLmdhbWVfaWQpO1xuICAgICAgICBjb25zdCByZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuICAgICAgICBcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDIwMCk7XG4gICAgICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKHJlc3VsdC5ib2R5KTtcbiAgICAgICAgZXhwZWN0KGJvZHkuc3VjY2VzcykudG9CZSh0cnVlKTtcbiAgICAgICAgZXhwZWN0KGJvZHkuYWNjdW11bGF0ZWRfY2xpY2spLnRvQmVHcmVhdGVyVGhhbihnYW1lLmFjY3VtdWxhdGVkX2NsaWNrKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1Jlc3BvbnNlIEhlYWRlcnMnLCAoKSA9PiB7XG4gICAgdGVzdCgnc2hvdWxkIGluY2x1ZGUgQ09SUyBoZWFkZXJzIGluIHN1Y2Nlc3NmdWwgcmVzcG9uc2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBnYW1lID0gbW9ja0dhbWVzWzBdO1xuICAgICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudChnYW1lLmdhbWVfaWQpO1xuICAgICAgY29uc3QgcmVzdWx0OiBBUElHYXRld2F5UHJveHlSZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5oZWFkZXJzKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5oZWFkZXJzIVsnQ29udGVudC1UeXBlJ10pLnRvQmUoJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuaGVhZGVycyFbJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbiddKS50b0JlKCcqJyk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdzaG91bGQgaW5jbHVkZSBDT1JTIGhlYWRlcnMgaW4gZXJyb3IgcmVzcG9uc2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KCdub25leGlzdGVudC1nYW1lJyk7XG4gICAgICBjb25zdCByZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LmhlYWRlcnMpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocmVzdWx0LmhlYWRlcnMhWydDb250ZW50LVR5cGUnXSkudG9CZSgnYXBwbGljYXRpb24vanNvbicpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5oZWFkZXJzIVsnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJ10pLnRvQmUoJyonKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0NvbmN1cnJlbnQgQ2xpY2tzIFNpbXVsYXRpb24nLCAoKSA9PiB7XG4gICAgdGVzdCgnc2hvdWxkIGhhbmRsZSByYXBpZCBzZXF1ZW50aWFsIGNsaWNrcyBjb3JyZWN0bHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBnYW1lID0gbW9ja0dhbWVzWzNdO1xuICAgICAgY29uc3QgaW5pdGlhbENvdW50ID0gZ2FtZS5hY2N1bXVsYXRlZF9jbGljaztcbiAgICAgIGNvbnN0IG51bUNsaWNrcyA9IDEwO1xuXG4gICAgICAvLyBTaW11bGF0ZSByYXBpZCBjbGlja3NcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtQ2xpY2tzOyBpKyspIHtcbiAgICAgICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudChnYW1lLmdhbWVfaWQpO1xuICAgICAgICBjb25zdCByZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuICAgICAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoMjAwKTtcbiAgICAgIH1cblxuICAgICAgLy8gVmVyaWZ5IGZpbmFsIGNvdW50XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KGdhbWUuZ2FtZV9pZCk7XG4gICAgICBjb25zdCByZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuICAgICAgY29uc3QgYm9keSA9IEpTT04ucGFyc2UocmVzdWx0LmJvZHkpO1xuICAgICAgXG4gICAgICAvLyBTaG91bGQgaGF2ZSBpbmNyZW1lbnRlZCBieSBudW1DbGlja3MgKyAxIChmb3IgdGhlIGZpbmFsIHZlcmlmaWNhdGlvbiBjYWxsKVxuICAgICAgZXhwZWN0KGJvZHkuYWNjdW11bGF0ZWRfY2xpY2spLnRvQmUoaW5pdGlhbENvdW50ICsgbnVtQ2xpY2tzICsgMSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdSZXNwb25zZSBGb3JtYXQnLCAoKSA9PiB7XG4gICAgdGVzdCgnc2hvdWxkIHJldHVybiBzdWNjZXNzIGZsYWcgYW5kIGNsaWNrIGNvdW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZ2FtZSA9IG1vY2tHYW1lc1swXTtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoZ2FtZS5nYW1lX2lkKTtcbiAgICAgIGNvbnN0IHJlc3VsdDogQVBJR2F0ZXdheVByb3h5UmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCk7XG5cbiAgICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKHJlc3VsdC5ib2R5KTtcbiAgICAgIGV4cGVjdChib2R5KS50b0hhdmVQcm9wZXJ0eSgnc3VjY2VzcycpO1xuICAgICAgZXhwZWN0KGJvZHkpLnRvSGF2ZVByb3BlcnR5KCdhY2N1bXVsYXRlZF9jbGljaycpO1xuICAgICAgZXhwZWN0KHR5cGVvZiBib2R5LnN1Y2Nlc3MpLnRvQmUoJ2Jvb2xlYW4nKTtcbiAgICAgIGV4cGVjdCh0eXBlb2YgYm9keS5hY2N1bXVsYXRlZF9jbGljaykudG9CZSgnbnVtYmVyJyk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=