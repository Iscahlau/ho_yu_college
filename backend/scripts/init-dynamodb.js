"use strict";
/**
 * Initialize DynamoDB Local with Tables
 * Creates all required tables with appropriate schemas and indexes
 */
Object.defineProperty(exports, "__esModule", { value: true });
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
// Configuration for local DynamoDB
const client = new client_dynamodb_1.DynamoDBClient({
    region: process.env.AWS_REGION || 'us-east-1',
    endpoint: process.env.DYNAMODB_ENDPOINT || 'http://localhost:8002',
    credentials: {
        accessKeyId: process.env.AWS_ACCESS_KEY_ID || 'local',
        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY || 'local',
    },
    requestHandler: {
        requestTimeout: 10000, // 10 second timeout to prevent hanging
    },
});
const TABLE_NAMES = {
    students: process.env.STUDENTS_TABLE_NAME || 'ho-yu-students',
    teachers: process.env.TEACHERS_TABLE_NAME || 'ho-yu-teachers',
    games: process.env.GAMES_TABLE_NAME || 'ho-yu-games',
};
/**
 * Check if a table exists
 */
async function tableExists(tableName) {
    try {
        await client.send(new client_dynamodb_1.DescribeTableCommand({ TableName: tableName }));
        return true;
    }
    catch (error) {
        if (error.name === 'ResourceNotFoundException') {
            return false;
        }
        throw error;
    }
}
/**
 * Delete a table if it exists
 */
async function deleteTableIfExists(tableName) {
    const exists = await tableExists(tableName);
    if (exists) {
        console.log(`  Deleting existing table: ${tableName}`);
        await client.send(new client_dynamodb_1.DeleteTableCommand({ TableName: tableName }));
        // Wait a bit for deletion to complete
        await new Promise(resolve => setTimeout(resolve, 2000));
    }
}
/**
 * Create Students Table
 */
async function createStudentsTable() {
    const tableName = TABLE_NAMES.students;
    console.log(`Creating table: ${tableName}`);
    const command = new client_dynamodb_1.CreateTableCommand({
        TableName: tableName,
        KeySchema: [
            { AttributeName: 'student_id', KeyType: 'HASH' },
        ],
        AttributeDefinitions: [
            { AttributeName: 'student_id', AttributeType: 'S' },
            { AttributeName: 'teacher_id', AttributeType: 'S' },
        ],
        GlobalSecondaryIndexes: [
            {
                IndexName: 'teacher-index',
                KeySchema: [
                    { AttributeName: 'teacher_id', KeyType: 'HASH' },
                ],
                Projection: {
                    ProjectionType: 'ALL',
                },
                ProvisionedThroughput: {
                    ReadCapacityUnits: 5,
                    WriteCapacityUnits: 5,
                },
            },
        ],
        ProvisionedThroughput: {
            ReadCapacityUnits: 5,
            WriteCapacityUnits: 5,
        },
    });
    await client.send(command);
    console.log(`✓ Table created: ${tableName}`);
    // Wait for table to be active
    await (0, client_dynamodb_1.waitUntilTableExists)({ client, maxWaitTime: 60, minDelay: 1, maxDelay: 5 }, { TableName: tableName });
}
/**
 * Create Teachers Table
 */
async function createTeachersTable() {
    const tableName = TABLE_NAMES.teachers;
    console.log(`Creating table: ${tableName}`);
    const command = new client_dynamodb_1.CreateTableCommand({
        TableName: tableName,
        KeySchema: [
            { AttributeName: 'teacher_id', KeyType: 'HASH' },
        ],
        AttributeDefinitions: [
            { AttributeName: 'teacher_id', AttributeType: 'S' },
        ],
        ProvisionedThroughput: {
            ReadCapacityUnits: 5,
            WriteCapacityUnits: 5,
        },
    });
    await client.send(command);
    console.log(`✓ Table created: ${tableName}`);
    // Wait for table to be active
    await (0, client_dynamodb_1.waitUntilTableExists)({ client, maxWaitTime: 60, minDelay: 1, maxDelay: 5 }, { TableName: tableName });
}
/**
 * Create Games Table
 */
async function createGamesTable() {
    const tableName = TABLE_NAMES.games;
    console.log(`Creating table: ${tableName}`);
    const command = new client_dynamodb_1.CreateTableCommand({
        TableName: tableName,
        KeySchema: [
            { AttributeName: 'scratch_game_id', KeyType: 'HASH' },
        ],
        AttributeDefinitions: [
            { AttributeName: 'scratch_game_id', AttributeType: 'S' },
            { AttributeName: 'teacher_id', AttributeType: 'S' },
            { AttributeName: 'student_id', AttributeType: 'S' },
        ],
        GlobalSecondaryIndexes: [
            {
                IndexName: 'teacher-index',
                KeySchema: [
                    { AttributeName: 'teacher_id', KeyType: 'HASH' },
                ],
                Projection: {
                    ProjectionType: 'ALL',
                },
                ProvisionedThroughput: {
                    ReadCapacityUnits: 5,
                    WriteCapacityUnits: 5,
                },
            },
            {
                IndexName: 'student-index',
                KeySchema: [
                    { AttributeName: 'student_id', KeyType: 'HASH' },
                ],
                Projection: {
                    ProjectionType: 'ALL',
                },
                ProvisionedThroughput: {
                    ReadCapacityUnits: 5,
                    WriteCapacityUnits: 5,
                },
            },
        ],
        ProvisionedThroughput: {
            ReadCapacityUnits: 5,
            WriteCapacityUnits: 5,
        },
    });
    await client.send(command);
    console.log(`✓ Table created: ${tableName}`);
    // Wait for table to be active
    await (0, client_dynamodb_1.waitUntilTableExists)({ client, maxWaitTime: 60, minDelay: 1, maxDelay: 5 }, { TableName: tableName });
}
/**
 * Test DynamoDB connection
 */
async function testConnection() {
    console.log('Testing DynamoDB Local connection...');
    try {
        const listCommand = new client_dynamodb_1.ListTablesCommand({});
        await client.send(listCommand);
        console.log('✓ Connected to DynamoDB Local\n');
    }
    catch (error) {
        console.error('✗ Failed to connect to DynamoDB Local');
        console.error('  Endpoint:', process.env.DYNAMODB_ENDPOINT || 'http://localhost:8002');
        console.error('  Error:', error.message);
        console.error('\nTroubleshooting:');
        console.error('  1. Make sure DynamoDB Local is running: docker ps | grep dynamodb');
        console.error('  2. Check DynamoDB logs: docker logs ho-yu-dynamodb-local');
        console.error('  3. Restart containers: npm run dynamodb:down && npm run dynamodb:start');
        console.error('  4. Wait a few more seconds for DynamoDB to be ready');
        throw new Error('Cannot connect to DynamoDB Local');
    }
}
/**
 * Main function to initialize all tables
 */
async function initializeTables(reset = false) {
    try {
        console.log('Initializing DynamoDB Local tables...\n');
        // Test connection first to fail fast
        await testConnection();
        // List existing tables
        const listCommand = new client_dynamodb_1.ListTablesCommand({});
        const listResult = await client.send(listCommand);
        console.log(`Existing tables: ${listResult.TableNames?.join(', ') || 'none'}\n`);
        // Delete tables if reset is requested
        if (reset) {
            console.log('Resetting tables (deleting existing tables)...');
            await deleteTableIfExists(TABLE_NAMES.students);
            await deleteTableIfExists(TABLE_NAMES.teachers);
            await deleteTableIfExists(TABLE_NAMES.games);
            console.log('');
        }
        // Create tables only if they don't exist
        if (!await tableExists(TABLE_NAMES.students)) {
            await createStudentsTable();
        }
        else {
            console.log(`Table ${TABLE_NAMES.students} already exists, skipping creation`);
        }
        if (!await tableExists(TABLE_NAMES.teachers)) {
            await createTeachersTable();
        }
        else {
            console.log(`Table ${TABLE_NAMES.teachers} already exists, skipping creation`);
        }
        if (!await tableExists(TABLE_NAMES.games)) {
            await createGamesTable();
        }
        else {
            console.log(`Table ${TABLE_NAMES.games} already exists, skipping creation`);
        }
        console.log('\n✓ All tables created successfully!');
        console.log('\nNext steps:');
        console.log('  1. Run seed script to populate data: npm run dynamodb:seed');
        console.log('  2. View tables in DynamoDB Admin: http://localhost:8001');
        console.log('  3. Start using the local DynamoDB in your application\n');
    }
    catch (error) {
        console.error('Error initializing tables:', error);
        throw error;
    }
}
// Parse command line arguments
const args = process.argv.slice(2);
const reset = args.includes('--reset') || args.includes('-r');
// Run initialization
initializeTables(reset)
    .then(() => process.exit(0))
    .catch((error) => {
    console.error('Failed to initialize tables:', error);
    process.exit(1);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5pdC1keW5hbW9kYi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImluaXQtZHluYW1vZGIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7QUFFSCw4REFPa0M7QUFFbEMsbUNBQW1DO0FBQ25DLE1BQU0sTUFBTSxHQUFHLElBQUksZ0NBQWMsQ0FBQztJQUNoQyxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksV0FBVztJQUM3QyxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSx1QkFBdUI7SUFDbEUsV0FBVyxFQUFFO1FBQ1gsV0FBVyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLElBQUksT0FBTztRQUNyRCxlQUFlLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsSUFBSSxPQUFPO0tBQzlEO0lBQ0QsY0FBYyxFQUFFO1FBQ2QsY0FBYyxFQUFFLEtBQUssRUFBRSx1Q0FBdUM7S0FDL0Q7Q0FDRixDQUFDLENBQUM7QUFFSCxNQUFNLFdBQVcsR0FBRztJQUNsQixRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsSUFBSSxnQkFBZ0I7SUFDN0QsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLElBQUksZ0JBQWdCO0lBQzdELEtBQUssRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixJQUFJLGFBQWE7Q0FDckQsQ0FBQztBQUVGOztHQUVHO0FBQ0gsS0FBSyxVQUFVLFdBQVcsQ0FBQyxTQUFpQjtJQUMxQyxJQUFJLENBQUM7UUFDSCxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxzQ0FBb0IsQ0FBQyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDdEUsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztRQUNwQixJQUFJLEtBQUssQ0FB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QyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDN0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyw4REFBOEQsQ0FBQyxDQUFDO1FBQzVFLE9BQU8sQ0FBQyxHQUFHLENBQUMsMkRBQTJELENBQUMsQ0FBQztRQUN6RSxPQUFPLENBQUMsR0FBRyxDQUFDLDJEQUEyRCxDQUFDLENBQUM7SUFDM0UsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLDRCQUE0QixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ25ELE1BQU0sS0FBSyxDQUFDO0lBQ2QsQ0FBQztBQUNILENBQUM7QUFFRCwrQkFBK0I7QUFDL0IsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDbkMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBRTlELHFCQUFxQjtBQUNyQixnQkFBZ0IsQ0FBQyxLQUFLLENBQUM7S0FDcEIsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDM0IsS0FBSyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUU7SUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLDhCQUE4QixFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3JELE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDbEIsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEluaXRpYWxpemUgRHluYW1vREIgTG9jYWwgd2l0aCBUYWJsZXNcbiAqIENyZWF0ZXMgYWxsIHJlcXVpcmVkIHRhYmxlcyB3aXRoIGFwcHJvcHJpYXRlIHNjaGVtYXMgYW5kIGluZGV4ZXNcbiAqL1xuXG5pbXBvcnQge1xuICBEeW5hbW9EQkNsaWVudCxcbiAgQ3JlYXRlVGFibGVDb21tYW5kLFxuICBMaXN0VGFibGVzQ29tbWFuZCxcbiAgRGVsZXRlVGFibGVDb21tYW5kLFxuICBEZXNjcmliZVRhYmxlQ29tbWFuZCxcbiAgd2FpdFVudGlsVGFibGVFeGlzdHMsXG59IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5cbi8vIENvbmZpZ3VyYXRpb24gZm9yIGxvY2FsIER5bmFtb0RCXG5jb25zdCBjbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe1xuICByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgJ3VzLWVhc3QtMScsXG4gIGVuZHBvaW50OiBwcm9jZXNzLmVudi5EWU5BTU9EQl9FTkRQT0lOVCB8fCAnaHR0cDovL2xvY2FsaG9zdDo4MDAyJyxcbiAgY3JlZGVudGlhbHM6IHtcbiAgICBhY2Nlc3NLZXlJZDogcHJvY2Vzcy5lbnYuQVdTX0FDQ0VTU19LRVlfSUQgfHwgJ2xvY2FsJyxcbiAgICBzZWNyZXRBY2Nlc3NLZXk6IHByb2Nlc3MuZW52LkFXU19TRUNSRVRfQUNDRVNTX0tFWSB8fCAnbG9jYWwnLFxuICB9LFxuICByZXF1ZXN0SGFuZGxlcjoge1xuICAgIHJlcXVlc3RUaW1lb3V0OiAxMDAwMCwgLy8gMTAgc2Vjb25kIHRpbWVvdXQgdG8gcHJldmVudCBoYW5naW5nXG4gIH0sXG59KTtcblxuY29uc3QgVEFCTEVfTkFNRVMgPSB7XG4gIHN0dWRlbnRzOiBwcm9jZXNzLmVudi5TVFVERU5UU19UQUJMRV9OQU1FIHx8ICdoby15dS1zdHVkZW50cycsXG4gIHRlYWNoZXJzOiBwcm9jZXNzLmVudi5URUFDSEVSU19UQUJMRV9OQU1FIHx8ICdoby15dS10ZWFjaGVycycsXG4gIGdhbWVzOiBwcm9jZXNzLmVudi5HQU1FU19UQUJMRV9OQU1FIHx8ICdoby15dS1nYW1lcycsXG59O1xuXG4vKipcbiAqIENoZWNrIGlmIGEgdGFibGUgZXhpc3RzXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHRhYmxlRXhpc3RzKHRhYmxlTmFtZTogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIHRyeSB7XG4gICAgYXdhaXQgY2xpZW50LnNlbmQobmV3IERlc2NyaWJlVGFibGVDb21tYW5kKHsgVGFibGVOYW1lOiB0YWJsZU5hbWUgfSkpO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgaWYgKGVycm9yLm5hbWUgPT09ICdSZXNvdXJjZU5vdEZvdW5kRXhjZXB0aW9uJykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufVxuXG4vKipcbiAqIERlbGV0ZSBhIHRhYmxlIGlmIGl0IGV4aXN0c1xuICovXG5hc3luYyBmdW5jdGlvbiBkZWxldGVUYWJsZUlmRXhpc3RzKHRhYmxlTmFtZTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IGV4aXN0cyA9IGF3YWl0IHRhYmxlRXhpc3RzKHRhYmxlTmFtZSk7XG4gIGlmIChleGlzdHMpIHtcbiAgICBjb25zb2xlLmxvZyhgICBEZWxldGluZyBleGlzdGluZyB0YWJsZTogJHt0YWJsZU5hbWV9YCk7XG4gICAgYXdhaXQgY2xpZW50LnNlbmQobmV3IERlbGV0ZVRhYmxlQ29tbWFuZCh7IFRhYmxlTmFtZTogdGFibGVOYW1lIH0pKTtcbiAgICAvLyBXYWl0IGEgYml0IGZvciBkZWxldGlvbiB0byBjb21wbGV0ZVxuICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAyMDAwKSk7XG4gIH1cbn1cblxuLyoqXG4gKiBDcmVhdGUgU3R1ZGVudHMgVGFibGVcbiAqL1xuYXN5bmMgZnVuY3Rpb24gY3JlYXRlU3R1ZGVudHNUYWJsZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3QgdGFibGVOYW1lID0gVEFCTEVfTkFNRVMuc3R1ZGVudHM7XG4gIFxuICBjb25zb2xlLmxvZyhgQ3JlYXRpbmcgdGFibGU6ICR7dGFibGVOYW1lfWApO1xuICBcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBDcmVhdGVUYWJsZUNvbW1hbmQoe1xuICAgIFRhYmxlTmFtZTogdGFibGVOYW1lLFxuICAgIEtleVNjaGVtYTogW1xuICAgICAgeyBBdHRyaWJ1dGVOYW1lOiAnc3R1ZGVudF9pZCcsIEtleVR5cGU6ICdIQVNIJyB9LFxuICAgIF0sXG4gICAgQXR0cmlidXRlRGVmaW5pdGlvbnM6IFtcbiAgICAgIHsgQXR0cmlidXRlTmFtZTogJ3N0dWRlbnRfaWQnLCBBdHRyaWJ1dGVUeXBlOiAnUycgfSxcbiAgICAgIHsgQXR0cmlidXRlTmFtZTogJ3RlYWNoZXJfaWQnLCBBdHRyaWJ1dGVUeXBlOiAnUycgfSxcbiAgICBdLFxuICAgIEdsb2JhbFNlY29uZGFyeUluZGV4ZXM6IFtcbiAgICAgIHtcbiAgICAgICAgSW5kZXhOYW1lOiAndGVhY2hlci1pbmRleCcsXG4gICAgICAgIEtleVNjaGVtYTogW1xuICAgICAgICAgIHsgQXR0cmlidXRlTmFtZTogJ3RlYWNoZXJfaWQnLCBLZXlUeXBlOiAnSEFTSCcgfSxcbiAgICAgICAgXSxcbiAgICAgICAgUHJvamVjdGlvbjoge1xuICAgICAgICAgIFByb2plY3Rpb25UeXBlOiAnQUxMJyxcbiAgICAgICAgfSxcbiAgICAgICAgUHJvdmlzaW9uZWRUaHJvdWdocHV0OiB7XG4gICAgICAgICAgUmVhZENhcGFjaXR5VW5pdHM6IDUsXG4gICAgICAgICAgV3JpdGVDYXBhY2l0eVVuaXRzOiA1LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICBdLFxuICAgIFByb3Zpc2lvbmVkVGhyb3VnaHB1dDoge1xuICAgICAgUmVhZENhcGFjaXR5VW5pdHM6IDUsXG4gICAgICBXcml0ZUNhcGFjaXR5VW5pdHM6IDUsXG4gICAgfSxcbiAgfSk7XG5cbiAgYXdhaXQgY2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIGNvbnNvbGUubG9nKGDinJMgVGFibGUgY3JlYXRlZDogJHt0YWJsZU5hbWV9YCk7XG4gIFxuICAvLyBXYWl0IGZvciB0YWJsZSB0byBiZSBhY3RpdmVcbiAgYXdhaXQgd2FpdFVudGlsVGFibGVFeGlzdHMoXG4gICAgeyBjbGllbnQsIG1heFdhaXRUaW1lOiA2MCwgbWluRGVsYXk6IDEsIG1heERlbGF5OiA1IH0sXG4gICAgeyBUYWJsZU5hbWU6IHRhYmxlTmFtZSB9XG4gICk7XG59XG5cbi8qKlxuICogQ3JlYXRlIFRlYWNoZXJzIFRhYmxlXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVRlYWNoZXJzVGFibGUoKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IHRhYmxlTmFtZSA9IFRBQkxFX05BTUVTLnRlYWNoZXJzO1xuICBcbiAgY29uc29sZS5sb2coYENyZWF0aW5nIHRhYmxlOiAke3RhYmxlTmFtZX1gKTtcbiAgXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgQ3JlYXRlVGFibGVDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IHRhYmxlTmFtZSxcbiAgICBLZXlTY2hlbWE6IFtcbiAgICAgIHsgQXR0cmlidXRlTmFtZTogJ3RlYWNoZXJfaWQnLCBLZXlUeXBlOiAnSEFTSCcgfSxcbiAgICBdLFxuICAgIEF0dHJpYnV0ZURlZmluaXRpb25zOiBbXG4gICAgICB7IEF0dHJpYnV0ZU5hbWU6ICd0ZWFjaGVyX2lkJywgQXR0cmlidXRlVHlwZTogJ1MnIH0sXG4gICAgXSxcbiAgICBQcm92aXNpb25lZFRocm91Z2hwdXQ6IHtcbiAgICAgIFJlYWRDYXBhY2l0eVVuaXRzOiA1LFxuICAgICAgV3JpdGVDYXBhY2l0eVVuaXRzOiA1LFxuICAgIH0sXG4gIH0pO1xuXG4gIGF3YWl0IGNsaWVudC5zZW5kKGNvbW1hbmQpO1xuICBjb25zb2xlLmxvZyhg4pyTIFRhYmxlIGNyZWF0ZWQ6ICR7dGFibGVOYW1lfWApO1xuICBcbiAgLy8gV2FpdCBmb3IgdGFibGUgdG8gYmUgYWN0aXZlXG4gIGF3YWl0IHdhaXRVbnRpbFRhYmxlRXhpc3RzKFxuICAgIHsgY2xpZW50LCBtYXhXYWl0VGltZTogNjAsIG1pbkRlbGF5OiAxLCBtYXhEZWxheTogNSB9LFxuICAgIHsgVGFibGVOYW1lOiB0YWJsZU5hbWUgfVxuICApO1xufVxuXG4vKipcbiAqIENyZWF0ZSBHYW1lcyBUYWJsZVxuICovXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVHYW1lc1RhYmxlKCk6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCB0YWJsZU5hbWUgPSBUQUJMRV9OQU1FUy5nYW1lcztcbiAgXG4gIGNvbnNvbGUubG9nKGBDcmVhdGluZyB0YWJsZTogJHt0YWJsZU5hbWV9YCk7XG4gIFxuICBjb25zdCBjb21tYW5kID0gbmV3IENyZWF0ZVRhYmxlQ29tbWFuZCh7XG4gICAgVGFibGVOYW1lOiB0YWJsZU5hbWUsXG4gICAgS2V5U2NoZW1hOiBbXG4gICAgICB7IEF0dHJpYnV0ZU5hbWU6ICdzY3JhdGNoX2dhbWVfaWQnLCBLZXlUeXBlOiAnSEFTSCcgfSxcbiAgICBdLFxuICAgIEF0dHJpYnV0ZURlZmluaXRpb25zOiBbXG4gICAgICB7IEF0dHJpYnV0ZU5hbWU6ICdzY3JhdGNoX2dhbWVfaWQnLCBBdHRyaWJ1dGVUeXBlOiAnUycgfSxcbiAgICAgIHsgQXR0cmlidXRlTmFtZTogJ3RlYWNoZXJfaWQnLCBBdHRyaWJ1dGVUeXBlOiAnUycgfSxcbiAgICAgIHsgQXR0cmlidXRlTmFtZTogJ3N0dWRlbnRfaWQnLCBBdHRyaWJ1dGVUeXBlOiAnUycgfSxcbiAgICBdLFxuICAgIEdsb2JhbFNlY29uZGFyeUluZGV4ZXM6IFtcbiAgICAgIHtcbiAgICAgICAgSW5kZXhOYW1lOiAndGVhY2hlci1pbmRleCcsXG4gICAgICAgIEtleVNjaGVtYTogW1xuICAgICAgICAgIHsgQXR0cmlidXRlTmFtZTogJ3RlYWNoZXJfaWQnLCBLZXlUeXBlOiAnSEFTSCcgfSxcbiAgICAgICAgXSxcbiAgICAgICAgUHJvamVjdGlvbjoge1xuICAgICAgICAgIFByb2plY3Rpb25UeXBlOiAnQUxMJyxcbiAgICAgICAgfSxcbiAgICAgICAgUHJvdmlzaW9uZWRUaHJvdWdocHV0OiB7XG4gICAgICAgICAgUmVhZENhcGFjaXR5VW5pdHM6IDUsXG4gICAgICAgICAgV3JpdGVDYXBhY2l0eVVuaXRzOiA1LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgSW5kZXhOYW1lOiAnc3R1ZGVudC1pbmRleCcsXG4gICAgICAgIEtleVNjaGVtYTogW1xuICAgICAgICAgIHsgQXR0cmlidXRlTmFtZTogJ3N0dWRlbnRfaWQnLCBLZXlUeXBlOiAnSEFTSCcgfSxcbiAgICAgICAgXSxcbiAgICAgICAgUHJvamVjdGlvbjoge1xuICAgICAgICAgIFByb2plY3Rpb25UeXBlOiAnQUxMJyxcbiAgICAgICAgfSxcbiAgICAgICAgUHJvdmlzaW9uZWRUaHJvdWdocHV0OiB7XG4gICAgICAgICAgUmVhZENhcGFjaXR5VW5pdHM6IDUsXG4gICAgICAgICAgV3JpdGVDYXBhY2l0eVVuaXRzOiA1LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICBdLFxuICAgIFByb3Zpc2lvbmVkVGhyb3VnaHB1dDoge1xuICAgICAgUmVhZENhcGFjaXR5VW5pdHM6IDUsXG4gICAgICBXcml0ZUNhcGFjaXR5VW5pdHM6IDUsXG4gICAgfSxcbiAgfSk7XG5cbiAgYXdhaXQgY2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIGNvbnNvbGUubG9nKGDinJMgVGFibGUgY3JlYXRlZDogJHt0YWJsZU5hbWV9YCk7XG4gIFxuICAvLyBXYWl0IGZvciB0YWJsZSB0byBiZSBhY3RpdmVcbiAgYXdhaXQgd2FpdFVudGlsVGFibGVFeGlzdHMoXG4gICAgeyBjbGllbnQsIG1heFdhaXRUaW1lOiA2MCwgbWluRGVsYXk6IDEsIG1heERlbGF5OiA1IH0sXG4gICAgeyBUYWJsZU5hbWU6IHRhYmxlTmFtZSB9XG4gICk7XG59XG5cbi8qKlxuICogVGVzdCBEeW5hbW9EQiBjb25uZWN0aW9uXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHRlc3RDb25uZWN0aW9uKCk6IFByb21pc2U8dm9pZD4ge1xuICBjb25zb2xlLmxvZygnVGVzdGluZyBEeW5hbW9EQiBMb2NhbCBjb25uZWN0aW9uLi4uJyk7XG4gIHRyeSB7XG4gICAgY29uc3QgbGlzdENvbW1hbmQgPSBuZXcgTGlzdFRhYmxlc0NvbW1hbmQoe30pO1xuICAgIGF3YWl0IGNsaWVudC5zZW5kKGxpc3RDb21tYW5kKTtcbiAgICBjb25zb2xlLmxvZygn4pyTIENvbm5lY3RlZCB0byBEeW5hbW9EQiBMb2NhbFxcbicpO1xuICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgY29uc29sZS5lcnJvcign4pyXIEZhaWxlZCB0byBjb25uZWN0IHRvIER5bmFtb0RCIExvY2FsJyk7XG4gICAgY29uc29sZS5lcnJvcignICBFbmRwb2ludDonLCBwcm9jZXNzLmVudi5EWU5BTU9EQl9FTkRQT0lOVCB8fCAnaHR0cDovL2xvY2FsaG9zdDo4MDAyJyk7XG4gICAgY29uc29sZS5lcnJvcignICBFcnJvcjonLCBlcnJvci5tZXNzYWdlKTtcbiAgICBjb25zb2xlLmVycm9yKCdcXG5Ucm91Ymxlc2hvb3Rpbmc6Jyk7XG4gICAgY29uc29sZS5lcnJvcignICAxLiBNYWtlIHN1cmUgRHluYW1vREIgTG9jYWwgaXMgcnVubmluZzogZG9ja2VyIHBzIHwgZ3JlcCBkeW5hbW9kYicpO1xuICAgIGNvbnNvbGUuZXJyb3IoJyAgMi4gQ2hlY2sgRHluYW1vREIgbG9nczogZG9ja2VyIGxvZ3MgaG8teXUtZHluYW1vZGItbG9jYWwnKTtcbiAgICBjb25zb2xlLmVycm9yKCcgIDMuIFJlc3RhcnQgY29udGFpbmVyczogbnBtIHJ1biBkeW5hbW9kYjpkb3duICYmIG5wbSBydW4gZHluYW1vZGI6c3RhcnQnKTtcbiAgICBjb25zb2xlLmVycm9yKCcgIDQuIFdhaXQgYSBmZXcgbW9yZSBzZWNvbmRzIGZvciBEeW5hbW9EQiB0byBiZSByZWFkeScpO1xuICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGNvbm5lY3QgdG8gRHluYW1vREIgTG9jYWwnKTtcbiAgfVxufVxuXG4vKipcbiAqIE1haW4gZnVuY3Rpb24gdG8gaW5pdGlhbGl6ZSBhbGwgdGFibGVzXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGluaXRpYWxpemVUYWJsZXMocmVzZXQ6IGJvb2xlYW4gPSBmYWxzZSk6IFByb21pc2U8dm9pZD4ge1xuICB0cnkge1xuICAgIGNvbnNvbGUubG9nKCdJbml0aWFsaXppbmcgRHluYW1vREIgTG9jYWwgdGFibGVzLi4uXFxuJyk7XG4gICAgXG4gICAgLy8gVGVzdCBjb25uZWN0aW9uIGZpcnN0IHRvIGZhaWwgZmFzdFxuICAgIGF3YWl0IHRlc3RDb25uZWN0aW9uKCk7XG5cbiAgICAvLyBMaXN0IGV4aXN0aW5nIHRhYmxlc1xuICAgIGNvbnN0IGxpc3RDb21tYW5kID0gbmV3IExpc3RUYWJsZXNDb21tYW5kKHt9KTtcbiAgICBjb25zdCBsaXN0UmVzdWx0ID0gYXdhaXQgY2xpZW50LnNlbmQobGlzdENvbW1hbmQpO1xuICAgIGNvbnNvbGUubG9nKGBFeGlzdGluZyB0YWJsZXM6ICR7bGlzdFJlc3VsdC5UYWJsZU5hbWVzPy5qb2luKCcsICcpIHx8ICdub25lJ31cXG5gKTtcblxuICAgIC8vIERlbGV0ZSB0YWJsZXMgaWYgcmVzZXQgaXMgcmVxdWVzdGVkXG4gICAgaWYgKHJlc2V0KSB7XG4gICAgICBjb25zb2xlLmxvZygnUmVzZXR0aW5nIHRhYmxlcyAoZGVsZXRpbmcgZXhpc3RpbmcgdGFibGVzKS4uLicpO1xuICAgICAgYXdhaXQgZGVsZXRlVGFibGVJZkV4aXN0cyhUQUJMRV9OQU1FUy5zdHVkZW50cyk7XG4gICAgICBhd2FpdCBkZWxldGVUYWJsZUlmRXhpc3RzKFRBQkxFX05BTUVTLnRlYWNoZXJzKTtcbiAgICAgIGF3YWl0IGRlbGV0ZVRhYmxlSWZFeGlzdHMoVEFCTEVfTkFNRVMuZ2FtZXMpO1xuICAgICAgY29uc29sZS5sb2coJycpO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSB0YWJsZXMgb25seSBpZiB0aGV5IGRvbid0IGV4aXN0XG4gICAgaWYgKCFhd2FpdCB0YWJsZUV4aXN0cyhUQUJMRV9OQU1FUy5zdHVkZW50cykpIHtcbiAgICAgIGF3YWl0IGNyZWF0ZVN0dWRlbnRzVGFibGUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coYFRhYmxlICR7VEFCTEVfTkFNRVMuc3R1ZGVudHN9IGFscmVhZHkgZXhpc3RzLCBza2lwcGluZyBjcmVhdGlvbmApO1xuICAgIH1cblxuICAgIGlmICghYXdhaXQgdGFibGVFeGlzdHMoVEFCTEVfTkFNRVMudGVhY2hlcnMpKSB7XG4gICAgICBhd2FpdCBjcmVhdGVUZWFjaGVyc1RhYmxlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKGBUYWJsZSAke1RBQkxFX05BTUVTLnRlYWNoZXJzfSBhbHJlYWR5IGV4aXN0cywgc2tpcHBpbmcgY3JlYXRpb25gKTtcbiAgICB9XG5cbiAgICBpZiAoIWF3YWl0IHRhYmxlRXhpc3RzKFRBQkxFX05BTUVTLmdhbWVzKSkge1xuICAgICAgYXdhaXQgY3JlYXRlR2FtZXNUYWJsZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmxvZyhgVGFibGUgJHtUQUJMRV9OQU1FUy5nYW1lc30gYWxyZWFkeSBleGlzdHMsIHNraXBwaW5nIGNyZWF0aW9uYCk7XG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coJ1xcbuKckyBBbGwgdGFibGVzIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5IScpO1xuICAgIGNvbnNvbGUubG9nKCdcXG5OZXh0IHN0ZXBzOicpO1xuICAgIGNvbnNvbGUubG9nKCcgIDEuIFJ1biBzZWVkIHNjcmlwdCB0byBwb3B1bGF0ZSBkYXRhOiBucG0gcnVuIGR5bmFtb2RiOnNlZWQnKTtcbiAgICBjb25zb2xlLmxvZygnICAyLiBWaWV3IHRhYmxlcyBpbiBEeW5hbW9EQiBBZG1pbjogaHR0cDovL2xvY2FsaG9zdDo4MDAxJyk7XG4gICAgY29uc29sZS5sb2coJyAgMy4gU3RhcnQgdXNpbmcgdGhlIGxvY2FsIER5bmFtb0RCIGluIHlvdXIgYXBwbGljYXRpb25cXG4nKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbml0aWFsaXppbmcgdGFibGVzOicsIGVycm9yKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufVxuXG4vLyBQYXJzZSBjb21tYW5kIGxpbmUgYXJndW1lbnRzXG5jb25zdCBhcmdzID0gcHJvY2Vzcy5hcmd2LnNsaWNlKDIpO1xuY29uc3QgcmVzZXQgPSBhcmdzLmluY2x1ZGVzKCctLXJlc2V0JykgfHwgYXJncy5pbmNsdWRlcygnLXInKTtcblxuLy8gUnVuIGluaXRpYWxpemF0aW9uXG5pbml0aWFsaXplVGFibGVzKHJlc2V0KVxuICAudGhlbigoKSA9PiBwcm9jZXNzLmV4aXQoMCkpXG4gIC5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gaW5pdGlhbGl6ZSB0YWJsZXM6JywgZXJyb3IpO1xuICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgfSk7XG4iXX0=