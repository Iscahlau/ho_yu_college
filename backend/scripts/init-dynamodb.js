"use strict";
/**
 * Initialize DynamoDB Local with Tables
 * Creates all required tables with appropriate schemas and indexes
 */
Object.defineProperty(exports, "__esModule", { value: true });
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
// Configuration for local DynamoDB
const client = new client_dynamodb_1.DynamoDBClient({
    region: process.env.AWS_REGION || 'us-east-1',
    endpoint: process.env.DYNAMODB_ENDPOINT || 'http://localhost:8002',
    credentials: {
        accessKeyId: process.env.AWS_ACCESS_KEY_ID || 'local',
        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY || 'local',
    },
    requestHandler: {
        requestTimeout: 10000, // 10 second timeout to prevent hanging
    },
});
const TABLE_NAMES = {
    students: process.env.STUDENTS_TABLE_NAME || 'ho-yu-students',
    teachers: process.env.TEACHERS_TABLE_NAME || 'ho-yu-teachers',
    games: process.env.GAMES_TABLE_NAME || 'ho-yu-games',
};
/**
 * Check if a table exists
 */
async function tableExists(tableName) {
    try {
        await client.send(new client_dynamodb_1.DescribeTableCommand({ TableName: tableName }));
        return true;
    }
    catch (error) {
        if (error.name === 'ResourceNotFoundException') {
            return false;
        }
        throw error;
    }
}
/**
 * Delete a table if it exists
 */
async function deleteTableIfExists(tableName) {
    const exists = await tableExists(tableName);
    if (exists) {
        console.log(`  Deleting existing table: ${tableName}`);
        await client.send(new client_dynamodb_1.DeleteTableCommand({ TableName: tableName }));
        // Wait a bit for deletion to complete
        await new Promise(resolve => setTimeout(resolve, 2000));
    }
}
/**
 * Create Students Table
 */
async function createStudentsTable() {
    const tableName = TABLE_NAMES.students;
    console.log(`Creating table: ${tableName}`);
    const command = new client_dynamodb_1.CreateTableCommand({
        TableName: tableName,
        KeySchema: [
            { AttributeName: 'student_id', KeyType: 'HASH' },
        ],
        AttributeDefinitions: [
            { AttributeName: 'student_id', AttributeType: 'S' },
            { AttributeName: 'teacher_id', AttributeType: 'S' },
        ],
        GlobalSecondaryIndexes: [
            {
                IndexName: 'teacher-index',
                KeySchema: [
                    { AttributeName: 'teacher_id', KeyType: 'HASH' },
                ],
                Projection: {
                    ProjectionType: 'ALL',
                },
                ProvisionedThroughput: {
                    ReadCapacityUnits: 5,
                    WriteCapacityUnits: 5,
                },
            },
        ],
        ProvisionedThroughput: {
            ReadCapacityUnits: 5,
            WriteCapacityUnits: 5,
        },
    });
    await client.send(command);
    console.log(`✓ Table created: ${tableName}`);
    // Wait for table to be active
    await (0, client_dynamodb_1.waitUntilTableExists)({ client, maxWaitTime: 60, minDelay: 1, maxDelay: 5 }, { TableName: tableName });
}
/**
 * Create Teachers Table
 */
async function createTeachersTable() {
    const tableName = TABLE_NAMES.teachers;
    console.log(`Creating table: ${tableName}`);
    const command = new client_dynamodb_1.CreateTableCommand({
        TableName: tableName,
        KeySchema: [
            { AttributeName: 'teacher_id', KeyType: 'HASH' },
        ],
        AttributeDefinitions: [
            { AttributeName: 'teacher_id', AttributeType: 'S' },
        ],
        ProvisionedThroughput: {
            ReadCapacityUnits: 5,
            WriteCapacityUnits: 5,
        },
    });
    await client.send(command);
    console.log(`✓ Table created: ${tableName}`);
    // Wait for table to be active
    await (0, client_dynamodb_1.waitUntilTableExists)({ client, maxWaitTime: 60, minDelay: 1, maxDelay: 5 }, { TableName: tableName });
}
/**
 * Create Games Table
 */
async function createGamesTable() {
    const tableName = TABLE_NAMES.games;
    console.log(`Creating table: ${tableName}`);
    const command = new client_dynamodb_1.CreateTableCommand({
        TableName: tableName,
        KeySchema: [
            { AttributeName: 'game_id', KeyType: 'HASH' },
        ],
        AttributeDefinitions: [
            { AttributeName: 'game_id', AttributeType: 'S' },
            { AttributeName: 'teacher_id', AttributeType: 'S' },
            { AttributeName: 'student_id', AttributeType: 'S' },
        ],
        GlobalSecondaryIndexes: [
            {
                IndexName: 'teacher-index',
                KeySchema: [
                    { AttributeName: 'teacher_id', KeyType: 'HASH' },
                ],
                Projection: {
                    ProjectionType: 'ALL',
                },
                ProvisionedThroughput: {
                    ReadCapacityUnits: 5,
                    WriteCapacityUnits: 5,
                },
            },
            {
                IndexName: 'student-index',
                KeySchema: [
                    { AttributeName: 'student_id', KeyType: 'HASH' },
                ],
                Projection: {
                    ProjectionType: 'ALL',
                },
                ProvisionedThroughput: {
                    ReadCapacityUnits: 5,
                    WriteCapacityUnits: 5,
                },
            },
        ],
        ProvisionedThroughput: {
            ReadCapacityUnits: 5,
            WriteCapacityUnits: 5,
        },
    });
    await client.send(command);
    console.log(`✓ Table created: ${tableName}`);
    // Wait for table to be active
    await (0, client_dynamodb_1.waitUntilTableExists)({ client, maxWaitTime: 60, minDelay: 1, maxDelay: 5 }, { TableName: tableName });
}
/**
 * Test DynamoDB connection
 */
async function testConnection() {
    console.log('Testing DynamoDB Local connection...');
    try {
        const listCommand = new client_dynamodb_1.ListTablesCommand({});
        await client.send(listCommand);
        console.log('✓ Connected to DynamoDB Local\n');
    }
    catch (error) {
        console.error('✗ Failed to connect to DynamoDB Local');
        console.error('  Endpoint:', process.env.DYNAMODB_ENDPOINT || 'http://localhost:8002');
        console.error('  Error:', error.message);
        console.error('\nTroubleshooting:');
        console.error('  1. Make sure DynamoDB Local is running: docker ps | grep dynamodb');
        console.error('  2. Check DynamoDB logs: docker logs ho-yu-dynamodb-local');
        console.error('  3. Restart containers: npm run dynamodb:down && npm run dynamodb:start');
        console.error('  4. Wait a few more seconds for DynamoDB to be ready');
        throw new Error('Cannot connect to DynamoDB Local');
    }
}
/**
 * Main function to initialize all tables
 */
async function initializeTables(reset = false) {
    try {
        console.log('Initializing DynamoDB Local tables...\n');
        // Test connection first to fail fast
        await testConnection();
        // List existing tables
        const listCommand = new client_dynamodb_1.ListTablesCommand({});
        const listResult = await client.send(listCommand);
        console.log(`Existing tables: ${listResult.TableNames?.join(', ') || 'none'}\n`);
        // Delete tables if reset is requested
        if (reset) {
            console.log('Resetting tables (deleting existing tables)...');
            await deleteTableIfExists(TABLE_NAMES.students);
            await deleteTableIfExists(TABLE_NAMES.teachers);
            await deleteTableIfExists(TABLE_NAMES.games);
            console.log('');
        }
        // Create tables only if they don't exist
        if (!await tableExists(TABLE_NAMES.students)) {
            await createStudentsTable();
        }
        else {
            console.log(`Table ${TABLE_NAMES.students} already exists, skipping creation`);
        }
        if (!await tableExists(TABLE_NAMES.teachers)) {
            await createTeachersTable();
        }
        else {
            console.log(`Table ${TABLE_NAMES.teachers} already exists, skipping creation`);
        }
        if (!await tableExists(TABLE_NAMES.games)) {
            await createGamesTable();
        }
        else {
            console.log(`Table ${TABLE_NAMES.games} already exists, skipping creation`);
        }
        console.log('\n✓ All tables created successfully!');
        console.log('\nNext steps:');
        console.log('  1. Run seed script to populate data: npm run dynamodb:seed');
        console.log('  2. View tables in DynamoDB Admin: http://localhost:8001');
        console.log('  3. Start using the local DynamoDB in your application\n');
    }
    catch (error) {
        console.error('Error initializing tables:', error);
        throw error;
    }
}
// Parse command line arguments
const args = process.argv.slice(2);
const reset = args.includes('--reset') || args.includes('-r');
// Run initialization
initializeTables(reset)
    .then(() => process.exit(0))
    .catch((error) => {
    console.error('Failed to initialize tables:', error);
    process.exit(1);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5pdC1keW5hbW9kYi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImluaXQtZHluYW1vZGIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7QUFFSCw4REFPa0M7QUFFbEMsbUNBQW1DO0FBQ25DLE1BQU0sTUFBTSxHQUFHLElBQUksZ0NBQWMsQ0FBQztJQUNoQyxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksV0FBVztJQUM3QyxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSx1QkFBdUI7SUFDbEUsV0FBVyxFQUFFO1FBQ1gsV0FBVyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLElBQUksT0FBTztRQUNyRCxlQUFlLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsSUFBSSxPQUFPO0tBQzlEO0lBQ0QsY0FBYyxFQUFFO1FBQ2QsY0FBYyxFQUFFLEtBQUssRUFBRSx1Q0FBdUM7S0FDL0Q7Q0FDRixDQUFDLENBQUM7QUFFSCxNQUFNLFdBQVcsR0FBRztJQUNsQixRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsSUFBSSxnQkFBZ0I7SUFDN0QsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLElBQUksZ0JBQWdCO0lBQzdELEtBQUssRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixJQUFJLGFBQWE7Q0FDckQsQ0FBQztBQUVGOztHQUVHO0FBQ0gsS0FBSyxVQUFVLFdBQVcsQ0FBQyxTQUFpQjtJQUMxQyxJQUFJLENBQUM7UUFDSCxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxzQ0FBb0IsQ0FBQyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDdEUsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztRQUNwQixJQUFJLEtBQUssQ0FBQyxJQUFJLEtBQUssMkJBQTJCLEVBQUUsQ0FBQztZQUMvQyxPQUFPLEtBQUssQ0FBQztRQUNmLENBQUM7UUFDRCxNQUFNLEtBQUssQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxLQUFLLFVBQVUsbUJBQW1CLENBQUMsU0FBaUI7SUFDbEQsTUFBTSxNQUFNLEdBQUcsTUFBTSxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDNUMsSUFBSSxNQUFNLEVBQUUsQ0FBQztRQUNYLE9BQU8sQ0FBQyxHQUFHLENBQUMsOEJBQThCLFNBQVMsRUFBRSxDQUFDLENBQUM7UUFDdkQsTUFBTSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksb0NBQWtCLENBQUMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3BFLHNDQUFzQztRQUN0QyxNQUFNLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzFELENBQUM7QUFDSCxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxLQUFLLFVBQVUsbUJBQW1CO0lBQ2hDLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxRQUFRLENBQUM7SUFFdkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsU0FBUyxFQUFFLENBQUMsQ0FBQztJQUU1QyxNQUFNLE9BQU8sR0FBRyxJQUFJLG9DQUFrQixDQUFDO1FBQ3JDLFNBQVMsRUFBRSxTQUFTO1FBQ3BCLFNBQVMsRUFBRTtZQUNULEVBQUUsYUFBYSxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFO1NBQ2pEO1FBQ0Qsb0JBQW9CLEVBQUU7WUFDcEIsRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFLGFBQWEsRUFBRSxHQUFHLEVBQUU7WUFDbkQsRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFLGFBQWEsRUFBRSxHQUFHLEVBQUU7U0FDcEQ7UUFDRCxzQkFBc0IsRUFBRTtZQUN0QjtnQkFDRSxTQUFTLEVBQUUsZUFBZTtnQkFDMUIsU0FBUyxFQUFFO29CQUNULEVBQUUsYUFBYSxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFO2lCQUNqRDtnQkFDRCxVQUFVLEVBQUU7b0JBQ1YsY0FBYyxFQUFFLEtBQUs7aUJBQ3RCO2dCQUNELHFCQUFxQixFQUFFO29CQUNyQixpQkFBaUIsRUFBRSxDQUFDO29CQUNwQixrQkFBa0IsRUFBRSxDQUFDO2lCQUN0QjthQUNGO1NBQ0Y7UUFDRCxxQkFBcUIsRUFBRTtZQUNyQixpQkFBaUIsRUFBRSxDQUFDO1lBQ3BCLGtCQUFrQixFQUFFLENBQUM7U0FDdEI7S0FDRixDQUFDLENBQUM7SUFFSCxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDM0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsU0FBUyxFQUFFLENBQUMsQ0FBQztJQUU3Qyw4QkFBOEI7SUFDOUIsTUFBTSxJQUFBLHNDQUFvQixFQUN4QixFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxFQUNyRCxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsQ0FDekIsQ0FBQztBQUNKLENBQUM7QUFFRDs7R0FFRztBQUNILEtBQUssVUFBVSxtQkFBbUI7SUFDaEMsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDLFFBQVEsQ0FBQztJQUV2QyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixTQUFTLEVBQUUsQ0FBQyxDQUFDO0lBRTVDLE1BQU0sT0FBTyxHQUFHLElBQUksb0NBQWtCLENBQUM7UUFDckMsU0FBUyxFQUFFLFNBQVM7UUFDcEIsU0FBUyxFQUFFO1lBQ1QsRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUU7U0FDakQ7UUFDRCxvQkFBb0IsRUFBRTtZQUNwQixFQUFFLGFBQWEsRUFBRSxZQUFZLEVBQUUsYUFBYSxFQUFFLEdBQUcsRUFBRTtTQUNwRDtRQUNELHFCQUFxQixFQUFFO1lBQ3JCLGlCQUFpQixFQUFFLENBQUM7WUFDcEIsa0JBQWtCLEVBQUUsQ0FBQztTQUN0QjtLQUNGLENBQUMsQ0FBQztJQUVILE1BQU0sTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMzQixPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixTQUFTLEVBQUUsQ0FBQyxDQUFDO0lBRTdDLDhCQUE4QjtJQUM5QixNQUFNLElBQUEsc0NBQW9CLEVBQ3hCLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxFQUFFLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFLEVBQ3JELEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxDQUN6QixDQUFDO0FBQ0osQ0FBQztBQUVEOztHQUVHO0FBQ0gsS0FBSyxVQUFVLGdCQUFnQjtJQUM3QixNQUFNLFNBQVMsR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDO0lBRXBDLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLFNBQVMsRUFBRSxDQUFDLENBQUM7SUFFNUMsTUFBTSxPQUFPLEdBQUcsSUFBSSxvQ0FBa0IsQ0FBQztRQUNyQyxTQUFTLEVBQUUsU0FBUztRQUNwQixTQUFTLEVBQUU7WUFDVCxFQUFFLGFBQWEsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRTtTQUM5QztRQUNELG9CQUFvQixFQUFFO1lBQ3BCLEVBQUUsYUFBYSxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsR0FBRyxFQUFFO1lBQ2hELEVBQUUsYUFBYSxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUUsR0FBRyxFQUFFO1lBQ25ELEVBQUUsYUFBYSxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUUsR0FBRyxFQUFFO1NBQ3BEO1FBQ0Qsc0JBQXNCLEVBQUU7WUFDdEI7Z0JBQ0UsU0FBUyxFQUFFLGVBQWU7Z0JBQzFCLFNBQVMsRUFBRTtvQkFDVCxFQUFFLGFBQWEsRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRTtpQkFDakQ7Z0JBQ0QsVUFBVSxFQUFFO29CQUNWLGNBQWMsRUFBRSxLQUFLO2lCQUN0QjtnQkFDRCxxQkFBcUIsRUFBRTtvQkFDckIsaUJBQWlCLEVBQUUsQ0FBQztvQkFDcEIsa0JBQWtCLEVBQUUsQ0FBQztpQkFDdEI7YUFDRjtZQUNEO2dCQUNFLFNBQVMsRUFBRSxlQUFlO2dCQUMxQixTQUFTLEVBQUU7b0JBQ1QsRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUU7aUJBQ2pEO2dCQUNELFVBQVUsRUFBRTtvQkFDVixjQUFjLEVBQUUsS0FBSztpQkFDdEI7Z0JBQ0QscUJBQXFCLEVBQUU7b0JBQ3JCLGlCQUFpQixFQUFFLENBQUM7b0JBQ3BCLGtCQUFrQixFQUFFLENBQUM7aUJBQ3RCO2FBQ0Y7U0FDRjtRQUNELHFCQUFxQixFQUFFO1lBQ3JCLGlCQUFpQixFQUFFLENBQUM7WUFDcEIsa0JBQWtCLEVBQUUsQ0FBQztTQUN0QjtLQUNGLENBQUMsQ0FBQztJQUVILE1BQU0sTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMzQixPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixTQUFTLEVBQUUsQ0FBQyxDQUFDO0lBRTdDLDhCQUE4QjtJQUM5QixNQUFNLElBQUEsc0NBQW9CLEVBQ3hCLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxFQUFFLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFLEVBQ3JELEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxDQUN6QixDQUFDO0FBQ0osQ0FBQztBQUVEOztHQUVHO0FBQ0gsS0FBSyxVQUFVLGNBQWM7SUFDM0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDO0lBQ3BELElBQUksQ0FBQztRQUNILE1BQU0sV0FBVyxHQUFHLElBQUksbUNBQWlCLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDOUMsTUFBTSxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQy9CLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUNBQWlDLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztRQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLHVDQUF1QyxDQUFDLENBQUM7UUFDdkQsT0FBTyxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSx1QkFBdUIsQ0FBQyxDQUFDO1FBQ3ZGLE9BQU8sQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN6QyxPQUFPLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDcEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxxRUFBcUUsQ0FBQyxDQUFDO1FBQ3JGLE9BQU8sQ0FBQyxLQUFLLENBQUMsNERBQTRELENBQUMsQ0FBQztRQUM1RSxPQUFPLENBQUMsS0FBSyxDQUFDLDBFQUEwRSxDQUFDLENBQUM7UUFDMUYsT0FBTyxDQUFDLEtBQUssQ0FBQyx1REFBdUQsQ0FBQyxDQUFDO1FBQ3ZFLE1BQU0sSUFBSSxLQUFLLENBQUMsa0NBQWtDLENBQUMsQ0FBQztJQUN0RCxDQUFDO0FBQ0gsQ0FBQztBQUVEOztHQUVHO0FBQ0gsS0FBSyxVQUFVLGdCQUFnQixDQUFDLFFBQWlCLEtBQUs7SUFDcEQsSUFBSSxDQUFDO1FBQ0gsT0FBTyxDQUFDLEdBQUcsQ0FBQyx5Q0FBeUMsQ0FBQyxDQUFDO1FBRXZELHFDQUFxQztRQUNyQyxNQUFNLGNBQWMsRUFBRSxDQUFDO1FBRXZCLHVCQUF1QjtRQUN2QixNQUFNLFdBQVcsR0FBRyxJQUFJLG1DQUFpQixDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzlDLE1BQU0sVUFBVSxHQUFHLE1BQU0sTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNsRCxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixVQUFVLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxNQUFNLElBQUksQ0FBQyxDQUFDO1FBRWpGLHNDQUFzQztRQUN0QyxJQUFJLEtBQUssRUFBRSxDQUFDO1lBQ1YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDO1lBQzlELE1BQU0sbUJBQW1CLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2hELE1BQU0sbUJBQW1CLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2hELE1BQU0sbUJBQW1CLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzdDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbEIsQ0FBQztRQUVELHlDQUF5QztRQUN6QyxJQUFJLENBQUMsTUFBTSxXQUFXLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7WUFDN0MsTUFBTSxtQkFBbUIsRUFBRSxDQUFDO1FBQzlCLENBQUM7YUFBTSxDQUFDO1lBQ04sT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLFdBQVcsQ0FBQyxRQUFRLG9DQUFvQyxDQUFDLENBQUM7UUFDakYsQ0FBQztRQUVELElBQUksQ0FBQyxNQUFNLFdBQVcsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztZQUM3QyxNQUFNLG1CQUFtQixFQUFFLENBQUM7UUFDOUIsQ0FBQzthQUFNLENBQUM7WUFDTixPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsV0FBVyxDQUFDLFFBQVEsb0NBQW9DLENBQUMsQ0FBQztRQUNqRixDQUFDO1FBRUQsSUFBSSxDQUFDLE1BQU0sV0FBVyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQzFDLE1BQU0sZ0JBQWdCLEVBQUUsQ0FBQztRQUMzQixDQUFDO2FBQU0sQ0FBQztZQUNOLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxXQUFXLENBQUMsS0FBSyxvQ0FBb0MsQ0FBQyxDQUFDO1FBQzlFLENBQUM7UUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLHNDQUFzQyxDQUFDLENBQUM7UUFDcEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUM3QixPQUFPLENBQUMsR0FBRyxDQUFDLDhEQUE4RCxDQUFDLENBQUM7UUFDNUUsT0FBTyxDQUFDLEdBQUcsQ0FBQywyREFBMkQsQ0FBQyxDQUFDO1FBQ3pFLE9BQU8sQ0FBQyxHQUFHLENBQUMsMkRBQTJELENBQUMsQ0FBQztJQUMzRSxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsNEJBQTRCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbkQsTUFBTSxLQUFLLENBQUM7SUFDZCxDQUFDO0FBQ0gsQ0FBQztBQUVELCtCQUErQjtBQUMvQixNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNuQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7QUFFOUQscUJBQXFCO0FBQ3JCLGdCQUFnQixDQUFDLEtBQUssQ0FBQztLQUNwQixJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUMzQixLQUFLLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtJQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsOEJBQThCLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDckQsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNsQixDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogSW5pdGlhbGl6ZSBEeW5hbW9EQiBMb2NhbCB3aXRoIFRhYmxlc1xuICogQ3JlYXRlcyBhbGwgcmVxdWlyZWQgdGFibGVzIHdpdGggYXBwcm9wcmlhdGUgc2NoZW1hcyBhbmQgaW5kZXhlc1xuICovXG5cbmltcG9ydCB7XG4gIER5bmFtb0RCQ2xpZW50LFxuICBDcmVhdGVUYWJsZUNvbW1hbmQsXG4gIExpc3RUYWJsZXNDb21tYW5kLFxuICBEZWxldGVUYWJsZUNvbW1hbmQsXG4gIERlc2NyaWJlVGFibGVDb21tYW5kLFxuICB3YWl0VW50aWxUYWJsZUV4aXN0cyxcbn0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcblxuLy8gQ29uZmlndXJhdGlvbiBmb3IgbG9jYWwgRHluYW1vREJcbmNvbnN0IGNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7XG4gIHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB8fCAndXMtZWFzdC0xJyxcbiAgZW5kcG9pbnQ6IHByb2Nlc3MuZW52LkRZTkFNT0RCX0VORFBPSU5UIHx8ICdodHRwOi8vbG9jYWxob3N0OjgwMDInLFxuICBjcmVkZW50aWFsczoge1xuICAgIGFjY2Vzc0tleUlkOiBwcm9jZXNzLmVudi5BV1NfQUNDRVNTX0tFWV9JRCB8fCAnbG9jYWwnLFxuICAgIHNlY3JldEFjY2Vzc0tleTogcHJvY2Vzcy5lbnYuQVdTX1NFQ1JFVF9BQ0NFU1NfS0VZIHx8ICdsb2NhbCcsXG4gIH0sXG4gIHJlcXVlc3RIYW5kbGVyOiB7XG4gICAgcmVxdWVzdFRpbWVvdXQ6IDEwMDAwLCAvLyAxMCBzZWNvbmQgdGltZW91dCB0byBwcmV2ZW50IGhhbmdpbmdcbiAgfSxcbn0pO1xuXG5jb25zdCBUQUJMRV9OQU1FUyA9IHtcbiAgc3R1ZGVudHM6IHByb2Nlc3MuZW52LlNUVURFTlRTX1RBQkxFX05BTUUgfHwgJ2hvLXl1LXN0dWRlbnRzJyxcbiAgdGVhY2hlcnM6IHByb2Nlc3MuZW52LlRFQUNIRVJTX1RBQkxFX05BTUUgfHwgJ2hvLXl1LXRlYWNoZXJzJyxcbiAgZ2FtZXM6IHByb2Nlc3MuZW52LkdBTUVTX1RBQkxFX05BTUUgfHwgJ2hvLXl1LWdhbWVzJyxcbn07XG5cbi8qKlxuICogQ2hlY2sgaWYgYSB0YWJsZSBleGlzdHNcbiAqL1xuYXN5bmMgZnVuY3Rpb24gdGFibGVFeGlzdHModGFibGVOYW1lOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgdHJ5IHtcbiAgICBhd2FpdCBjbGllbnQuc2VuZChuZXcgRGVzY3JpYmVUYWJsZUNvbW1hbmQoeyBUYWJsZU5hbWU6IHRhYmxlTmFtZSB9KSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICBpZiAoZXJyb3IubmFtZSA9PT0gJ1Jlc291cmNlTm90Rm91bmRFeGNlcHRpb24nKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHRocm93IGVycm9yO1xuICB9XG59XG5cbi8qKlxuICogRGVsZXRlIGEgdGFibGUgaWYgaXQgZXhpc3RzXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGRlbGV0ZVRhYmxlSWZFeGlzdHModGFibGVOYW1lOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3QgZXhpc3RzID0gYXdhaXQgdGFibGVFeGlzdHModGFibGVOYW1lKTtcbiAgaWYgKGV4aXN0cykge1xuICAgIGNvbnNvbGUubG9nKGAgIERlbGV0aW5nIGV4aXN0aW5nIHRhYmxlOiAke3RhYmxlTmFtZX1gKTtcbiAgICBhd2FpdCBjbGllbnQuc2VuZChuZXcgRGVsZXRlVGFibGVDb21tYW5kKHsgVGFibGVOYW1lOiB0YWJsZU5hbWUgfSkpO1xuICAgIC8vIFdhaXQgYSBiaXQgZm9yIGRlbGV0aW9uIHRvIGNvbXBsZXRlXG4gICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDIwMDApKTtcbiAgfVxufVxuXG4vKipcbiAqIENyZWF0ZSBTdHVkZW50cyBUYWJsZVxuICovXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVTdHVkZW50c1RhYmxlKCk6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCB0YWJsZU5hbWUgPSBUQUJMRV9OQU1FUy5zdHVkZW50cztcbiAgXG4gIGNvbnNvbGUubG9nKGBDcmVhdGluZyB0YWJsZTogJHt0YWJsZU5hbWV9YCk7XG4gIFxuICBjb25zdCBjb21tYW5kID0gbmV3IENyZWF0ZVRhYmxlQ29tbWFuZCh7XG4gICAgVGFibGVOYW1lOiB0YWJsZU5hbWUsXG4gICAgS2V5U2NoZW1hOiBbXG4gICAgICB7IEF0dHJpYnV0ZU5hbWU6ICdzdHVkZW50X2lkJywgS2V5VHlwZTogJ0hBU0gnIH0sXG4gICAgXSxcbiAgICBBdHRyaWJ1dGVEZWZpbml0aW9uczogW1xuICAgICAgeyBBdHRyaWJ1dGVOYW1lOiAnc3R1ZGVudF9pZCcsIEF0dHJpYnV0ZVR5cGU6ICdTJyB9LFxuICAgICAgeyBBdHRyaWJ1dGVOYW1lOiAndGVhY2hlcl9pZCcsIEF0dHJpYnV0ZVR5cGU6ICdTJyB9LFxuICAgIF0sXG4gICAgR2xvYmFsU2Vjb25kYXJ5SW5kZXhlczogW1xuICAgICAge1xuICAgICAgICBJbmRleE5hbWU6ICd0ZWFjaGVyLWluZGV4JyxcbiAgICAgICAgS2V5U2NoZW1hOiBbXG4gICAgICAgICAgeyBBdHRyaWJ1dGVOYW1lOiAndGVhY2hlcl9pZCcsIEtleVR5cGU6ICdIQVNIJyB9LFxuICAgICAgICBdLFxuICAgICAgICBQcm9qZWN0aW9uOiB7XG4gICAgICAgICAgUHJvamVjdGlvblR5cGU6ICdBTEwnLFxuICAgICAgICB9LFxuICAgICAgICBQcm92aXNpb25lZFRocm91Z2hwdXQ6IHtcbiAgICAgICAgICBSZWFkQ2FwYWNpdHlVbml0czogNSxcbiAgICAgICAgICBXcml0ZUNhcGFjaXR5VW5pdHM6IDUsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIF0sXG4gICAgUHJvdmlzaW9uZWRUaHJvdWdocHV0OiB7XG4gICAgICBSZWFkQ2FwYWNpdHlVbml0czogNSxcbiAgICAgIFdyaXRlQ2FwYWNpdHlVbml0czogNSxcbiAgICB9LFxuICB9KTtcblxuICBhd2FpdCBjbGllbnQuc2VuZChjb21tYW5kKTtcbiAgY29uc29sZS5sb2coYOKckyBUYWJsZSBjcmVhdGVkOiAke3RhYmxlTmFtZX1gKTtcbiAgXG4gIC8vIFdhaXQgZm9yIHRhYmxlIHRvIGJlIGFjdGl2ZVxuICBhd2FpdCB3YWl0VW50aWxUYWJsZUV4aXN0cyhcbiAgICB7IGNsaWVudCwgbWF4V2FpdFRpbWU6IDYwLCBtaW5EZWxheTogMSwgbWF4RGVsYXk6IDUgfSxcbiAgICB7IFRhYmxlTmFtZTogdGFibGVOYW1lIH1cbiAgKTtcbn1cblxuLyoqXG4gKiBDcmVhdGUgVGVhY2hlcnMgVGFibGVcbiAqL1xuYXN5bmMgZnVuY3Rpb24gY3JlYXRlVGVhY2hlcnNUYWJsZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3QgdGFibGVOYW1lID0gVEFCTEVfTkFNRVMudGVhY2hlcnM7XG4gIFxuICBjb25zb2xlLmxvZyhgQ3JlYXRpbmcgdGFibGU6ICR7dGFibGVOYW1lfWApO1xuICBcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBDcmVhdGVUYWJsZUNvbW1hbmQoe1xuICAgIFRhYmxlTmFtZTogdGFibGVOYW1lLFxuICAgIEtleVNjaGVtYTogW1xuICAgICAgeyBBdHRyaWJ1dGVOYW1lOiAndGVhY2hlcl9pZCcsIEtleVR5cGU6ICdIQVNIJyB9LFxuICAgIF0sXG4gICAgQXR0cmlidXRlRGVmaW5pdGlvbnM6IFtcbiAgICAgIHsgQXR0cmlidXRlTmFtZTogJ3RlYWNoZXJfaWQnLCBBdHRyaWJ1dGVUeXBlOiAnUycgfSxcbiAgICBdLFxuICAgIFByb3Zpc2lvbmVkVGhyb3VnaHB1dDoge1xuICAgICAgUmVhZENhcGFjaXR5VW5pdHM6IDUsXG4gICAgICBXcml0ZUNhcGFjaXR5VW5pdHM6IDUsXG4gICAgfSxcbiAgfSk7XG5cbiAgYXdhaXQgY2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIGNvbnNvbGUubG9nKGDinJMgVGFibGUgY3JlYXRlZDogJHt0YWJsZU5hbWV9YCk7XG4gIFxuICAvLyBXYWl0IGZvciB0YWJsZSB0byBiZSBhY3RpdmVcbiAgYXdhaXQgd2FpdFVudGlsVGFibGVFeGlzdHMoXG4gICAgeyBjbGllbnQsIG1heFdhaXRUaW1lOiA2MCwgbWluRGVsYXk6IDEsIG1heERlbGF5OiA1IH0sXG4gICAgeyBUYWJsZU5hbWU6IHRhYmxlTmFtZSB9XG4gICk7XG59XG5cbi8qKlxuICogQ3JlYXRlIEdhbWVzIFRhYmxlXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUdhbWVzVGFibGUoKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IHRhYmxlTmFtZSA9IFRBQkxFX05BTUVTLmdhbWVzO1xuICBcbiAgY29uc29sZS5sb2coYENyZWF0aW5nIHRhYmxlOiAke3RhYmxlTmFtZX1gKTtcbiAgXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgQ3JlYXRlVGFibGVDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IHRhYmxlTmFtZSxcbiAgICBLZXlTY2hlbWE6IFtcbiAgICAgIHsgQXR0cmlidXRlTmFtZTogJ2dhbWVfaWQnLCBLZXlUeXBlOiAnSEFTSCcgfSxcbiAgICBdLFxuICAgIEF0dHJpYnV0ZURlZmluaXRpb25zOiBbXG4gICAgICB7IEF0dHJpYnV0ZU5hbWU6ICdnYW1lX2lkJywgQXR0cmlidXRlVHlwZTogJ1MnIH0sXG4gICAgICB7IEF0dHJpYnV0ZU5hbWU6ICd0ZWFjaGVyX2lkJywgQXR0cmlidXRlVHlwZTogJ1MnIH0sXG4gICAgICB7IEF0dHJpYnV0ZU5hbWU6ICdzdHVkZW50X2lkJywgQXR0cmlidXRlVHlwZTogJ1MnIH0sXG4gICAgXSxcbiAgICBHbG9iYWxTZWNvbmRhcnlJbmRleGVzOiBbXG4gICAgICB7XG4gICAgICAgIEluZGV4TmFtZTogJ3RlYWNoZXItaW5kZXgnLFxuICAgICAgICBLZXlTY2hlbWE6IFtcbiAgICAgICAgICB7IEF0dHJpYnV0ZU5hbWU6ICd0ZWFjaGVyX2lkJywgS2V5VHlwZTogJ0hBU0gnIH0sXG4gICAgICAgIF0sXG4gICAgICAgIFByb2plY3Rpb246IHtcbiAgICAgICAgICBQcm9qZWN0aW9uVHlwZTogJ0FMTCcsXG4gICAgICAgIH0sXG4gICAgICAgIFByb3Zpc2lvbmVkVGhyb3VnaHB1dDoge1xuICAgICAgICAgIFJlYWRDYXBhY2l0eVVuaXRzOiA1LFxuICAgICAgICAgIFdyaXRlQ2FwYWNpdHlVbml0czogNSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIEluZGV4TmFtZTogJ3N0dWRlbnQtaW5kZXgnLFxuICAgICAgICBLZXlTY2hlbWE6IFtcbiAgICAgICAgICB7IEF0dHJpYnV0ZU5hbWU6ICdzdHVkZW50X2lkJywgS2V5VHlwZTogJ0hBU0gnIH0sXG4gICAgICAgIF0sXG4gICAgICAgIFByb2plY3Rpb246IHtcbiAgICAgICAgICBQcm9qZWN0aW9uVHlwZTogJ0FMTCcsXG4gICAgICAgIH0sXG4gICAgICAgIFByb3Zpc2lvbmVkVGhyb3VnaHB1dDoge1xuICAgICAgICAgIFJlYWRDYXBhY2l0eVVuaXRzOiA1LFxuICAgICAgICAgIFdyaXRlQ2FwYWNpdHlVbml0czogNSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgXSxcbiAgICBQcm92aXNpb25lZFRocm91Z2hwdXQ6IHtcbiAgICAgIFJlYWRDYXBhY2l0eVVuaXRzOiA1LFxuICAgICAgV3JpdGVDYXBhY2l0eVVuaXRzOiA1LFxuICAgIH0sXG4gIH0pO1xuXG4gIGF3YWl0IGNsaWVudC5zZW5kKGNvbW1hbmQpO1xuICBjb25zb2xlLmxvZyhg4pyTIFRhYmxlIGNyZWF0ZWQ6ICR7dGFibGVOYW1lfWApO1xuICBcbiAgLy8gV2FpdCBmb3IgdGFibGUgdG8gYmUgYWN0aXZlXG4gIGF3YWl0IHdhaXRVbnRpbFRhYmxlRXhpc3RzKFxuICAgIHsgY2xpZW50LCBtYXhXYWl0VGltZTogNjAsIG1pbkRlbGF5OiAxLCBtYXhEZWxheTogNSB9LFxuICAgIHsgVGFibGVOYW1lOiB0YWJsZU5hbWUgfVxuICApO1xufVxuXG4vKipcbiAqIFRlc3QgRHluYW1vREIgY29ubmVjdGlvblxuICovXG5hc3luYyBmdW5jdGlvbiB0ZXN0Q29ubmVjdGlvbigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc29sZS5sb2coJ1Rlc3RpbmcgRHluYW1vREIgTG9jYWwgY29ubmVjdGlvbi4uLicpO1xuICB0cnkge1xuICAgIGNvbnN0IGxpc3RDb21tYW5kID0gbmV3IExpc3RUYWJsZXNDb21tYW5kKHt9KTtcbiAgICBhd2FpdCBjbGllbnQuc2VuZChsaXN0Q29tbWFuZCk7XG4gICAgY29uc29sZS5sb2coJ+KckyBDb25uZWN0ZWQgdG8gRHluYW1vREIgTG9jYWxcXG4nKTtcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgIGNvbnNvbGUuZXJyb3IoJ+KclyBGYWlsZWQgdG8gY29ubmVjdCB0byBEeW5hbW9EQiBMb2NhbCcpO1xuICAgIGNvbnNvbGUuZXJyb3IoJyAgRW5kcG9pbnQ6JywgcHJvY2Vzcy5lbnYuRFlOQU1PREJfRU5EUE9JTlQgfHwgJ2h0dHA6Ly9sb2NhbGhvc3Q6ODAwMicpO1xuICAgIGNvbnNvbGUuZXJyb3IoJyAgRXJyb3I6JywgZXJyb3IubWVzc2FnZSk7XG4gICAgY29uc29sZS5lcnJvcignXFxuVHJvdWJsZXNob290aW5nOicpO1xuICAgIGNvbnNvbGUuZXJyb3IoJyAgMS4gTWFrZSBzdXJlIER5bmFtb0RCIExvY2FsIGlzIHJ1bm5pbmc6IGRvY2tlciBwcyB8IGdyZXAgZHluYW1vZGInKTtcbiAgICBjb25zb2xlLmVycm9yKCcgIDIuIENoZWNrIER5bmFtb0RCIGxvZ3M6IGRvY2tlciBsb2dzIGhvLXl1LWR5bmFtb2RiLWxvY2FsJyk7XG4gICAgY29uc29sZS5lcnJvcignICAzLiBSZXN0YXJ0IGNvbnRhaW5lcnM6IG5wbSBydW4gZHluYW1vZGI6ZG93biAmJiBucG0gcnVuIGR5bmFtb2RiOnN0YXJ0Jyk7XG4gICAgY29uc29sZS5lcnJvcignICA0LiBXYWl0IGEgZmV3IG1vcmUgc2Vjb25kcyBmb3IgRHluYW1vREIgdG8gYmUgcmVhZHknKTtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBjb25uZWN0IHRvIER5bmFtb0RCIExvY2FsJyk7XG4gIH1cbn1cblxuLyoqXG4gKiBNYWluIGZ1bmN0aW9uIHRvIGluaXRpYWxpemUgYWxsIHRhYmxlc1xuICovXG5hc3luYyBmdW5jdGlvbiBpbml0aWFsaXplVGFibGVzKHJlc2V0OiBib29sZWFuID0gZmFsc2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgdHJ5IHtcbiAgICBjb25zb2xlLmxvZygnSW5pdGlhbGl6aW5nIER5bmFtb0RCIExvY2FsIHRhYmxlcy4uLlxcbicpO1xuICAgIFxuICAgIC8vIFRlc3QgY29ubmVjdGlvbiBmaXJzdCB0byBmYWlsIGZhc3RcbiAgICBhd2FpdCB0ZXN0Q29ubmVjdGlvbigpO1xuXG4gICAgLy8gTGlzdCBleGlzdGluZyB0YWJsZXNcbiAgICBjb25zdCBsaXN0Q29tbWFuZCA9IG5ldyBMaXN0VGFibGVzQ29tbWFuZCh7fSk7XG4gICAgY29uc3QgbGlzdFJlc3VsdCA9IGF3YWl0IGNsaWVudC5zZW5kKGxpc3RDb21tYW5kKTtcbiAgICBjb25zb2xlLmxvZyhgRXhpc3RpbmcgdGFibGVzOiAke2xpc3RSZXN1bHQuVGFibGVOYW1lcz8uam9pbignLCAnKSB8fCAnbm9uZSd9XFxuYCk7XG5cbiAgICAvLyBEZWxldGUgdGFibGVzIGlmIHJlc2V0IGlzIHJlcXVlc3RlZFxuICAgIGlmIChyZXNldCkge1xuICAgICAgY29uc29sZS5sb2coJ1Jlc2V0dGluZyB0YWJsZXMgKGRlbGV0aW5nIGV4aXN0aW5nIHRhYmxlcykuLi4nKTtcbiAgICAgIGF3YWl0IGRlbGV0ZVRhYmxlSWZFeGlzdHMoVEFCTEVfTkFNRVMuc3R1ZGVudHMpO1xuICAgICAgYXdhaXQgZGVsZXRlVGFibGVJZkV4aXN0cyhUQUJMRV9OQU1FUy50ZWFjaGVycyk7XG4gICAgICBhd2FpdCBkZWxldGVUYWJsZUlmRXhpc3RzKFRBQkxFX05BTUVTLmdhbWVzKTtcbiAgICAgIGNvbnNvbGUubG9nKCcnKTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgdGFibGVzIG9ubHkgaWYgdGhleSBkb24ndCBleGlzdFxuICAgIGlmICghYXdhaXQgdGFibGVFeGlzdHMoVEFCTEVfTkFNRVMuc3R1ZGVudHMpKSB7XG4gICAgICBhd2FpdCBjcmVhdGVTdHVkZW50c1RhYmxlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKGBUYWJsZSAke1RBQkxFX05BTUVTLnN0dWRlbnRzfSBhbHJlYWR5IGV4aXN0cywgc2tpcHBpbmcgY3JlYXRpb25gKTtcbiAgICB9XG5cbiAgICBpZiAoIWF3YWl0IHRhYmxlRXhpc3RzKFRBQkxFX05BTUVTLnRlYWNoZXJzKSkge1xuICAgICAgYXdhaXQgY3JlYXRlVGVhY2hlcnNUYWJsZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmxvZyhgVGFibGUgJHtUQUJMRV9OQU1FUy50ZWFjaGVyc30gYWxyZWFkeSBleGlzdHMsIHNraXBwaW5nIGNyZWF0aW9uYCk7XG4gICAgfVxuXG4gICAgaWYgKCFhd2FpdCB0YWJsZUV4aXN0cyhUQUJMRV9OQU1FUy5nYW1lcykpIHtcbiAgICAgIGF3YWl0IGNyZWF0ZUdhbWVzVGFibGUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coYFRhYmxlICR7VEFCTEVfTkFNRVMuZ2FtZXN9IGFscmVhZHkgZXhpc3RzLCBza2lwcGluZyBjcmVhdGlvbmApO1xuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKCdcXG7inJMgQWxsIHRhYmxlcyBjcmVhdGVkIHN1Y2Nlc3NmdWxseSEnKTtcbiAgICBjb25zb2xlLmxvZygnXFxuTmV4dCBzdGVwczonKTtcbiAgICBjb25zb2xlLmxvZygnICAxLiBSdW4gc2VlZCBzY3JpcHQgdG8gcG9wdWxhdGUgZGF0YTogbnBtIHJ1biBkeW5hbW9kYjpzZWVkJyk7XG4gICAgY29uc29sZS5sb2coJyAgMi4gVmlldyB0YWJsZXMgaW4gRHluYW1vREIgQWRtaW46IGh0dHA6Ly9sb2NhbGhvc3Q6ODAwMScpO1xuICAgIGNvbnNvbGUubG9nKCcgIDMuIFN0YXJ0IHVzaW5nIHRoZSBsb2NhbCBEeW5hbW9EQiBpbiB5b3VyIGFwcGxpY2F0aW9uXFxuJyk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW5pdGlhbGl6aW5nIHRhYmxlczonLCBlcnJvcik7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbn1cblxuLy8gUGFyc2UgY29tbWFuZCBsaW5lIGFyZ3VtZW50c1xuY29uc3QgYXJncyA9IHByb2Nlc3MuYXJndi5zbGljZSgyKTtcbmNvbnN0IHJlc2V0ID0gYXJncy5pbmNsdWRlcygnLS1yZXNldCcpIHx8IGFyZ3MuaW5jbHVkZXMoJy1yJyk7XG5cbi8vIFJ1biBpbml0aWFsaXphdGlvblxuaW5pdGlhbGl6ZVRhYmxlcyhyZXNldClcbiAgLnRoZW4oKCkgPT4gcHJvY2Vzcy5leGl0KDApKVxuICAuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGluaXRpYWxpemUgdGFibGVzOicsIGVycm9yKTtcbiAgICBwcm9jZXNzLmV4aXQoMSk7XG4gIH0pO1xuIl19