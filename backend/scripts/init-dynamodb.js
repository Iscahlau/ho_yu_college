"use strict";
/**
 * Initialize DynamoDB Local with Tables
 * Creates all required tables with appropriate schemas and indexes
 */
Object.defineProperty(exports, "__esModule", { value: true });
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
// Configuration for local DynamoDB
const client = new client_dynamodb_1.DynamoDBClient({
    region: process.env.AWS_REGION || 'us-east-1',
    endpoint: process.env.DYNAMODB_ENDPOINT || 'http://localhost:8002',
    credentials: {
        accessKeyId: process.env.AWS_ACCESS_KEY_ID || 'local',
        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY || 'local',
    },
});
const TABLE_NAMES = {
    students: process.env.STUDENTS_TABLE_NAME || 'ho-yu-students',
    teachers: process.env.TEACHERS_TABLE_NAME || 'ho-yu-teachers',
    games: process.env.GAMES_TABLE_NAME || 'ho-yu-games',
};
/**
 * Check if a table exists
 */
async function tableExists(tableName) {
    try {
        await client.send(new client_dynamodb_1.DescribeTableCommand({ TableName: tableName }));
        return true;
    }
    catch (error) {
        if (error.name === 'ResourceNotFoundException') {
            return false;
        }
        throw error;
    }
}
/**
 * Delete a table if it exists
 */
async function deleteTableIfExists(tableName) {
    const exists = await tableExists(tableName);
    if (exists) {
        console.log(`  Deleting existing table: ${tableName}`);
        await client.send(new client_dynamodb_1.DeleteTableCommand({ TableName: tableName }));
        // Wait a bit for deletion to complete
        await new Promise(resolve => setTimeout(resolve, 2000));
    }
}
/**
 * Create Students Table
 */
async function createStudentsTable() {
    const tableName = TABLE_NAMES.students;
    console.log(`Creating table: ${tableName}`);
    const command = new client_dynamodb_1.CreateTableCommand({
        TableName: tableName,
        KeySchema: [
            { AttributeName: 'student_id', KeyType: 'HASH' },
        ],
        AttributeDefinitions: [
            { AttributeName: 'student_id', AttributeType: 'S' },
            { AttributeName: 'teacher_id', AttributeType: 'S' },
        ],
        GlobalSecondaryIndexes: [
            {
                IndexName: 'teacher-index',
                KeySchema: [
                    { AttributeName: 'teacher_id', KeyType: 'HASH' },
                ],
                Projection: {
                    ProjectionType: 'ALL',
                },
                ProvisionedThroughput: {
                    ReadCapacityUnits: 5,
                    WriteCapacityUnits: 5,
                },
            },
        ],
        ProvisionedThroughput: {
            ReadCapacityUnits: 5,
            WriteCapacityUnits: 5,
        },
    });
    await client.send(command);
    console.log(`✓ Table created: ${tableName}`);
    // Wait for table to be active
    await (0, client_dynamodb_1.waitUntilTableExists)({ client, maxWaitTime: 60, minDelay: 1, maxDelay: 5 }, { TableName: tableName });
}
/**
 * Create Teachers Table
 */
async function createTeachersTable() {
    const tableName = TABLE_NAMES.teachers;
    console.log(`Creating table: ${tableName}`);
    const command = new client_dynamodb_1.CreateTableCommand({
        TableName: tableName,
        KeySchema: [
            { AttributeName: 'teacher_id', KeyType: 'HASH' },
        ],
        AttributeDefinitions: [
            { AttributeName: 'teacher_id', AttributeType: 'S' },
        ],
        ProvisionedThroughput: {
            ReadCapacityUnits: 5,
            WriteCapacityUnits: 5,
        },
    });
    await client.send(command);
    console.log(`✓ Table created: ${tableName}`);
    // Wait for table to be active
    await (0, client_dynamodb_1.waitUntilTableExists)({ client, maxWaitTime: 60, minDelay: 1, maxDelay: 5 }, { TableName: tableName });
}
/**
 * Create Games Table
 */
async function createGamesTable() {
    const tableName = TABLE_NAMES.games;
    console.log(`Creating table: ${tableName}`);
    const command = new client_dynamodb_1.CreateTableCommand({
        TableName: tableName,
        KeySchema: [
            { AttributeName: 'game_id', KeyType: 'HASH' },
        ],
        AttributeDefinitions: [
            { AttributeName: 'game_id', AttributeType: 'S' },
            { AttributeName: 'teacher_id', AttributeType: 'S' },
            { AttributeName: 'student_id', AttributeType: 'S' },
        ],
        GlobalSecondaryIndexes: [
            {
                IndexName: 'teacher-index',
                KeySchema: [
                    { AttributeName: 'teacher_id', KeyType: 'HASH' },
                ],
                Projection: {
                    ProjectionType: 'ALL',
                },
                ProvisionedThroughput: {
                    ReadCapacityUnits: 5,
                    WriteCapacityUnits: 5,
                },
            },
            {
                IndexName: 'student-index',
                KeySchema: [
                    { AttributeName: 'student_id', KeyType: 'HASH' },
                ],
                Projection: {
                    ProjectionType: 'ALL',
                },
                ProvisionedThroughput: {
                    ReadCapacityUnits: 5,
                    WriteCapacityUnits: 5,
                },
            },
        ],
        ProvisionedThroughput: {
            ReadCapacityUnits: 5,
            WriteCapacityUnits: 5,
        },
    });
    await client.send(command);
    console.log(`✓ Table created: ${tableName}`);
    // Wait for table to be active
    await (0, client_dynamodb_1.waitUntilTableExists)({ client, maxWaitTime: 60, minDelay: 1, maxDelay: 5 }, { TableName: tableName });
}
/**
 * Main function to initialize all tables
 */
async function initializeTables(reset = false) {
    try {
        console.log('Initializing DynamoDB Local tables...\n');
        // List existing tables
        const listCommand = new client_dynamodb_1.ListTablesCommand({});
        const listResult = await client.send(listCommand);
        console.log(`Existing tables: ${listResult.TableNames?.join(', ') || 'none'}\n`);
        // Delete tables if reset is requested
        if (reset) {
            console.log('Resetting tables (deleting existing tables)...');
            await deleteTableIfExists(TABLE_NAMES.students);
            await deleteTableIfExists(TABLE_NAMES.teachers);
            await deleteTableIfExists(TABLE_NAMES.games);
            console.log('');
        }
        // Create tables
        await createStudentsTable();
        await createTeachersTable();
        await createGamesTable();
        console.log('\n✓ All tables created successfully!');
        console.log('\nNext steps:');
        console.log('  1. Run seed script to populate data: npm run dynamodb:seed');
        console.log('  2. View tables in DynamoDB Admin: http://localhost:8001');
        console.log('  3. Start using the local DynamoDB in your application\n');
    }
    catch (error) {
        console.error('Error initializing tables:', error);
        throw error;
    }
}
// Parse command line arguments
const args = process.argv.slice(2);
const reset = args.includes('--reset') || args.includes('-r');
// Run initialization
initializeTables(reset)
    .then(() => process.exit(0))
    .catch((error) => {
    console.error('Failed to initialize tables:', error);
    process.exit(1);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5pdC1keW5hbW9kYi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImluaXQtZHluYW1vZGIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7QUFFSCw4REFPa0M7QUFFbEMsbUNBQW1DO0FBQ25DLE1BQU0sTUFBTSxHQUFHLElBQUksZ0NBQWMsQ0FBQztJQUNoQyxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksV0FBVztJQUM3QyxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSx1QkFBdUI7SUFDbEUsV0FBVyxFQUFFO1FBQ1gsV0FBVyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLElBQUksT0FBTztRQUNyRCxlQUFlLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsSUFBSSxPQUFPO0tBQzlEO0NBQ0YsQ0FBQyxDQUFDO0FBRUgsTUFBTSxXQUFXLEdBQUc7SUFDbEIsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLElBQUksZ0JBQWdCO0lBQzdELFFBQVEsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLGdCQUFnQjtJQUM3RCxLQUFLLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsSUFBSSxhQUFhO0NBQ3JELENBQUM7QUFFRjs7R0FFRztBQUNILEtBQUssVUFBVSxXQUFXLENBQUMsU0FBaUI7SUFDMUMsSUFBSSxDQUFDO1FBQ0gsTUFBTSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksc0NBQW9CLENBQUMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3RFLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7UUFDcEIsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLDJCQUEyQixFQUFFLENBQUM7WUFDL0MsT0FBTyxLQUFLLENBQUM7UUFD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LFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBRTlELHFCQUFxQjtBQUNyQixnQkFBZ0IsQ0FBQyxLQUFLLENBQUM7S0FDcEIsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDM0IsS0FBSyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUU7SUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLDhCQUE4QixFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3JELE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDbEIsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEluaXRpYWxpemUgRHluYW1vREIgTG9jYWwgd2l0aCBUYWJsZXNcbiAqIENyZWF0ZXMgYWxsIHJlcXVpcmVkIHRhYmxlcyB3aXRoIGFwcHJvcHJpYXRlIHNjaGVtYXMgYW5kIGluZGV4ZXNcbiAqL1xuXG5pbXBvcnQge1xuICBEeW5hbW9EQkNsaWVudCxcbiAgQ3JlYXRlVGFibGVDb21tYW5kLFxuICBMaXN0VGFibGVzQ29tbWFuZCxcbiAgRGVsZXRlVGFibGVDb21tYW5kLFxuICBEZXNjcmliZVRhYmxlQ29tbWFuZCxcbiAgd2FpdFVudGlsVGFibGVFeGlzdHMsXG59IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5cbi8vIENvbmZpZ3VyYXRpb24gZm9yIGxvY2FsIER5bmFtb0RCXG5jb25zdCBjbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe1xuICByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgJ3VzLWVhc3QtMScsXG4gIGVuZHBvaW50OiBwcm9jZXNzLmVudi5EWU5BTU9EQl9FTkRQT0lOVCB8fCAnaHR0cDovL2xvY2FsaG9zdDo4MDAyJyxcbiAgY3JlZGVudGlhbHM6IHtcbiAgICBhY2Nlc3NLZXlJZDogcHJvY2Vzcy5lbnYuQVdTX0FDQ0VTU19LRVlfSUQgfHwgJ2xvY2FsJyxcbiAgICBzZWNyZXRBY2Nlc3NLZXk6IHByb2Nlc3MuZW52LkFXU19TRUNSRVRfQUNDRVNTX0tFWSB8fCAnbG9jYWwnLFxuICB9LFxufSk7XG5cbmNvbnN0IFRBQkxFX05BTUVTID0ge1xuICBzdHVkZW50czogcHJvY2Vzcy5lbnYuU1RVREVOVFNfVEFCTEVfTkFNRSB8fCAnaG8teXUtc3R1ZGVudHMnLFxuICB0ZWFjaGVyczogcHJvY2Vzcy5lbnYuVEVBQ0hFUlNfVEFCTEVfTkFNRSB8fCAnaG8teXUtdGVhY2hlcnMnLFxuICBnYW1lczogcHJvY2Vzcy5lbnYuR0FNRVNfVEFCTEVfTkFNRSB8fCAnaG8teXUtZ2FtZXMnLFxufTtcblxuLyoqXG4gKiBDaGVjayBpZiBhIHRhYmxlIGV4aXN0c1xuICovXG5hc3luYyBmdW5jdGlvbiB0YWJsZUV4aXN0cyh0YWJsZU5hbWU6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICB0cnkge1xuICAgIGF3YWl0IGNsaWVudC5zZW5kKG5ldyBEZXNjcmliZVRhYmxlQ29tbWFuZCh7IFRhYmxlTmFtZTogdGFibGVOYW1lIH0pKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgIGlmIChlcnJvci5uYW1lID09PSAnUmVzb3VyY2VOb3RGb3VuZEV4Y2VwdGlvbicpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbn1cblxuLyoqXG4gKiBEZWxldGUgYSB0YWJsZSBpZiBpdCBleGlzdHNcbiAqL1xuYXN5bmMgZnVuY3Rpb24gZGVsZXRlVGFibGVJZkV4aXN0cyh0YWJsZU5hbWU6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCBleGlzdHMgPSBhd2FpdCB0YWJsZUV4aXN0cyh0YWJsZU5hbWUpO1xuICBpZiAoZXhpc3RzKSB7XG4gICAgY29uc29sZS5sb2coYCAgRGVsZXRpbmcgZXhpc3RpbmcgdGFibGU6ICR7dGFibGVOYW1lfWApO1xuICAgIGF3YWl0IGNsaWVudC5zZW5kKG5ldyBEZWxldGVUYWJsZUNvbW1hbmQoeyBUYWJsZU5hbWU6IHRhYmxlTmFtZSB9KSk7XG4gICAgLy8gV2FpdCBhIGJpdCBmb3IgZGVsZXRpb24gdG8gY29tcGxldGVcbiAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMjAwMCkpO1xuICB9XG59XG5cbi8qKlxuICogQ3JlYXRlIFN0dWRlbnRzIFRhYmxlXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVN0dWRlbnRzVGFibGUoKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IHRhYmxlTmFtZSA9IFRBQkxFX05BTUVTLnN0dWRlbnRzO1xuICBcbiAgY29uc29sZS5sb2coYENyZWF0aW5nIHRhYmxlOiAke3RhYmxlTmFtZX1gKTtcbiAgXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgQ3JlYXRlVGFibGVDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IHRhYmxlTmFtZSxcbiAgICBLZXlTY2hlbWE6IFtcbiAgICAgIHsgQXR0cmlidXRlTmFtZTogJ3N0dWRlbnRfaWQnLCBLZXlUeXBlOiAnSEFTSCcgfSxcbiAgICBdLFxuICAgIEF0dHJpYnV0ZURlZmluaXRpb25zOiBbXG4gICAgICB7IEF0dHJpYnV0ZU5hbWU6ICdzdHVkZW50X2lkJywgQXR0cmlidXRlVHlwZTogJ1MnIH0sXG4gICAgICB7IEF0dHJpYnV0ZU5hbWU6ICd0ZWFjaGVyX2lkJywgQXR0cmlidXRlVHlwZTogJ1MnIH0sXG4gICAgXSxcbiAgICBHbG9iYWxTZWNvbmRhcnlJbmRleGVzOiBbXG4gICAgICB7XG4gICAgICAgIEluZGV4TmFtZTogJ3RlYWNoZXItaW5kZXgnLFxuICAgICAgICBLZXlTY2hlbWE6IFtcbiAgICAgICAgICB7IEF0dHJpYnV0ZU5hbWU6ICd0ZWFjaGVyX2lkJywgS2V5VHlwZTogJ0hBU0gnIH0sXG4gICAgICAgIF0sXG4gICAgICAgIFByb2plY3Rpb246IHtcbiAgICAgICAgICBQcm9qZWN0aW9uVHlwZTogJ0FMTCcsXG4gICAgICAgIH0sXG4gICAgICAgIFByb3Zpc2lvbmVkVGhyb3VnaHB1dDoge1xuICAgICAgICAgIFJlYWRDYXBhY2l0eVVuaXRzOiA1LFxuICAgICAgICAgIFdyaXRlQ2FwYWNpdHlVbml0czogNSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgXSxcbiAgICBQcm92aXNpb25lZFRocm91Z2hwdXQ6IHtcbiAgICAgIFJlYWRDYXBhY2l0eVVuaXRzOiA1LFxuICAgICAgV3JpdGVDYXBhY2l0eVVuaXRzOiA1LFxuICAgIH0sXG4gIH0pO1xuXG4gIGF3YWl0IGNsaWVudC5zZW5kKGNvbW1hbmQpO1xuICBjb25zb2xlLmxvZyhg4pyTIFRhYmxlIGNyZWF0ZWQ6ICR7dGFibGVOYW1lfWApO1xuICBcbiAgLy8gV2FpdCBmb3IgdGFibGUgdG8gYmUgYWN0aXZlXG4gIGF3YWl0IHdhaXRVbnRpbFRhYmxlRXhpc3RzKFxuICAgIHsgY2xpZW50LCBtYXhXYWl0VGltZTogNjAsIG1pbkRlbGF5OiAxLCBtYXhEZWxheTogNSB9LFxuICAgIHsgVGFibGVOYW1lOiB0YWJsZU5hbWUgfVxuICApO1xufVxuXG4vKipcbiAqIENyZWF0ZSBUZWFjaGVycyBUYWJsZVxuICovXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVUZWFjaGVyc1RhYmxlKCk6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCB0YWJsZU5hbWUgPSBUQUJMRV9OQU1FUy50ZWFjaGVycztcbiAgXG4gIGNvbnNvbGUubG9nKGBDcmVhdGluZyB0YWJsZTogJHt0YWJsZU5hbWV9YCk7XG4gIFxuICBjb25zdCBjb21tYW5kID0gbmV3IENyZWF0ZVRhYmxlQ29tbWFuZCh7XG4gICAgVGFibGVOYW1lOiB0YWJsZU5hbWUsXG4gICAgS2V5U2NoZW1hOiBbXG4gICAgICB7IEF0dHJpYnV0ZU5hbWU6ICd0ZWFjaGVyX2lkJywgS2V5VHlwZTogJ0hBU0gnIH0sXG4gICAgXSxcbiAgICBBdHRyaWJ1dGVEZWZpbml0aW9uczogW1xuICAgICAgeyBBdHRyaWJ1dGVOYW1lOiAndGVhY2hlcl9pZCcsIEF0dHJpYnV0ZVR5cGU6ICdTJyB9LFxuICAgIF0sXG4gICAgUHJvdmlzaW9uZWRUaHJvdWdocHV0OiB7XG4gICAgICBSZWFkQ2FwYWNpdHlVbml0czogNSxcbiAgICAgIFdyaXRlQ2FwYWNpdHlVbml0czogNSxcbiAgICB9LFxuICB9KTtcblxuICBhd2FpdCBjbGllbnQuc2VuZChjb21tYW5kKTtcbiAgY29uc29sZS5sb2coYOKckyBUYWJsZSBjcmVhdGVkOiAke3RhYmxlTmFtZX1gKTtcbiAgXG4gIC8vIFdhaXQgZm9yIHRhYmxlIHRvIGJlIGFjdGl2ZVxuICBhd2FpdCB3YWl0VW50aWxUYWJsZUV4aXN0cyhcbiAgICB7IGNsaWVudCwgbWF4V2FpdFRpbWU6IDYwLCBtaW5EZWxheTogMSwgbWF4RGVsYXk6IDUgfSxcbiAgICB7IFRhYmxlTmFtZTogdGFibGVOYW1lIH1cbiAgKTtcbn1cblxuLyoqXG4gKiBDcmVhdGUgR2FtZXMgVGFibGVcbiAqL1xuYXN5bmMgZnVuY3Rpb24gY3JlYXRlR2FtZXNUYWJsZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3QgdGFibGVOYW1lID0gVEFCTEVfTkFNRVMuZ2FtZXM7XG4gIFxuICBjb25zb2xlLmxvZyhgQ3JlYXRpbmcgdGFibGU6ICR7dGFibGVOYW1lfWApO1xuICBcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBDcmVhdGVUYWJsZUNvbW1hbmQoe1xuICAgIFRhYmxlTmFtZTogdGFibGVOYW1lLFxuICAgIEtleVNjaGVtYTogW1xuICAgICAgeyBBdHRyaWJ1dGVOYW1lOiAnZ2FtZV9pZCcsIEtleVR5cGU6ICdIQVNIJyB9LFxuICAgIF0sXG4gICAgQXR0cmlidXRlRGVmaW5pdGlvbnM6IFtcbiAgICAgIHsgQXR0cmlidXRlTmFtZTogJ2dhbWVfaWQnLCBBdHRyaWJ1dGVUeXBlOiAnUycgfSxcbiAgICAgIHsgQXR0cmlidXRlTmFtZTogJ3RlYWNoZXJfaWQnLCBBdHRyaWJ1dGVUeXBlOiAnUycgfSxcbiAgICAgIHsgQXR0cmlidXRlTmFtZTogJ3N0dWRlbnRfaWQnLCBBdHRyaWJ1dGVUeXBlOiAnUycgfSxcbiAgICBdLFxuICAgIEdsb2JhbFNlY29uZGFyeUluZGV4ZXM6IFtcbiAgICAgIHtcbiAgICAgICAgSW5kZXhOYW1lOiAndGVhY2hlci1pbmRleCcsXG4gICAgICAgIEtleVNjaGVtYTogW1xuICAgICAgICAgIHsgQXR0cmlidXRlTmFtZTogJ3RlYWNoZXJfaWQnLCBLZXlUeXBlOiAnSEFTSCcgfSxcbiAgICAgICAgXSxcbiAgICAgICAgUHJvamVjdGlvbjoge1xuICAgICAgICAgIFByb2plY3Rpb25UeXBlOiAnQUxMJyxcbiAgICAgICAgfSxcbiAgICAgICAgUHJvdmlzaW9uZWRUaHJvdWdocHV0OiB7XG4gICAgICAgICAgUmVhZENhcGFjaXR5VW5pdHM6IDUsXG4gICAgICAgICAgV3JpdGVDYXBhY2l0eVVuaXRzOiA1LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgSW5kZXhOYW1lOiAnc3R1ZGVudC1pbmRleCcsXG4gICAgICAgIEtleVNjaGVtYTogW1xuICAgICAgICAgIHsgQXR0cmlidXRlTmFtZTogJ3N0dWRlbnRfaWQnLCBLZXlUeXBlOiAnSEFTSCcgfSxcbiAgICAgICAgXSxcbiAgICAgICAgUHJvamVjdGlvbjoge1xuICAgICAgICAgIFByb2plY3Rpb25UeXBlOiAnQUxMJyxcbiAgICAgICAgfSxcbiAgICAgICAgUHJvdmlzaW9uZWRUaHJvdWdocHV0OiB7XG4gICAgICAgICAgUmVhZENhcGFjaXR5VW5pdHM6IDUsXG4gICAgICAgICAgV3JpdGVDYXBhY2l0eVVuaXRzOiA1LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICBdLFxuICAgIFByb3Zpc2lvbmVkVGhyb3VnaHB1dDoge1xuICAgICAgUmVhZENhcGFjaXR5VW5pdHM6IDUsXG4gICAgICBXcml0ZUNhcGFjaXR5VW5pdHM6IDUsXG4gICAgfSxcbiAgfSk7XG5cbiAgYXdhaXQgY2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIGNvbnNvbGUubG9nKGDinJMgVGFibGUgY3JlYXRlZDogJHt0YWJsZU5hbWV9YCk7XG4gIFxuICAvLyBXYWl0IGZvciB0YWJsZSB0byBiZSBhY3RpdmVcbiAgYXdhaXQgd2FpdFVudGlsVGFibGVFeGlzdHMoXG4gICAgeyBjbGllbnQsIG1heFdhaXRUaW1lOiA2MCwgbWluRGVsYXk6IDEsIG1heERlbGF5OiA1IH0sXG4gICAgeyBUYWJsZU5hbWU6IHRhYmxlTmFtZSB9XG4gICk7XG59XG5cbi8qKlxuICogTWFpbiBmdW5jdGlvbiB0byBpbml0aWFsaXplIGFsbCB0YWJsZXNcbiAqL1xuYXN5bmMgZnVuY3Rpb24gaW5pdGlhbGl6ZVRhYmxlcyhyZXNldDogYm9vbGVhbiA9IGZhbHNlKTogUHJvbWlzZTx2b2lkPiB7XG4gIHRyeSB7XG4gICAgY29uc29sZS5sb2coJ0luaXRpYWxpemluZyBEeW5hbW9EQiBMb2NhbCB0YWJsZXMuLi5cXG4nKTtcbiAgICBcbiAgICAvLyBMaXN0IGV4aXN0aW5nIHRhYmxlc1xuICAgIGNvbnN0IGxpc3RDb21tYW5kID0gbmV3IExpc3RUYWJsZXNDb21tYW5kKHt9KTtcbiAgICBjb25zdCBsaXN0UmVzdWx0ID0gYXdhaXQgY2xpZW50LnNlbmQobGlzdENvbW1hbmQpO1xuICAgIGNvbnNvbGUubG9nKGBFeGlzdGluZyB0YWJsZXM6ICR7bGlzdFJlc3VsdC5UYWJsZU5hbWVzPy5qb2luKCcsICcpIHx8ICdub25lJ31cXG5gKTtcblxuICAgIC8vIERlbGV0ZSB0YWJsZXMgaWYgcmVzZXQgaXMgcmVxdWVzdGVkXG4gICAgaWYgKHJlc2V0KSB7XG4gICAgICBjb25zb2xlLmxvZygnUmVzZXR0aW5nIHRhYmxlcyAoZGVsZXRpbmcgZXhpc3RpbmcgdGFibGVzKS4uLicpO1xuICAgICAgYXdhaXQgZGVsZXRlVGFibGVJZkV4aXN0cyhUQUJMRV9OQU1FUy5zdHVkZW50cyk7XG4gICAgICBhd2FpdCBkZWxldGVUYWJsZUlmRXhpc3RzKFRBQkxFX05BTUVTLnRlYWNoZXJzKTtcbiAgICAgIGF3YWl0IGRlbGV0ZVRhYmxlSWZFeGlzdHMoVEFCTEVfTkFNRVMuZ2FtZXMpO1xuICAgICAgY29uc29sZS5sb2coJycpO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSB0YWJsZXNcbiAgICBhd2FpdCBjcmVhdGVTdHVkZW50c1RhYmxlKCk7XG4gICAgYXdhaXQgY3JlYXRlVGVhY2hlcnNUYWJsZSgpO1xuICAgIGF3YWl0IGNyZWF0ZUdhbWVzVGFibGUoKTtcblxuICAgIGNvbnNvbGUubG9nKCdcXG7inJMgQWxsIHRhYmxlcyBjcmVhdGVkIHN1Y2Nlc3NmdWxseSEnKTtcbiAgICBjb25zb2xlLmxvZygnXFxuTmV4dCBzdGVwczonKTtcbiAgICBjb25zb2xlLmxvZygnICAxLiBSdW4gc2VlZCBzY3JpcHQgdG8gcG9wdWxhdGUgZGF0YTogbnBtIHJ1biBkeW5hbW9kYjpzZWVkJyk7XG4gICAgY29uc29sZS5sb2coJyAgMi4gVmlldyB0YWJsZXMgaW4gRHluYW1vREIgQWRtaW46IGh0dHA6Ly9sb2NhbGhvc3Q6ODAwMScpO1xuICAgIGNvbnNvbGUubG9nKCcgIDMuIFN0YXJ0IHVzaW5nIHRoZSBsb2NhbCBEeW5hbW9EQiBpbiB5b3VyIGFwcGxpY2F0aW9uXFxuJyk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW5pdGlhbGl6aW5nIHRhYmxlczonLCBlcnJvcik7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbn1cblxuLy8gUGFyc2UgY29tbWFuZCBsaW5lIGFyZ3VtZW50c1xuY29uc3QgYXJncyA9IHByb2Nlc3MuYXJndi5zbGljZSgyKTtcbmNvbnN0IHJlc2V0ID0gYXJncy5pbmNsdWRlcygnLS1yZXNldCcpIHx8IGFyZ3MuaW5jbHVkZXMoJy1yJyk7XG5cbi8vIFJ1biBpbml0aWFsaXphdGlvblxuaW5pdGlhbGl6ZVRhYmxlcyhyZXNldClcbiAgLnRoZW4oKCkgPT4gcHJvY2Vzcy5leGl0KDApKVxuICAuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGluaXRpYWxpemUgdGFibGVzOicsIGVycm9yKTtcbiAgICBwcm9jZXNzLmV4aXQoMSk7XG4gIH0pO1xuIl19