"use strict";
/**
 * Auth Lambda Handler - Login functionality
 * Handles student and teacher authentication
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
// Create DynamoDB client
const mode = process.env.DYNAMODB_MODE || 'aws';
const clientConfig = {
    region: process.env.AWS_REGION || 'us-east-1',
};
if (mode === 'local') {
    const endpoint = process.env.DYNAMODB_ENDPOINT || 'http://localhost:8002';
    clientConfig.endpoint = endpoint;
    clientConfig.credentials = {
        accessKeyId: process.env.AWS_ACCESS_KEY_ID || 'local',
        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY || 'local',
    };
    console.log(`[DynamoDB] Connecting to local DynamoDB at ${endpoint}`);
}
const client = new client_dynamodb_1.DynamoDBClient(clientConfig);
const dynamoDBClient = lib_dynamodb_1.DynamoDBDocumentClient.from(client);
const tableNames = {
    students: process.env.STUDENTS_TABLE_NAME || 'ho-yu-students',
    teachers: process.env.TEACHERS_TABLE_NAME || 'ho-yu-teachers',
    games: process.env.GAMES_TABLE_NAME || 'ho-yu-games',
};
const handler = async (event) => {
    try {
        const body = JSON.parse(event.body || '{}');
        const { id, password } = body;
        if (!id || !password) {
            return {
                statusCode: 400,
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*',
                },
                body: JSON.stringify({ message: 'Missing id or password' }),
            };
        }
        // Try to find student first
        let user = await getStudent(id);
        let role = 'student';
        // If not found, try teacher
        if (!user) {
            user = await getTeacher(id);
            if (user) {
                role = user.is_admin ? 'admin' : 'teacher';
            }
        }
        // Verify user exists and password matches (plain text comparison)
        if (!user || user.password !== password) {
            return {
                statusCode: 401,
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*',
                },
                body: JSON.stringify({ message: 'Invalid credentials' }),
            };
        }
        // Update last login timestamp
        await updateLastLogin(id, role);
        // Remove password from response
        const { password: _, ...userWithoutPassword } = user;
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify({
                success: true,
                user: userWithoutPassword,
                role,
            }),
        };
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify({ message: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
async function getStudent(studentId) {
    const command = new lib_dynamodb_1.GetCommand({
        TableName: tableNames.students,
        Key: { student_id: studentId },
    });
    const result = await dynamoDBClient.send(command);
    return result.Item;
}
async function getTeacher(teacherId) {
    const command = new lib_dynamodb_1.GetCommand({
        TableName: tableNames.teachers,
        Key: { teacher_id: teacherId },
    });
    const result = await dynamoDBClient.send(command);
    return result.Item;
}
async function updateLastLogin(id, role) {
    // Implementation would update the last_login timestamp
    // This is a placeholder for the actual implementation
    console.log(`Updating last login for ${role} ${id}`);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9naW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJsb2dpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7QUFFSCw4REFBMEQ7QUFDMUQsd0RBQTJFO0FBRzNFLHlCQUF5QjtBQUN6QixNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsSUFBSSxLQUFLLENBQUM7QUFDaEQsTUFBTSxZQUFZLEdBQVE7SUFDeEIsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLFdBQVc7Q0FDOUMsQ0FBQztBQUVGLElBQUksSUFBSSxLQUFLLE9BQU8sRUFBRSxDQUFDO0lBQ3JCLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLElBQUksdUJBQXVCLENBQUM7SUFDMUUsWUFBWSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7SUFDakMsWUFBWSxDQUFDLFdBQVcsR0FBRztRQUN6QixXQUFXLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSxPQUFPO1FBQ3JELGVBQWUsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixJQUFJLE9BQU87S0FDOUQsQ0FBQztJQUNGLE9BQU8sQ0FBQyxHQUFHLENBQUMsOENBQThDLFFBQVEsRUFBRSxDQUFDLENBQUM7QUFDeEUsQ0FBQztBQUVELE1BQU0sTUFBTSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUNoRCxNQUFNLGNBQWMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7QUFFM0QsTUFBTSxVQUFVLEdBQUc7SUFDakIsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLElBQUksZ0JBQWdCO0lBQzdELFFBQVEsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLGdCQUFnQjtJQUM3RCxLQUFLLEVBQUUsT0FBTyxDQUFDLEdB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QUFHLEVBQUUsRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFO0tBQy9CLENBQUMsQ0FBQztJQUVILE1BQU0sTUFBTSxHQUFHLE1BQU0sY0FBYyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNsRCxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUM7QUFDckIsQ0FBQztBQUVELEtBQUssVUFBVSxVQUFVLENBQUMsU0FBaUI7SUFDekMsTUFBTSxPQUFPLEdBQUcsSUFBSSx5QkFBVSxDQUFDO1FBQzdCLFNBQVMsRUFBRSxVQUFVLENBQUMsUUFBUTtRQUM5QixHQUFHLEVBQUUsRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFO0tBQy9CLENBQUMsQ0FBQztJQUVILE1BQU0sTUFBTSxHQUFHLE1BQU0sY0FBYyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNsRCxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUM7QUFDckIsQ0FBQztBQUVELEtBQUssVUFBVSxlQUFlLENBQUMsRUFBVSxFQUFFLElBQXFDO0lBQzlFLHVEQUF1RDtJQUN2RCxzREFBc0Q7SUFDdEQsT0FBTyxDQUFDLEdBQUcsQ0FBQywyQkFBMkIsSUFBSSxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDdkQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQXV0aCBMYW1iZGEgSGFuZGxlciAtIExvZ2luIGZ1bmN0aW9uYWxpdHlcbiAqIEhhbmRsZXMgc3R1ZGVudCBhbmQgdGVhY2hlciBhdXRoZW50aWNhdGlvblxuICovXG5cbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIEdldENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuXG4vLyBDcmVhdGUgRHluYW1vREIgY2xpZW50XG5jb25zdCBtb2RlID0gcHJvY2Vzcy5lbnYuRFlOQU1PREJfTU9ERSB8fCAnYXdzJztcbmNvbnN0IGNsaWVudENvbmZpZzogYW55ID0ge1xuICByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgJ3VzLWVhc3QtMScsXG59O1xuXG5pZiAobW9kZSA9PT0gJ2xvY2FsJykge1xuICBjb25zdCBlbmRwb2ludCA9IHByb2Nlc3MuZW52LkRZTkFNT0RCX0VORFBPSU5UIHx8ICdodHRwOi8vbG9jYWxob3N0OjgwMDInO1xuICBjbGllbnRDb25maWcuZW5kcG9pbnQgPSBlbmRwb2ludDtcbiAgY2xpZW50Q29uZmlnLmNyZWRlbnRpYWxzID0ge1xuICAgIGFjY2Vzc0tleUlkOiBwcm9jZXNzLmVudi5BV1NfQUNDRVNTX0tFWV9JRCB8fCAnbG9jYWwnLFxuICAgIHNlY3JldEFjY2Vzc0tleTogcHJvY2Vzcy5lbnYuQVdTX1NFQ1JFVF9BQ0NFU1NfS0VZIHx8ICdsb2NhbCcsXG4gIH07XG4gIGNvbnNvbGUubG9nKGBbRHluYW1vREJdIENvbm5lY3RpbmcgdG8gbG9jYWwgRHluYW1vREIgYXQgJHtlbmRwb2ludH1gKTtcbn1cblxuY29uc3QgY2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KGNsaWVudENvbmZpZyk7XG5jb25zdCBkeW5hbW9EQkNsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShjbGllbnQpO1xuXG5jb25zdCB0YWJsZU5hbWVzID0ge1xuICBzdHVkZW50czogcHJvY2Vzcy5lbnYuU1RVREVOVFNfVEFCTEVfTkFNRSB8fCAnaG8teXUtc3R1ZGVudHMnLFxuICB0ZWFjaGVyczogcHJvY2Vzcy5lbnYuVEVBQ0hFUlNfVEFCTEVfTkFNRSB8fCAnaG8teXUtdGVhY2hlcnMnLFxuICBnYW1lczogcHJvY2Vzcy5lbnYuR0FNRVNfVEFCTEVfTkFNRSB8fCAnaG8teXUtZ2FtZXMnLFxufTtcblxuaW50ZXJmYWNlIExvZ2luUmVxdWVzdCB7XG4gIGlkOiBzdHJpbmc7XG4gIHBhc3N3b3JkOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgYm9keTogTG9naW5SZXF1ZXN0ID0gSlNPTi5wYXJzZShldmVudC5ib2R5IHx8ICd7fScpO1xuICAgIGNvbnN0IHsgaWQsIHBhc3N3b3JkIH0gPSBib2R5O1xuXG4gICAgaWYgKCFpZCB8fCAhcGFzc3dvcmQpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAgICAgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiAnTWlzc2luZyBpZCBvciBwYXNzd29yZCcgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIFRyeSB0byBmaW5kIHN0dWRlbnQgZmlyc3RcbiAgICBsZXQgdXNlciA9IGF3YWl0IGdldFN0dWRlbnQoaWQpO1xuICAgIGxldCByb2xlOiAnc3R1ZGVudCcgfCAndGVhY2hlcicgfCAnYWRtaW4nID0gJ3N0dWRlbnQnO1xuXG4gICAgLy8gSWYgbm90IGZvdW5kLCB0cnkgdGVhY2hlclxuICAgIGlmICghdXNlcikge1xuICAgICAgdXNlciA9IGF3YWl0IGdldFRlYWNoZXIoaWQpO1xuICAgICAgaWYgKHVzZXIpIHtcbiAgICAgICAgcm9sZSA9ICh1c2VyIGFzIGFueSkuaXNfYWRtaW4gPyAnYWRtaW4nIDogJ3RlYWNoZXInO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFZlcmlmeSB1c2VyIGV4aXN0cyBhbmQgcGFzc3dvcmQgbWF0Y2hlcyAocGxhaW4gdGV4dCBjb21wYXJpc29uKVxuICAgIGlmICghdXNlciB8fCB1c2VyLnBhc3N3b3JkICE9PSBwYXNzd29yZCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDAxLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAgICAgICB9LFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IG1lc3NhZ2U6ICdJbnZhbGlkIGNyZWRlbnRpYWxzJyB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gVXBkYXRlIGxhc3QgbG9naW4gdGltZXN0YW1wXG4gICAgYXdhaXQgdXBkYXRlTGFzdExvZ2luKGlkLCByb2xlKTtcblxuICAgIC8vIFJlbW92ZSBwYXNzd29yZCBmcm9tIHJlc3BvbnNlXG4gICAgY29uc3QgeyBwYXNzd29yZDogXywgLi4udXNlcldpdGhvdXRQYXNzd29yZCB9ID0gdXNlcjtcblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICAgICB9LFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICB1c2VyOiB1c2VyV2l0aG91dFBhc3N3b3JkLFxuICAgICAgICByb2xlLFxuICAgICAgfSksXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IG1lc3NhZ2U6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InIH0pLFxuICAgIH07XG4gIH1cbn07XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFN0dWRlbnQoc3R1ZGVudElkOiBzdHJpbmcpIHtcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBHZXRDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IHRhYmxlTmFtZXMuc3R1ZGVudHMsXG4gICAgS2V5OiB7IHN0dWRlbnRfaWQ6IHN0dWRlbnRJZCB9LFxuICB9KTtcblxuICBjb25zdCByZXN1bHQgPSBhd2FpdCBkeW5hbW9EQkNsaWVudC5zZW5kKGNvbW1hbmQpO1xuICByZXR1cm4gcmVzdWx0Lkl0ZW07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFRlYWNoZXIodGVhY2hlcklkOiBzdHJpbmcpIHtcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBHZXRDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IHRhYmxlTmFtZXMudGVhY2hlcnMsXG4gICAgS2V5OiB7IHRlYWNoZXJfaWQ6IHRlYWNoZXJJZCB9LFxuICB9KTtcblxuICBjb25zdCByZXN1bHQgPSBhd2FpdCBkeW5hbW9EQkNsaWVudC5zZW5kKGNvbW1hbmQpO1xuICByZXR1cm4gcmVzdWx0Lkl0ZW07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUxhc3RMb2dpbihpZDogc3RyaW5nLCByb2xlOiAnc3R1ZGVudCcgfCAndGVhY2hlcicgfCAnYWRtaW4nKSB7XG4gIC8vIEltcGxlbWVudGF0aW9uIHdvdWxkIHVwZGF0ZSB0aGUgbGFzdF9sb2dpbiB0aW1lc3RhbXBcbiAgLy8gVGhpcyBpcyBhIHBsYWNlaG9sZGVyIGZvciB0aGUgYWN0dWFsIGltcGxlbWVudGF0aW9uXG4gIGNvbnNvbGUubG9nKGBVcGRhdGluZyBsYXN0IGxvZ2luIGZvciAke3JvbGV9ICR7aWR9YCk7XG59XG4iXX0=