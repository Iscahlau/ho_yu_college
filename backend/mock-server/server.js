"use strict";
/**
 * Mock Server for Local Development
 * Simulates backend APIs using mock data
 */
Object.defineProperty(exports, "__esModule", { value: true });
const express = require("express");
const cors = require("cors");
const XLSX = require("xlsx");
const mocks_1 = require("../test/mocks");
const app = express();
const PORT = process.env.PORT || 3000;
// Middleware
app.use(cors());
app.use(express.json());
// In-memory storage for game clicks (simulating database updates)
const gameClicks = new Map();
// Initialize game clicks from mock data
mocks_1.mockGames.forEach(game => {
    gameClicks.set(game.game_id, game.accumulated_click);
});
// ===== Authentication Endpoints =====
/**
 * POST /auth/login
 * Login endpoint for students and teachers
 */
app.post('/auth/login', (req, res) => {
    const { id, password } = req.body;
    if (!id || !password) {
        return res.status(400).json({ message: 'Missing id or password' });
    }
    // Try to find student first
    let user = mocks_1.mockStudents.find(s => s.student_id === id);
    let role = 'student';
    // If not found, try teacher
    if (!user) {
        const teacher = mocks_1.mockTeachers.find(t => t.teacher_id === id);
        if (teacher) {
            user = teacher;
            role = teacher.is_admin ? 'admin' : 'teacher';
        }
    }
    // Verify user exists and password matches (plain text comparison)
    if (!user || user.password !== password) {
        return res.status(401).json({ message: 'Invalid credentials' });
    }
    // Remove password from response
    const { password: _, ...userWithoutPassword } = user;
    res.json({
        success: true,
        user: userWithoutPassword,
        role,
    });
});
// ===== Games Endpoints =====
/**
 * GET /games
 * Fetch all games
 */
app.get('/games', (req, res) => {
    // Return games with updated click counts
    const gamesWithUpdatedClicks = mocks_1.mockGames.map(game => ({
        ...game,
        accumulated_click: gameClicks.get(game.game_id) || game.accumulated_click,
    }));
    res.json(gamesWithUpdatedClicks);
});
/**
 * GET /games/download
 * Download games data as Excel
 * NOTE: This must be defined before /games/:gameId to avoid route conflicts
 */
app.get('/games/download', (req, res) => {
    try {
        // Get games with updated click counts
        const gamesWithUpdatedClicks = mocks_1.mockGames.map(game => ({
            ...game,
            accumulated_click: gameClicks.get(game.game_id) || game.accumulated_click,
        }));
        // Sort games by game_id
        gamesWithUpdatedClicks.sort((a, b) => a.game_id.localeCompare(b.game_id));
        // Create Excel workbook
        const worksheet = XLSX.utils.json_to_sheet(gamesWithUpdatedClicks);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Games');
        // Set column widths
        worksheet['!cols'] = [
            { wch: 12 }, { wch: 30 }, { wch: 12 }, { wch: 25 }, { wch: 15 },
            { wch: 12 }, { wch: 20 }, { wch: 15 }, { wch: 40 }, { wch: 15 }
        ];
        // Generate Excel file
        const excelBuffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });
        res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        res.setHeader('Content-Disposition', `attachment; filename="games_${new Date().toISOString().split('T')[0]}.xlsx"`);
        res.send(excelBuffer);
    }
    catch (error) {
        res.status(500).json({
            success: false,
            message: 'Failed to download games data',
        });
    }
});
/**
 * GET /games/:gameId
 * Fetch a single game by ID
 */
app.get('/games/:gameId', (req, res) => {
    const { gameId } = req.params;
    const game = mocks_1.mockGames.find(g => g.game_id === gameId);
    if (!game) {
        return res.status(404).json({ message: 'Game not found' });
    }
    // Return game with updated click count
    res.json({
        ...game,
        accumulated_click: gameClicks.get(game.game_id) || game.accumulated_click,
    });
});
/**
 * POST /games/:gameId/click
 * Increment game click count
 */
app.post('/games/:gameId/click', (req, res) => {
    const { gameId } = req.params;
    const game = mocks_1.mockGames.find(g => g.game_id === gameId);
    if (!game) {
        return res.status(404).json({ message: 'Game not found' });
    }
    // Increment click count
    const currentClicks = gameClicks.get(gameId) || game.accumulated_click;
    gameClicks.set(gameId, currentClicks + 1);
    res.json({
        success: true,
        accumulated_click: gameClicks.get(gameId),
    });
});
// ===== Download Endpoints =====
/**
 * GET /students/download
 * Download student data as Excel
 */
app.get('/students/download', (req, res) => {
    try {
        const classFilter = req.query.classes ? req.query.classes.split(',') : [];
        let students = mocks_1.mockStudents;
        if (classFilter.length > 0) {
            students = mocks_1.mockStudents.filter(s => classFilter.includes(s.class));
        }
        // Sort students by class and class_no
        students.sort((a, b) => {
            if (a.class !== b.class) {
                return a.class.localeCompare(b.class);
            }
            return a.class_no.localeCompare(b.class_no);
        });
        // Include all fields including password
        const excelData = students.map(student => ({
            student_id: student.student_id,
            name_1: student.name_1,
            name_2: student.name_2,
            marks: student.marks,
            class: student.class,
            class_no: student.class_no,
            last_login: student.last_login,
            last_update: student.last_update,
            teacher_id: student.teacher_id,
            password: student.password,
        }));
        // Create Excel workbook
        const worksheet = XLSX.utils.json_to_sheet(excelData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Students');
        // Set column widths
        worksheet['!cols'] = [
            { wch: 12 }, { wch: 20 }, { wch: 20 }, { wch: 8 },
            { wch: 8 }, { wch: 10 }, { wch: 20 }, { wch: 20 }, { wch: 12 }, { wch: 15 }
        ];
        // Generate Excel file
        const excelBuffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });
        res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        res.setHeader('Content-Disposition', `attachment; filename="students_${new Date().toISOString().split('T')[0]}.xlsx"`);
        res.send(excelBuffer);
    }
    catch (error) {
        res.status(500).json({
            success: false,
            message: 'Failed to download student data',
        });
    }
});
/**
 * GET /teachers/download
 * Download teacher data as Excel (Admin only)
 */
app.get('/teachers/download', (req, res) => {
    try {
        const teachers = mocks_1.mockTeachers.sort((a, b) => a.teacher_id.localeCompare(b.teacher_id));
        // Include all fields including password
        const excelData = teachers.map(teacher => ({
            teacher_id: teacher.teacher_id,
            name: teacher.name,
            responsible_class: teacher.responsible_class.join(', '),
            last_login: teacher.last_login,
            is_admin: teacher.is_admin ? 'Yes' : 'No',
            password: teacher.password,
        }));
        // Create Excel workbook
        const worksheet = XLSX.utils.json_to_sheet(excelData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Teachers');
        // Set column widths
        worksheet['!cols'] = [
            { wch: 12 }, { wch: 20 }, { wch: 30 }, { wch: 20 }, { wch: 10 }, { wch: 15 }
        ];
        // Generate Excel file
        const excelBuffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });
        res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        res.setHeader('Content-Disposition', `attachment; filename="teachers_${new Date().toISOString().split('T')[0]}.xlsx"`);
        res.send(excelBuffer);
    }
    catch (error) {
        res.status(500).json({
            success: false,
            message: 'Failed to download teacher data',
        });
    }
});
// ===== Server Start =====
app.listen(PORT, () => {
    console.log(`ðŸš€ Mock server running on http://localhost:${PORT}`);
    console.log(`ðŸ“š Serving mock data for local development`);
    console.log(`\nAvailable endpoints:`);
    console.log(`  POST   /auth/login`);
    console.log(`  GET    /games`);
    console.log(`  GET    /games/:gameId`);
    console.log(`  POST   /games/:gameId/click`);
    console.log(`  GET    /students/download`);
    console.log(`  GET    /teachers/download`);
    console.log(`  GET    /games/download`);
    console.log(`\nMock credentials:`);
    console.log(`  Students: STU001-STU010, password: "123"`);
    console.log(`  Teachers: TCH001-TCH002, password: "teacher123"`);
    console.log(`  Admin:    TCH003, password: "admin123"`);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2VydmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7O0FBRUgsbUNBQW9DO0FBQ3BDLDZCQUE4QjtBQUM5Qiw2QkFBNkI7QUFDN0IseUNBQXNFO0FBRXRFLE1BQU0sR0FBRyxHQUFHLE9BQU8sRUFBRSxDQUFDO0FBQ3RCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQztBQUV0QyxhQUFhO0FBQ2IsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBQ2hCLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7QUFFeEIsa0VBQWtFO0FBQ2xFLE1BQU0sVUFBVSxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO0FBRTdDLHdDQUF3QztBQUN4QyxpQkFBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtJQUN2QixVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDdkQsQ0FBQyxDQUFDLENBQUM7QUFFSCx1Q0FBdUM7QUFFdkM7OztHQUdHO0FBQ0gsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxHQUFvQixFQUFFLEdBQXFCLEVBQUUsRUFBRTtJQUN0RSxNQUFNLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7SUFFbEMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3JCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsQ0FBQyxDQUFDO0lBQ3JFLENBQUM7SUFFRCw0QkFBNEI7SUFDNUIsSUFBSSxJ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QUcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0lBQ25DLE9BQU8sQ0FBQyxHQUFHLENBQUMsNENBQTRDLENBQUMsQ0FBQztJQUMxRCxPQUFPLENBQUMsR0FBRyxDQUFDLG1EQUFtRCxDQUFDLENBQUM7SUFDakUsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQ0FBMEMsQ0FBQyxDQUFDO0FBQzFELENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBNb2NrIFNlcnZlciBmb3IgTG9jYWwgRGV2ZWxvcG1lbnRcbiAqIFNpbXVsYXRlcyBiYWNrZW5kIEFQSXMgdXNpbmcgbW9jayBkYXRhXG4gKi9cblxuaW1wb3J0IGV4cHJlc3MgPSByZXF1aXJlKCdleHByZXNzJyk7XG5pbXBvcnQgY29ycyA9IHJlcXVpcmUoJ2NvcnMnKTtcbmltcG9ydCAqIGFzIFhMU1ggZnJvbSAneGxzeCc7XG5pbXBvcnQgeyBtb2NrU3R1ZGVudHMsIG1vY2tUZWFjaGVycywgbW9ja0dhbWVzIH0gZnJvbSAnLi4vdGVzdC9tb2Nrcyc7XG5cbmNvbnN0IGFwcCA9IGV4cHJlc3MoKTtcbmNvbnN0IFBPUlQgPSBwcm9jZXNzLmVudi5QT1JUIHx8IDMwMDA7XG5cbi8vIE1pZGRsZXdhcmVcbmFwcC51c2UoY29ycygpKTtcbmFwcC51c2UoZXhwcmVzcy5qc29uKCkpO1xuXG4vLyBJbi1tZW1vcnkgc3RvcmFnZSBmb3IgZ2FtZSBjbGlja3MgKHNpbXVsYXRpbmcgZGF0YWJhc2UgdXBkYXRlcylcbmNvbnN0IGdhbWVDbGlja3MgPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyPigpO1xuXG4vLyBJbml0aWFsaXplIGdhbWUgY2xpY2tzIGZyb20gbW9jayBkYXRhXG5tb2NrR2FtZXMuZm9yRWFjaChnYW1lID0+IHtcbiAgZ2FtZUNsaWNrcy5zZXQoZ2FtZS5nYW1lX2lkLCBnYW1lLmFjY3VtdWxhdGVkX2NsaWNrKTtcbn0pO1xuXG4vLyA9PT09PSBBdXRoZW50aWNhdGlvbiBFbmRwb2ludHMgPT09PT1cblxuLyoqXG4gKiBQT1NUIC9hdXRoL2xvZ2luXG4gKiBMb2dpbiBlbmRwb2ludCBmb3Igc3R1ZGVudHMgYW5kIHRlYWNoZXJzXG4gKi9cbmFwcC5wb3N0KCcvYXV0aC9sb2dpbicsIChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSA9PiB7XG4gIGNvbnN0IHsgaWQsIHBhc3N3b3JkIH0gPSByZXEuYm9keTtcblxuICBpZiAoIWlkIHx8ICFwYXNzd29yZCkge1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IG1lc3NhZ2U6ICdNaXNzaW5nIGlkIG9yIHBhc3N3b3JkJyB9KTtcbiAgfVxuXG4gIC8vIFRyeSB0byBmaW5kIHN0dWRlbnQgZmlyc3RcbiAgbGV0IHVzZXIgPSBtb2NrU3R1ZGVudHMuZmluZChzID0+IHMuc3R1ZGVudF9pZCA9PT0gaWQpO1xuICBsZXQgcm9sZTogJ3N0dWRlbnQnIHwgJ3RlYWNoZXInIHwgJ2FkbWluJyA9ICdzdHVkZW50JztcblxuICAvLyBJZiBub3QgZm91bmQsIHRyeSB0ZWFjaGVyXG4gIGlmICghdXNlcikge1xuICAgIGNvbnN0IHRlYWNoZXIgPSBtb2NrVGVhY2hlcnMuZmluZCh0ID0+IHQudGVhY2hlcl9pZCA9PT0gaWQpO1xuICAgIGlmICh0ZWFjaGVyKSB7XG4gICAgICB1c2VyID0gdGVhY2hlcjtcbiAgICAgIHJvbGUgPSB0ZWFjaGVyLmlzX2FkbWluID8gJ2FkbWluJyA6ICd0ZWFjaGVyJztcbiAgICB9XG4gIH1cblxuICAvLyBWZXJpZnkgdXNlciBleGlzdHMgYW5kIHBhc3N3b3JkIG1hdGNoZXMgKHBsYWluIHRleHQgY29tcGFyaXNvbilcbiAgaWYgKCF1c2VyIHx8IHVzZXIucGFzc3dvcmQgIT09IHBhc3N3b3JkKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgbWVzc2FnZTogJ0ludmFsaWQgY3JlZGVudGlhbHMnIH0pO1xuICB9XG5cbiAgLy8gUmVtb3ZlIHBhc3N3b3JkIGZyb20gcmVzcG9uc2VcbiAgY29uc3QgeyBwYXNzd29yZDogXywgLi4udXNlcldpdGhvdXRQYXNzd29yZCB9ID0gdXNlcjtcblxuICByZXMuanNvbih7XG4gICAgc3VjY2VzczogdHJ1ZSxcbiAgICB1c2VyOiB1c2VyV2l0aG91dFBhc3N3b3JkLFxuICAgIHJvbGUsXG4gIH0pO1xufSk7XG5cbi8vID09PT09IEdhbWVzIEVuZHBvaW50cyA9PT09PVxuXG4vKipcbiAqIEdFVCAvZ2FtZXNcbiAqIEZldGNoIGFsbCBnYW1lc1xuICovXG5hcHAuZ2V0KCcvZ2FtZXMnLCAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuICAvLyBSZXR1cm4gZ2FtZXMgd2l0aCB1cGRhdGVkIGNsaWNrIGNvdW50c1xuICBjb25zdCBnYW1lc1dpdGhVcGRhdGVkQ2xpY2tzID0gbW9ja0dhbWVzLm1hcChnYW1lID0+ICh7XG4gICAgLi4uZ2FtZSxcbiAgICBhY2N1bXVsYXRlZF9jbGljazogZ2FtZUNsaWNrcy5nZXQoZ2FtZS5nYW1lX2lkKSB8fCBnYW1lLmFjY3VtdWxhdGVkX2NsaWNrLFxuICB9KSk7XG5cbiAgcmVzLmpzb24oZ2FtZXNXaXRoVXBkYXRlZENsaWNrcyk7XG59KTtcblxuLyoqXG4gKiBHRVQgL2dhbWVzL2Rvd25sb2FkXG4gKiBEb3dubG9hZCBnYW1lcyBkYXRhIGFzIEV4Y2VsXG4gKiBOT1RFOiBUaGlzIG11c3QgYmUgZGVmaW5lZCBiZWZvcmUgL2dhbWVzLzpnYW1lSWQgdG8gYXZvaWQgcm91dGUgY29uZmxpY3RzXG4gKi9cbmFwcC5nZXQoJy9nYW1lcy9kb3dubG9hZCcsIChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSA9PiB7XG4gIHRyeSB7XG4gICAgLy8gR2V0IGdhbWVzIHdpdGggdXBkYXRlZCBjbGljayBjb3VudHNcbiAgICBjb25zdCBnYW1lc1dpdGhVcGRhdGVkQ2xpY2tzID0gbW9ja0dhbWVzLm1hcChnYW1lID0+ICh7XG4gICAgICAuLi5nYW1lLFxuICAgICAgYWNjdW11bGF0ZWRfY2xpY2s6IGdhbWVDbGlja3MuZ2V0KGdhbWUuZ2FtZV9pZCkgfHwgZ2FtZS5hY2N1bXVsYXRlZF9jbGljayxcbiAgICB9KSk7XG5cbiAgICAvLyBTb3J0IGdhbWVzIGJ5IGdhbWVfaWRcbiAgICBnYW1lc1dpdGhVcGRhdGVkQ2xpY2tzLnNvcnQoKGEsIGIpID0+IGEuZ2FtZV9pZC5sb2NhbGVDb21wYXJlKGIuZ2FtZV9pZCkpO1xuXG4gICAgLy8gQ3JlYXRlIEV4Y2VsIHdvcmtib29rXG4gICAgY29uc3Qgd29ya3NoZWV0ID0gWExTWC51dGlscy5qc29uX3RvX3NoZWV0KGdhbWVzV2l0aFVwZGF0ZWRDbGlja3MpO1xuICAgIGNvbnN0IHdvcmtib29rID0gWExTWC51dGlscy5ib29rX25ldygpO1xuICAgIFhMU1gudXRpbHMuYm9va19hcHBlbmRfc2hlZXQod29ya2Jvb2ssIHdvcmtzaGVldCwgJ0dhbWVzJyk7XG5cbiAgICAvLyBTZXQgY29sdW1uIHdpZHRoc1xuICAgIHdvcmtzaGVldFsnIWNvbHMnXSA9IFtcbiAgICAgIHsgd2NoOiAxMiB9LCB7IHdjaDogMzAgfSwgeyB3Y2g6IDEyIH0sIHsgd2NoOiAyNSB9LCB7IHdjaDogMTUgfSxcbiAgICAgIHsgd2NoOiAxMiB9LCB7IHdjaDogMjAgfSwgeyB3Y2g6IDE1IH0sIHsgd2NoOiA0MCB9LCB7IHdjaDogMTUgfVxuICAgIF07XG5cbiAgICAvLyBHZW5lcmF0ZSBFeGNlbCBmaWxlXG4gICAgY29uc3QgZXhjZWxCdWZmZXIgPSBYTFNYLndyaXRlKHdvcmtib29rLCB7IHR5cGU6ICdidWZmZXInLCBib29rVHlwZTogJ3hsc3gnIH0pO1xuXG4gICAgcmVzLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC5zcHJlYWRzaGVldG1sLnNoZWV0Jyk7XG4gICAgcmVzLnNldEhlYWRlcignQ29udGVudC1EaXNwb3NpdGlvbicsIGBhdHRhY2htZW50OyBmaWxlbmFtZT1cImdhbWVzXyR7bmV3IERhdGUoKS50b0lTT1N0cmluZygpLnNwbGl0KCdUJylbMF19Lnhsc3hcImApO1xuICAgIHJlcy5zZW5kKGV4Y2VsQnVmZmVyKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gZG93bmxvYWQgZ2FtZXMgZGF0YScsXG4gICAgfSk7XG4gIH1cbn0pO1xuXG4vKipcbiAqIEdFVCAvZ2FtZXMvOmdhbWVJZFxuICogRmV0Y2ggYSBzaW5nbGUgZ2FtZSBieSBJRFxuICovXG5hcHAuZ2V0KCcvZ2FtZXMvOmdhbWVJZCcsIChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSA9PiB7XG4gIGNvbnN0IHsgZ2FtZUlkIH0gPSByZXEucGFyYW1zO1xuICBjb25zdCBnYW1lID0gbW9ja0dhbWVzLmZpbmQoZyA9PiBnLmdhbWVfaWQgPT09IGdhbWVJZCk7XG5cbiAgaWYgKCFnYW1lKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgbWVzc2FnZTogJ0dhbWUgbm90IGZvdW5kJyB9KTtcbiAgfVxuXG4gIC8vIFJldHVybiBnYW1lIHdpdGggdXBkYXRlZCBjbGljayBjb3VudFxuICByZXMuanNvbih7XG4gICAgLi4uZ2FtZSxcbiAgICBhY2N1bXVsYXRlZF9jbGljazogZ2FtZUNsaWNrcy5nZXQoZ2FtZS5nYW1lX2lkKSB8fCBnYW1lLmFjY3VtdWxhdGVkX2NsaWNrLFxuICB9KTtcbn0pO1xuXG4vKipcbiAqIFBPU1QgL2dhbWVzLzpnYW1lSWQvY2xpY2tcbiAqIEluY3JlbWVudCBnYW1lIGNsaWNrIGNvdW50XG4gKi9cbmFwcC5wb3N0KCcvZ2FtZXMvOmdhbWVJZC9jbGljaycsIChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSA9PiB7XG4gIGNvbnN0IHsgZ2FtZUlkIH0gPSByZXEucGFyYW1zO1xuICBjb25zdCBnYW1lID0gbW9ja0dhbWVzLmZpbmQoZyA9PiBnLmdhbWVfaWQgPT09IGdhbWVJZCk7XG5cbiAgaWYgKCFnYW1lKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgbWVzc2FnZTogJ0dhbWUgbm90IGZvdW5kJyB9KTtcbiAgfVxuXG4gIC8vIEluY3JlbWVudCBjbGljayBjb3VudFxuICBjb25zdCBjdXJyZW50Q2xpY2tzID0gZ2FtZUNsaWNrcy5nZXQoZ2FtZUlkKSB8fCBnYW1lLmFjY3VtdWxhdGVkX2NsaWNrO1xuICBnYW1lQ2xpY2tzLnNldChnYW1lSWQsIGN1cnJlbnRDbGlja3MgKyAxKTtcblxuICByZXMuanNvbih7XG4gICAgc3VjY2VzczogdHJ1ZSxcbiAgICBhY2N1bXVsYXRlZF9jbGljazogZ2FtZUNsaWNrcy5nZXQoZ2FtZUlkKSxcbiAgfSk7XG59KTtcblxuLy8gPT09PT0gRG93bmxvYWQgRW5kcG9pbnRzID09PT09XG5cbi8qKlxuICogR0VUIC9zdHVkZW50cy9kb3dubG9hZFxuICogRG93bmxvYWQgc3R1ZGVudCBkYXRhIGFzIEV4Y2VsXG4gKi9cbmFwcC5nZXQoJy9zdHVkZW50cy9kb3dubG9hZCcsIChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgY2xhc3NGaWx0ZXIgPSByZXEucXVlcnkuY2xhc3NlcyA/IChyZXEucXVlcnkuY2xhc3NlcyBhcyBzdHJpbmcpLnNwbGl0KCcsJykgOiBbXTtcbiAgICBcbiAgICBsZXQgc3R1ZGVudHMgPSBtb2NrU3R1ZGVudHM7XG4gICAgaWYgKGNsYXNzRmlsdGVyLmxlbmd0aCA+IDApIHtcbiAgICAgIHN0dWRlbnRzID0gbW9ja1N0dWRlbnRzLmZpbHRlcihzID0+IGNsYXNzRmlsdGVyLmluY2x1ZGVzKHMuY2xhc3MpKTtcbiAgICB9XG5cbiAgICAvLyBTb3J0IHN0dWRlbnRzIGJ5IGNsYXNzIGFuZCBjbGFzc19ub1xuICAgIHN0dWRlbnRzLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgIGlmIChhLmNsYXNzICE9PSBiLmNsYXNzKSB7XG4gICAgICAgIHJldHVybiBhLmNsYXNzLmxvY2FsZUNvbXBhcmUoYi5jbGFzcyk7XG4gICAgICB9XG4gICAgICByZXR1cm4gYS5jbGFzc19uby5sb2NhbGVDb21wYXJlKGIuY2xhc3Nfbm8pO1xuICAgIH0pO1xuXG4gICAgLy8gSW5jbHVkZSBhbGwgZmllbGRzIGluY2x1ZGluZyBwYXNzd29yZFxuICAgIGNvbnN0IGV4Y2VsRGF0YSA9IHN0dWRlbnRzLm1hcChzdHVkZW50ID0+ICh7XG4gICAgICBzdHVkZW50X2lkOiBzdHVkZW50LnN0dWRlbnRfaWQsXG4gICAgICBuYW1lXzE6IHN0dWRlbnQubmFtZV8xLFxuICAgICAgbmFtZV8yOiBzdHVkZW50Lm5hbWVfMixcbiAgICAgIG1hcmtzOiBzdHVkZW50Lm1hcmtzLFxuICAgICAgY2xhc3M6IHN0dWRlbnQuY2xhc3MsXG4gICAgICBjbGFzc19ubzogc3R1ZGVudC5jbGFzc19ubyxcbiAgICAgIGxhc3RfbG9naW46IHN0dWRlbnQubGFzdF9sb2dpbixcbiAgICAgIGxhc3RfdXBkYXRlOiBzdHVkZW50Lmxhc3RfdXBkYXRlLFxuICAgICAgdGVhY2hlcl9pZDogc3R1ZGVudC50ZWFjaGVyX2lkLFxuICAgICAgcGFzc3dvcmQ6IHN0dWRlbnQucGFzc3dvcmQsXG4gICAgfSkpO1xuXG4gICAgLy8gQ3JlYXRlIEV4Y2VsIHdvcmtib29rXG4gICAgY29uc3Qgd29ya3NoZWV0ID0gWExTWC51dGlscy5qc29uX3RvX3NoZWV0KGV4Y2VsRGF0YSk7XG4gICAgY29uc3Qgd29ya2Jvb2sgPSBYTFNYLnV0aWxzLmJvb2tfbmV3KCk7XG4gICAgWExTWC51dGlscy5ib29rX2FwcGVuZF9zaGVldCh3b3JrYm9vaywgd29ya3NoZWV0LCAnU3R1ZGVudHMnKTtcblxuICAgIC8vIFNldCBjb2x1bW4gd2lkdGhzXG4gICAgd29ya3NoZWV0WychY29scyddID0gW1xuICAgICAgeyB3Y2g6IDEyIH0sIHsgd2NoOiAyMCB9LCB7IHdjaDogMjAgfSwgeyB3Y2g6IDggfSxcbiAgICAgIHsgd2NoOiA4IH0sIHsgd2NoOiAxMCB9LCB7IHdjaDogMjAgfSwgeyB3Y2g6IDIwIH0sIHsgd2NoOiAxMiB9LCB7IHdjaDogMTUgfVxuICAgIF07XG5cbiAgICAvLyBHZW5lcmF0ZSBFeGNlbCBmaWxlXG4gICAgY29uc3QgZXhjZWxCdWZmZXIgPSBYTFNYLndyaXRlKHdvcmtib29rLCB7IHR5cGU6ICdidWZmZXInLCBib29rVHlwZTogJ3hsc3gnIH0pO1xuXG4gICAgcmVzLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC5zcHJlYWRzaGVldG1sLnNoZWV0Jyk7XG4gICAgcmVzLnNldEhlYWRlcignQ29udGVudC1EaXNwb3NpdGlvbicsIGBhdHRhY2htZW50OyBmaWxlbmFtZT1cInN0dWRlbnRzXyR7bmV3IERhdGUoKS50b0lTT1N0cmluZygpLnNwbGl0KCdUJylbMF19Lnhsc3hcImApO1xuICAgIHJlcy5zZW5kKGV4Y2VsQnVmZmVyKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gZG93bmxvYWQgc3R1ZGVudCBkYXRhJyxcbiAgICB9KTtcbiAgfVxufSk7XG5cbi8qKlxuICogR0VUIC90ZWFjaGVycy9kb3dubG9hZFxuICogRG93bmxvYWQgdGVhY2hlciBkYXRhIGFzIEV4Y2VsIChBZG1pbiBvbmx5KVxuICovXG5hcHAuZ2V0KCcvdGVhY2hlcnMvZG93bmxvYWQnLCAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHRlYWNoZXJzID0gbW9ja1RlYWNoZXJzLnNvcnQoKGEsIGIpID0+IGEudGVhY2hlcl9pZC5sb2NhbGVDb21wYXJlKGIudGVhY2hlcl9pZCkpO1xuXG4gICAgLy8gSW5jbHVkZSBhbGwgZmllbGRzIGluY2x1ZGluZyBwYXNzd29yZFxuICAgIGNvbnN0IGV4Y2VsRGF0YSA9IHRlYWNoZXJzLm1hcCh0ZWFjaGVyID0+ICh7XG4gICAgICB0ZWFjaGVyX2lkOiB0ZWFjaGVyLnRlYWNoZXJfaWQsXG4gICAgICBuYW1lOiB0ZWFjaGVyLm5hbWUsXG4gICAgICByZXNwb25zaWJsZV9jbGFzczogdGVhY2hlci5yZXNwb25zaWJsZV9jbGFzcy5qb2luKCcsICcpLFxuICAgICAgbGFzdF9sb2dpbjogdGVhY2hlci5sYXN0X2xvZ2luLFxuICAgICAgaXNfYWRtaW46IHRlYWNoZXIuaXNfYWRtaW4gPyAnWWVzJyA6ICdObycsXG4gICAgICBwYXNzd29yZDogdGVhY2hlci5wYXNzd29yZCxcbiAgICB9KSk7XG5cbiAgICAvLyBDcmVhdGUgRXhjZWwgd29ya2Jvb2tcbiAgICBjb25zdCB3b3Jrc2hlZXQgPSBYTFNYLnV0aWxzLmpzb25fdG9fc2hlZXQoZXhjZWxEYXRhKTtcbiAgICBjb25zdCB3b3JrYm9vayA9IFhMU1gudXRpbHMuYm9va19uZXcoKTtcbiAgICBYTFNYLnV0aWxzLmJvb2tfYXBwZW5kX3NoZWV0KHdvcmtib29rLCB3b3Jrc2hlZXQsICdUZWFjaGVycycpO1xuXG4gICAgLy8gU2V0IGNvbHVtbiB3aWR0aHNcbiAgICB3b3Jrc2hlZXRbJyFjb2xzJ10gPSBbXG4gICAgICB7IHdjaDogMTIgfSwgeyB3Y2g6IDIwIH0sIHsgd2NoOiAzMCB9LCB7IHdjaDogMjAgfSwgeyB3Y2g6IDEwIH0sIHsgd2NoOiAxNSB9XG4gICAgXTtcblxuICAgIC8vIEdlbmVyYXRlIEV4Y2VsIGZpbGVcbiAgICBjb25zdCBleGNlbEJ1ZmZlciA9IFhMU1gud3JpdGUod29ya2Jvb2ssIHsgdHlwZTogJ2J1ZmZlcicsIGJvb2tUeXBlOiAneGxzeCcgfSk7XG5cbiAgICByZXMuc2V0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vdm5kLm9wZW54bWxmb3JtYXRzLW9mZmljZWRvY3VtZW50LnNwcmVhZHNoZWV0bWwuc2hlZXQnKTtcbiAgICByZXMuc2V0SGVhZGVyKCdDb250ZW50LURpc3Bvc2l0aW9uJywgYGF0dGFjaG1lbnQ7IGZpbGVuYW1lPVwidGVhY2hlcnNfJHtuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXX0ueGxzeFwiYCk7XG4gICAgcmVzLnNlbmQoZXhjZWxCdWZmZXIpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBkb3dubG9hZCB0ZWFjaGVyIGRhdGEnLFxuICAgIH0pO1xuICB9XG59KTtcblxuLy8gPT09PT0gU2VydmVyIFN0YXJ0ID09PT09XG5cbmFwcC5saXN0ZW4oUE9SVCwgKCkgPT4ge1xuICBjb25zb2xlLmxvZyhg8J+agCBNb2NrIHNlcnZlciBydW5uaW5nIG9uIGh0dHA6Ly9sb2NhbGhvc3Q6JHtQT1JUfWApO1xuICBjb25zb2xlLmxvZyhg8J+TmiBTZXJ2aW5nIG1vY2sgZGF0YSBmb3IgbG9jYWwgZGV2ZWxvcG1lbnRgKTtcbiAgY29uc29sZS5sb2coYFxcbkF2YWlsYWJsZSBlbmRwb2ludHM6YCk7XG4gIGNvbnNvbGUubG9nKGAgIFBPU1QgICAvYXV0aC9sb2dpbmApO1xuICBjb25zb2xlLmxvZyhgICBHRVQgICAgL2dhbWVzYCk7XG4gIGNvbnNvbGUubG9nKGAgIEdFVCAgICAvZ2FtZXMvOmdhbWVJZGApO1xuICBjb25zb2xlLmxvZyhgICBQT1NUICAgL2dhbWVzLzpnYW1lSWQvY2xpY2tgKTtcbiAgY29uc29sZS5sb2coYCAgR0VUICAgIC9zdHVkZW50cy9kb3dubG9hZGApO1xuICBjb25zb2xlLmxvZyhgICBHRVQgICAgL3RlYWNoZXJzL2Rvd25sb2FkYCk7XG4gIGNvbnNvbGUubG9nKGAgIEdFVCAgICAvZ2FtZXMvZG93bmxvYWRgKTtcbiAgY29uc29sZS5sb2coYFxcbk1vY2sgY3JlZGVudGlhbHM6YCk7XG4gIGNvbnNvbGUubG9nKGAgIFN0dWRlbnRzOiBTVFUwMDEtU1RVMDEwLCBwYXNzd29yZDogXCIxMjNcImApO1xuICBjb25zb2xlLmxvZyhgICBUZWFjaGVyczogVENIMDAxLVRDSDAwMiwgcGFzc3dvcmQ6IFwidGVhY2hlcjEyM1wiYCk7XG4gIGNvbnNvbGUubG9nKGAgIEFkbWluOiAgICBUQ0gwMDMsIHBhc3N3b3JkOiBcImFkbWluMTIzXCJgKTtcbn0pO1xuIl19