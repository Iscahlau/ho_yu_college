"use strict";
/**
 * Mock Server for Local Development
 * Simulates backend APIs using mock data
 */
Object.defineProperty(exports, "__esModule", { value: true });
const express = require("express");
const cors = require("cors");
const crypto = require("crypto");
const XLSX = require("xlsx");
const mocks_1 = require("../test/mocks");
const app = express();
const PORT = process.env.PORT || 3000;
// Middleware
app.use(cors());
app.use(express.json());
// Helper function to hash passwords
function hashPassword(password) {
    return crypto.createHash('sha256').update(password).digest('hex');
}
// In-memory storage for game clicks (simulating database updates)
const gameClicks = new Map();
// Initialize game clicks from mock data
mocks_1.mockGames.forEach(game => {
    gameClicks.set(game.game_id, game.accumulated_click);
});
// ===== Authentication Endpoints =====
/**
 * POST /auth/login
 * Login endpoint for students and teachers
 */
app.post('/auth/login', (req, res) => {
    const { id, password } = req.body;
    if (!id || !password) {
        return res.status(400).json({ message: 'Missing id or password' });
    }
    const hashedPassword = hashPassword(password);
    // Try to find student first
    let user = mocks_1.mockStudents.find(s => s.student_id === id);
    let role = 'student';
    // If not found, try teacher
    if (!user) {
        const teacher = mocks_1.mockTeachers.find(t => t.teacher_id === id);
        if (teacher) {
            user = teacher;
            role = teacher.is_admin ? 'admin' : 'teacher';
        }
    }
    // Verify user exists and password matches
    if (!user || user.password !== hashedPassword) {
        return res.status(401).json({ message: 'Invalid credentials' });
    }
    // Remove password from response
    const { password: _, ...userWithoutPassword } = user;
    res.json({
        success: true,
        user: userWithoutPassword,
        role,
    });
});
// ===== Games Endpoints =====
/**
 * GET /games
 * Fetch all games
 */
app.get('/games', (req, res) => {
    // Return games with updated click counts
    const gamesWithUpdatedClicks = mocks_1.mockGames.map(game => ({
        ...game,
        accumulated_click: gameClicks.get(game.game_id) || game.accumulated_click,
    }));
    res.json(gamesWithUpdatedClicks);
});
/**
 * GET /games/:gameId
 * Fetch a single game by ID
 */
app.get('/games/:gameId', (req, res) => {
    const { gameId } = req.params;
    const game = mocks_1.mockGames.find(g => g.game_id === gameId);
    if (!game) {
        return res.status(404).json({ message: 'Game not found' });
    }
    // Return game with updated click count
    res.json({
        ...game,
        accumulated_click: gameClicks.get(game.game_id) || game.accumulated_click,
    });
});
/**
 * POST /games/:gameId/click
 * Increment game click count
 */
app.post('/games/:gameId/click', (req, res) => {
    const { gameId } = req.params;
    const game = mocks_1.mockGames.find(g => g.game_id === gameId);
    if (!game) {
        return res.status(404).json({ message: 'Game not found' });
    }
    // Increment click count
    const currentClicks = gameClicks.get(gameId) || game.accumulated_click;
    gameClicks.set(gameId, currentClicks + 1);
    res.json({
        success: true,
        accumulated_click: gameClicks.get(gameId),
    });
});
// ===== Download Endpoints =====
/**
 * GET /students/download
 * Download student data as Excel
 */
app.get('/students/download', (req, res) => {
    try {
        const classFilter = req.query.classes ? req.query.classes.split(',') : [];
        let students = mocks_1.mockStudents;
        if (classFilter.length > 0) {
            students = mocks_1.mockStudents.filter(s => classFilter.includes(s.class));
        }
        // Sort students by class and class_no
        students.sort((a, b) => {
            if (a.class !== b.class) {
                return a.class.localeCompare(b.class);
            }
            return a.class_no.localeCompare(b.class_no);
        });
        // Remove password field
        const excelData = students.map(student => {
            const { password, ...studentWithoutPassword } = student;
            return studentWithoutPassword;
        });
        // Create Excel workbook
        const worksheet = XLSX.utils.json_to_sheet(excelData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Students');
        // Set column widths
        worksheet['!cols'] = [
            { wch: 12 }, { wch: 20 }, { wch: 20 }, { wch: 8 },
            { wch: 8 }, { wch: 10 }, { wch: 20 }, { wch: 20 }, { wch: 12 }
        ];
        // Generate Excel file
        const excelBuffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });
        res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        res.setHeader('Content-Disposition', `attachment; filename="students_${new Date().toISOString().split('T')[0]}.xlsx"`);
        res.send(excelBuffer);
    }
    catch (error) {
        res.status(500).json({
            success: false,
            message: 'Failed to download student data',
        });
    }
});
/**
 * GET /teachers/download
 * Download teacher data as Excel (Admin only)
 */
app.get('/teachers/download', (req, res) => {
    try {
        const teachers = mocks_1.mockTeachers.sort((a, b) => a.teacher_id.localeCompare(b.teacher_id));
        // Remove password field and format responsible_class
        const excelData = teachers.map(teacher => ({
            teacher_id: teacher.teacher_id,
            name: teacher.name,
            responsible_class: teacher.responsible_class.join(', '),
            last_login: teacher.last_login,
            is_admin: teacher.is_admin ? 'Yes' : 'No',
        }));
        // Create Excel workbook
        const worksheet = XLSX.utils.json_to_sheet(excelData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Teachers');
        // Set column widths
        worksheet['!cols'] = [
            { wch: 12 }, { wch: 20 }, { wch: 30 }, { wch: 20 }, { wch: 10 }
        ];
        // Generate Excel file
        const excelBuffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });
        res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        res.setHeader('Content-Disposition', `attachment; filename="teachers_${new Date().toISOString().split('T')[0]}.xlsx"`);
        res.send(excelBuffer);
    }
    catch (error) {
        res.status(500).json({
            success: false,
            message: 'Failed to download teacher data',
        });
    }
});
/**
 * GET /games/download
 * Download games data as Excel
 */
app.get('/games/download', (req, res) => {
    try {
        // Get games with updated click counts
        const gamesWithUpdatedClicks = mocks_1.mockGames.map(game => ({
            ...game,
            accumulated_click: gameClicks.get(game.game_id) || game.accumulated_click,
        }));
        // Sort games by game_id
        gamesWithUpdatedClicks.sort((a, b) => a.game_id.localeCompare(b.game_id));
        // Create Excel workbook
        const worksheet = XLSX.utils.json_to_sheet(gamesWithUpdatedClicks);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Games');
        // Set column widths
        worksheet['!cols'] = [
            { wch: 12 }, { wch: 30 }, { wch: 12 }, { wch: 25 }, { wch: 15 },
            { wch: 12 }, { wch: 20 }, { wch: 15 }, { wch: 40 }, { wch: 15 }
        ];
        // Generate Excel file
        const excelBuffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });
        res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        res.setHeader('Content-Disposition', `attachment; filename="games_${new Date().toISOString().split('T')[0]}.xlsx"`);
        res.send(excelBuffer);
    }
    catch (error) {
        res.status(500).json({
            success: false,
            message: 'Failed to download games data',
        });
    }
});
// ===== Server Start =====
app.listen(PORT, () => {
    console.log(`ðŸš€ Mock server running on http://localhost:${PORT}`);
    console.log(`ðŸ“š Serving mock data for local development`);
    console.log(`\nAvailable endpoints:`);
    console.log(`  POST   /auth/login`);
    console.log(`  GET    /games`);
    console.log(`  GET    /games/:gameId`);
    console.log(`  POST   /games/:gameId/click`);
    console.log(`  GET    /students/download`);
    console.log(`  GET    /teachers/download`);
    console.log(`  GET    /games/download`);
    console.log(`\nMock credentials:`);
    console.log(`  Students: STU001-STU010, password: "123"`);
    console.log(`  Teachers: TCH001-TCH002, password: "teacher123"`);
    console.log(`  Admin:    TCH003, password: "admin123"`);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2VydmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7O0FBRUgsbUNBQW9DO0FBQ3BDLDZCQUE4QjtBQUM5QixpQ0FBa0M7QUFDbEMsNkJBQTZCO0FBQzdCLHlDQUFzRTtBQUV0RSxNQUFNLEdBQUcsR0FBRyxPQUFPLEVBQUUsQ0FBQztBQUN0QixNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUM7QUFFdEMsYUFBYTtBQUNiLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztBQUNoQixHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBRXhCLG9DQUFvQztBQUNwQyxTQUFTLFlBQVksQ0FBQyxRQUFnQjtJQUNwQyxPQUFPLE1BQU0sQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUNwRSxDQUFDO0FBRUQsa0VBQWtFO0FBQ2xFLE1BQU0sVUFBVSxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO0FBRTdDLHdDQUF3QztBQUN4QyxpQkFBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtJQUN2QixVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDdkQsQ0FBQyxDQUFDLENBQUM7QUFFSCx1Q0FBdUM7QUFFdkM7OztHQUdHO0FBQ0gsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxHQUFvQixFQUFFLEdBQXFCLEVBQUUsRUFBRTtJQUN0RSxNQUFNLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7SUFFbEMsSUFBSSxDQUFD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LEdBQUcsQ0FBQywwQ0FBMEMsQ0FBQyxDQUFDO0FBQzFELENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBNb2NrIFNlcnZlciBmb3IgTG9jYWwgRGV2ZWxvcG1lbnRcbiAqIFNpbXVsYXRlcyBiYWNrZW5kIEFQSXMgdXNpbmcgbW9jayBkYXRhXG4gKi9cblxuaW1wb3J0IGV4cHJlc3MgPSByZXF1aXJlKCdleHByZXNzJyk7XG5pbXBvcnQgY29ycyA9IHJlcXVpcmUoJ2NvcnMnKTtcbmltcG9ydCBjcnlwdG8gPSByZXF1aXJlKCdjcnlwdG8nKTtcbmltcG9ydCAqIGFzIFhMU1ggZnJvbSAneGxzeCc7XG5pbXBvcnQgeyBtb2NrU3R1ZGVudHMsIG1vY2tUZWFjaGVycywgbW9ja0dhbWVzIH0gZnJvbSAnLi4vdGVzdC9tb2Nrcyc7XG5cbmNvbnN0IGFwcCA9IGV4cHJlc3MoKTtcbmNvbnN0IFBPUlQgPSBwcm9jZXNzLmVudi5QT1JUIHx8IDMwMDA7XG5cbi8vIE1pZGRsZXdhcmVcbmFwcC51c2UoY29ycygpKTtcbmFwcC51c2UoZXhwcmVzcy5qc29uKCkpO1xuXG4vLyBIZWxwZXIgZnVuY3Rpb24gdG8gaGFzaCBwYXNzd29yZHNcbmZ1bmN0aW9uIGhhc2hQYXNzd29yZChwYXNzd29yZDogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIGNyeXB0by5jcmVhdGVIYXNoKCdzaGEyNTYnKS51cGRhdGUocGFzc3dvcmQpLmRpZ2VzdCgnaGV4Jyk7XG59XG5cbi8vIEluLW1lbW9yeSBzdG9yYWdlIGZvciBnYW1lIGNsaWNrcyAoc2ltdWxhdGluZyBkYXRhYmFzZSB1cGRhdGVzKVxuY29uc3QgZ2FtZUNsaWNrcyA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XG5cbi8vIEluaXRpYWxpemUgZ2FtZSBjbGlja3MgZnJvbSBtb2NrIGRhdGFcbm1vY2tHYW1lcy5mb3JFYWNoKGdhbWUgPT4ge1xuICBnYW1lQ2xpY2tzLnNldChnYW1lLmdhbWVfaWQsIGdhbWUuYWNjdW11bGF0ZWRfY2xpY2spO1xufSk7XG5cbi8vID09PT09IEF1dGhlbnRpY2F0aW9uIEVuZHBvaW50cyA9PT09PVxuXG4vKipcbiAqIFBPU1QgL2F1dGgvbG9naW5cbiAqIExvZ2luIGVuZHBvaW50IGZvciBzdHVkZW50cyBhbmQgdGVhY2hlcnNcbiAqL1xuYXBwLnBvc3QoJy9hdXRoL2xvZ2luJywgKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpID0+IHtcbiAgY29uc3QgeyBpZCwgcGFzc3dvcmQgfSA9IHJlcS5ib2R5O1xuXG4gIGlmICghaWQgfHwgIXBhc3N3b3JkKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgbWVzc2FnZTogJ01pc3NpbmcgaWQgb3IgcGFzc3dvcmQnIH0pO1xuICB9XG5cbiAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBoYXNoUGFzc3dvcmQocGFzc3dvcmQpO1xuXG4gIC8vIFRyeSB0byBmaW5kIHN0dWRlbnQgZmlyc3RcbiAgbGV0IHVzZXIgPSBtb2NrU3R1ZGVudHMuZmluZChzID0+IHMuc3R1ZGVudF9pZCA9PT0gaWQpO1xuICBsZXQgcm9sZTogJ3N0dWRlbnQnIHwgJ3RlYWNoZXInIHwgJ2FkbWluJyA9ICdzdHVkZW50JztcblxuICAvLyBJZiBub3QgZm91bmQsIHRyeSB0ZWFjaGVyXG4gIGlmICghdXNlcikge1xuICAgIGNvbnN0IHRlYWNoZXIgPSBtb2NrVGVhY2hlcnMuZmluZCh0ID0+IHQudGVhY2hlcl9pZCA9PT0gaWQpO1xuICAgIGlmICh0ZWFjaGVyKSB7XG4gICAgICB1c2VyID0gdGVhY2hlcjtcbiAgICAgIHJvbGUgPSB0ZWFjaGVyLmlzX2FkbWluID8gJ2FkbWluJyA6ICd0ZWFjaGVyJztcbiAgICB9XG4gIH1cblxuICAvLyBWZXJpZnkgdXNlciBleGlzdHMgYW5kIHBhc3N3b3JkIG1hdGNoZXNcbiAgaWYgKCF1c2VyIHx8IHVzZXIucGFzc3dvcmQgIT09IGhhc2hlZFBhc3N3b3JkKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgbWVzc2FnZTogJ0ludmFsaWQgY3JlZGVudGlhbHMnIH0pO1xuICB9XG5cbiAgLy8gUmVtb3ZlIHBhc3N3b3JkIGZyb20gcmVzcG9uc2VcbiAgY29uc3QgeyBwYXNzd29yZDogXywgLi4udXNlcldpdGhvdXRQYXNzd29yZCB9ID0gdXNlcjtcblxuICByZXMuanNvbih7XG4gICAgc3VjY2VzczogdHJ1ZSxcbiAgICB1c2VyOiB1c2VyV2l0aG91dFBhc3N3b3JkLFxuICAgIHJvbGUsXG4gIH0pO1xufSk7XG5cbi8vID09PT09IEdhbWVzIEVuZHBvaW50cyA9PT09PVxuXG4vKipcbiAqIEdFVCAvZ2FtZXNcbiAqIEZldGNoIGFsbCBnYW1lc1xuICovXG5hcHAuZ2V0KCcvZ2FtZXMnLCAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuICAvLyBSZXR1cm4gZ2FtZXMgd2l0aCB1cGRhdGVkIGNsaWNrIGNvdW50c1xuICBjb25zdCBnYW1lc1dpdGhVcGRhdGVkQ2xpY2tzID0gbW9ja0dhbWVzLm1hcChnYW1lID0+ICh7XG4gICAgLi4uZ2FtZSxcbiAgICBhY2N1bXVsYXRlZF9jbGljazogZ2FtZUNsaWNrcy5nZXQoZ2FtZS5nYW1lX2lkKSB8fCBnYW1lLmFjY3VtdWxhdGVkX2NsaWNrLFxuICB9KSk7XG5cbiAgcmVzLmpzb24oZ2FtZXNXaXRoVXBkYXRlZENsaWNrcyk7XG59KTtcblxuLyoqXG4gKiBHRVQgL2dhbWVzLzpnYW1lSWRcbiAqIEZldGNoIGEgc2luZ2xlIGdhbWUgYnkgSURcbiAqL1xuYXBwLmdldCgnL2dhbWVzLzpnYW1lSWQnLCAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuICBjb25zdCB7IGdhbWVJZCB9ID0gcmVxLnBhcmFtcztcbiAgY29uc3QgZ2FtZSA9IG1vY2tHYW1lcy5maW5kKGcgPT4gZy5nYW1lX2lkID09PSBnYW1lSWQpO1xuXG4gIGlmICghZ2FtZSkge1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IG1lc3NhZ2U6ICdHYW1lIG5vdCBmb3VuZCcgfSk7XG4gIH1cblxuICAvLyBSZXR1cm4gZ2FtZSB3aXRoIHVwZGF0ZWQgY2xpY2sgY291bnRcbiAgcmVzLmpzb24oe1xuICAgIC4uLmdhbWUsXG4gICAgYWNjdW11bGF0ZWRfY2xpY2s6IGdhbWVDbGlja3MuZ2V0KGdhbWUuZ2FtZV9pZCkgfHwgZ2FtZS5hY2N1bXVsYXRlZF9jbGljayxcbiAgfSk7XG59KTtcblxuLyoqXG4gKiBQT1NUIC9nYW1lcy86Z2FtZUlkL2NsaWNrXG4gKiBJbmNyZW1lbnQgZ2FtZSBjbGljayBjb3VudFxuICovXG5hcHAucG9zdCgnL2dhbWVzLzpnYW1lSWQvY2xpY2snLCAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuICBjb25zdCB7IGdhbWVJZCB9ID0gcmVxLnBhcmFtcztcbiAgY29uc3QgZ2FtZSA9IG1vY2tHYW1lcy5maW5kKGcgPT4gZy5nYW1lX2lkID09PSBnYW1lSWQpO1xuXG4gIGlmICghZ2FtZSkge1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IG1lc3NhZ2U6ICdHYW1lIG5vdCBmb3VuZCcgfSk7XG4gIH1cblxuICAvLyBJbmNyZW1lbnQgY2xpY2sgY291bnRcbiAgY29uc3QgY3VycmVudENsaWNrcyA9IGdhbWVDbGlja3MuZ2V0KGdhbWVJZCkgfHwgZ2FtZS5hY2N1bXVsYXRlZF9jbGljaztcbiAgZ2FtZUNsaWNrcy5zZXQoZ2FtZUlkLCBjdXJyZW50Q2xpY2tzICsgMSk7XG5cbiAgcmVzLmpzb24oe1xuICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgYWNjdW11bGF0ZWRfY2xpY2s6IGdhbWVDbGlja3MuZ2V0KGdhbWVJZCksXG4gIH0pO1xufSk7XG5cbi8vID09PT09IERvd25sb2FkIEVuZHBvaW50cyA9PT09PVxuXG4vKipcbiAqIEdFVCAvc3R1ZGVudHMvZG93bmxvYWRcbiAqIERvd25sb2FkIHN0dWRlbnQgZGF0YSBhcyBFeGNlbFxuICovXG5hcHAuZ2V0KCcvc3R1ZGVudHMvZG93bmxvYWQnLCAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGNsYXNzRmlsdGVyID0gcmVxLnF1ZXJ5LmNsYXNzZXMgPyAocmVxLnF1ZXJ5LmNsYXNzZXMgYXMgc3RyaW5nKS5zcGxpdCgnLCcpIDogW107XG4gICAgXG4gICAgbGV0IHN0dWRlbnRzID0gbW9ja1N0dWRlbnRzO1xuICAgIGlmIChjbGFzc0ZpbHRlci5sZW5ndGggPiAwKSB7XG4gICAgICBzdHVkZW50cyA9IG1vY2tTdHVkZW50cy5maWx0ZXIocyA9PiBjbGFzc0ZpbHRlci5pbmNsdWRlcyhzLmNsYXNzKSk7XG4gICAgfVxuXG4gICAgLy8gU29ydCBzdHVkZW50cyBieSBjbGFzcyBhbmQgY2xhc3Nfbm9cbiAgICBzdHVkZW50cy5zb3J0KChhLCBiKSA9PiB7XG4gICAgICBpZiAoYS5jbGFzcyAhPT0gYi5jbGFzcykge1xuICAgICAgICByZXR1cm4gYS5jbGFzcy5sb2NhbGVDb21wYXJlKGIuY2xhc3MpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGEuY2xhc3Nfbm8ubG9jYWxlQ29tcGFyZShiLmNsYXNzX25vKTtcbiAgICB9KTtcblxuICAgIC8vIFJlbW92ZSBwYXNzd29yZCBmaWVsZFxuICAgIGNvbnN0IGV4Y2VsRGF0YSA9IHN0dWRlbnRzLm1hcChzdHVkZW50ID0+IHtcbiAgICAgIGNvbnN0IHsgcGFzc3dvcmQsIC4uLnN0dWRlbnRXaXRob3V0UGFzc3dvcmQgfSA9IHN0dWRlbnQ7XG4gICAgICByZXR1cm4gc3R1ZGVudFdpdGhvdXRQYXNzd29yZDtcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBFeGNlbCB3b3JrYm9va1xuICAgIGNvbnN0IHdvcmtzaGVldCA9IFhMU1gudXRpbHMuanNvbl90b19zaGVldChleGNlbERhdGEpO1xuICAgIGNvbnN0IHdvcmtib29rID0gWExTWC51dGlscy5ib29rX25ldygpO1xuICAgIFhMU1gudXRpbHMuYm9va19hcHBlbmRfc2hlZXQod29ya2Jvb2ssIHdvcmtzaGVldCwgJ1N0dWRlbnRzJyk7XG5cbiAgICAvLyBTZXQgY29sdW1uIHdpZHRoc1xuICAgIHdvcmtzaGVldFsnIWNvbHMnXSA9IFtcbiAgICAgIHsgd2NoOiAxMiB9LCB7IHdjaDogMjAgfSwgeyB3Y2g6IDIwIH0sIHsgd2NoOiA4IH0sXG4gICAgICB7IHdjaDogOCB9LCB7IHdjaDogMTAgfSwgeyB3Y2g6IDIwIH0sIHsgd2NoOiAyMCB9LCB7IHdjaDogMTIgfVxuICAgIF07XG5cbiAgICAvLyBHZW5lcmF0ZSBFeGNlbCBmaWxlXG4gICAgY29uc3QgZXhjZWxCdWZmZXIgPSBYTFNYLndyaXRlKHdvcmtib29rLCB7IHR5cGU6ICdidWZmZXInLCBib29rVHlwZTogJ3hsc3gnIH0pO1xuXG4gICAgcmVzLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC5zcHJlYWRzaGVldG1sLnNoZWV0Jyk7XG4gICAgcmVzLnNldEhlYWRlcignQ29udGVudC1EaXNwb3NpdGlvbicsIGBhdHRhY2htZW50OyBmaWxlbmFtZT1cInN0dWRlbnRzXyR7bmV3IERhdGUoKS50b0lTT1N0cmluZygpLnNwbGl0KCdUJylbMF19Lnhsc3hcImApO1xuICAgIHJlcy5zZW5kKGV4Y2VsQnVmZmVyKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gZG93bmxvYWQgc3R1ZGVudCBkYXRhJyxcbiAgICB9KTtcbiAgfVxufSk7XG5cbi8qKlxuICogR0VUIC90ZWFjaGVycy9kb3dubG9hZFxuICogRG93bmxvYWQgdGVhY2hlciBkYXRhIGFzIEV4Y2VsIChBZG1pbiBvbmx5KVxuICovXG5hcHAuZ2V0KCcvdGVhY2hlcnMvZG93bmxvYWQnLCAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHRlYWNoZXJzID0gbW9ja1RlYWNoZXJzLnNvcnQoKGEsIGIpID0+IGEudGVhY2hlcl9pZC5sb2NhbGVDb21wYXJlKGIudGVhY2hlcl9pZCkpO1xuXG4gICAgLy8gUmVtb3ZlIHBhc3N3b3JkIGZpZWxkIGFuZCBmb3JtYXQgcmVzcG9uc2libGVfY2xhc3NcbiAgICBjb25zdCBleGNlbERhdGEgPSB0ZWFjaGVycy5tYXAodGVhY2hlciA9PiAoe1xuICAgICAgdGVhY2hlcl9pZDogdGVhY2hlci50ZWFjaGVyX2lkLFxuICAgICAgbmFtZTogdGVhY2hlci5uYW1lLFxuICAgICAgcmVzcG9uc2libGVfY2xhc3M6IHRlYWNoZXIucmVzcG9uc2libGVfY2xhc3Muam9pbignLCAnKSxcbiAgICAgIGxhc3RfbG9naW46IHRlYWNoZXIubGFzdF9sb2dpbixcbiAgICAgIGlzX2FkbWluOiB0ZWFjaGVyLmlzX2FkbWluID8gJ1llcycgOiAnTm8nLFxuICAgIH0pKTtcblxuICAgIC8vIENyZWF0ZSBFeGNlbCB3b3JrYm9va1xuICAgIGNvbnN0IHdvcmtzaGVldCA9IFhMU1gudXRpbHMuanNvbl90b19zaGVldChleGNlbERhdGEpO1xuICAgIGNvbnN0IHdvcmtib29rID0gWExTWC51dGlscy5ib29rX25ldygpO1xuICAgIFhMU1gudXRpbHMuYm9va19hcHBlbmRfc2hlZXQod29ya2Jvb2ssIHdvcmtzaGVldCwgJ1RlYWNoZXJzJyk7XG5cbiAgICAvLyBTZXQgY29sdW1uIHdpZHRoc1xuICAgIHdvcmtzaGVldFsnIWNvbHMnXSA9IFtcbiAgICAgIHsgd2NoOiAxMiB9LCB7IHdjaDogMjAgfSwgeyB3Y2g6IDMwIH0sIHsgd2NoOiAyMCB9LCB7IHdjaDogMTAgfVxuICAgIF07XG5cbiAgICAvLyBHZW5lcmF0ZSBFeGNlbCBmaWxlXG4gICAgY29uc3QgZXhjZWxCdWZmZXIgPSBYTFNYLndyaXRlKHdvcmtib29rLCB7IHR5cGU6ICdidWZmZXInLCBib29rVHlwZTogJ3hsc3gnIH0pO1xuXG4gICAgcmVzLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC5zcHJlYWRzaGVldG1sLnNoZWV0Jyk7XG4gICAgcmVzLnNldEhlYWRlcignQ29udGVudC1EaXNwb3NpdGlvbicsIGBhdHRhY2htZW50OyBmaWxlbmFtZT1cInRlYWNoZXJzXyR7bmV3IERhdGUoKS50b0lTT1N0cmluZygpLnNwbGl0KCdUJylbMF19Lnhsc3hcImApO1xuICAgIHJlcy5zZW5kKGV4Y2VsQnVmZmVyKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gZG93bmxvYWQgdGVhY2hlciBkYXRhJyxcbiAgICB9KTtcbiAgfVxufSk7XG5cbi8qKlxuICogR0VUIC9nYW1lcy9kb3dubG9hZFxuICogRG93bmxvYWQgZ2FtZXMgZGF0YSBhcyBFeGNlbFxuICovXG5hcHAuZ2V0KCcvZ2FtZXMvZG93bmxvYWQnLCAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuICB0cnkge1xuICAgIC8vIEdldCBnYW1lcyB3aXRoIHVwZGF0ZWQgY2xpY2sgY291bnRzXG4gICAgY29uc3QgZ2FtZXNXaXRoVXBkYXRlZENsaWNrcyA9IG1vY2tHYW1lcy5tYXAoZ2FtZSA9PiAoe1xuICAgICAgLi4uZ2FtZSxcbiAgICAgIGFjY3VtdWxhdGVkX2NsaWNrOiBnYW1lQ2xpY2tzLmdldChnYW1lLmdhbWVfaWQpIHx8IGdhbWUuYWNjdW11bGF0ZWRfY2xpY2ssXG4gICAgfSkpO1xuXG4gICAgLy8gU29ydCBnYW1lcyBieSBnYW1lX2lkXG4gICAgZ2FtZXNXaXRoVXBkYXRlZENsaWNrcy5zb3J0KChhLCBiKSA9PiBhLmdhbWVfaWQubG9jYWxlQ29tcGFyZShiLmdhbWVfaWQpKTtcblxuICAgIC8vIENyZWF0ZSBFeGNlbCB3b3JrYm9va1xuICAgIGNvbnN0IHdvcmtzaGVldCA9IFhMU1gudXRpbHMuanNvbl90b19zaGVldChnYW1lc1dpdGhVcGRhdGVkQ2xpY2tzKTtcbiAgICBjb25zdCB3b3JrYm9vayA9IFhMU1gudXRpbHMuYm9va19uZXcoKTtcbiAgICBYTFNYLnV0aWxzLmJvb2tfYXBwZW5kX3NoZWV0KHdvcmtib29rLCB3b3Jrc2hlZXQsICdHYW1lcycpO1xuXG4gICAgLy8gU2V0IGNvbHVtbiB3aWR0aHNcbiAgICB3b3Jrc2hlZXRbJyFjb2xzJ10gPSBbXG4gICAgICB7IHdjaDogMTIgfSwgeyB3Y2g6IDMwIH0sIHsgd2NoOiAxMiB9LCB7IHdjaDogMjUgfSwgeyB3Y2g6IDE1IH0sXG4gICAgICB7IHdjaDogMTIgfSwgeyB3Y2g6IDIwIH0sIHsgd2NoOiAxNSB9LCB7IHdjaDogNDAgfSwgeyB3Y2g6IDE1IH1cbiAgICBdO1xuXG4gICAgLy8gR2VuZXJhdGUgRXhjZWwgZmlsZVxuICAgIGNvbnN0IGV4Y2VsQnVmZmVyID0gWExTWC53cml0ZSh3b3JrYm9vaywgeyB0eXBlOiAnYnVmZmVyJywgYm9va1R5cGU6ICd4bHN4JyB9KTtcblxuICAgIHJlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtb2ZmaWNlZG9jdW1lbnQuc3ByZWFkc2hlZXRtbC5zaGVldCcpO1xuICAgIHJlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtRGlzcG9zaXRpb24nLCBgYXR0YWNobWVudDsgZmlsZW5hbWU9XCJnYW1lc18ke25ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zcGxpdCgnVCcpWzBdfS54bHN4XCJgKTtcbiAgICByZXMuc2VuZChleGNlbEJ1ZmZlcik7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIGRvd25sb2FkIGdhbWVzIGRhdGEnLFxuICAgIH0pO1xuICB9XG59KTtcblxuLy8gPT09PT0gU2VydmVyIFN0YXJ0ID09PT09XG5cbmFwcC5saXN0ZW4oUE9SVCwgKCkgPT4ge1xuICBjb25zb2xlLmxvZyhg8J+agCBNb2NrIHNlcnZlciBydW5uaW5nIG9uIGh0dHA6Ly9sb2NhbGhvc3Q6JHtQT1JUfWApO1xuICBjb25zb2xlLmxvZyhg8J+TmiBTZXJ2aW5nIG1vY2sgZGF0YSBmb3IgbG9jYWwgZGV2ZWxvcG1lbnRgKTtcbiAgY29uc29sZS5sb2coYFxcbkF2YWlsYWJsZSBlbmRwb2ludHM6YCk7XG4gIGNvbnNvbGUubG9nKGAgIFBPU1QgICAvYXV0aC9sb2dpbmApO1xuICBjb25zb2xlLmxvZyhgICBHRVQgICAgL2dhbWVzYCk7XG4gIGNvbnNvbGUubG9nKGAgIEdFVCAgICAvZ2FtZXMvOmdhbWVJZGApO1xuICBjb25zb2xlLmxvZyhgICBQT1NUICAgL2dhbWVzLzpnYW1lSWQvY2xpY2tgKTtcbiAgY29uc29sZS5sb2coYCAgR0VUICAgIC9zdHVkZW50cy9kb3dubG9hZGApO1xuICBjb25zb2xlLmxvZyhgICBHRVQgICAgL3RlYWNoZXJzL2Rvd25sb2FkYCk7XG4gIGNvbnNvbGUubG9nKGAgIEdFVCAgICAvZ2FtZXMvZG93bmxvYWRgKTtcbiAgY29uc29sZS5sb2coYFxcbk1vY2sgY3JlZGVudGlhbHM6YCk7XG4gIGNvbnNvbGUubG9nKGAgIFN0dWRlbnRzOiBTVFUwMDEtU1RVMDEwLCBwYXNzd29yZDogXCIxMjNcImApO1xuICBjb25zb2xlLmxvZyhgICBUZWFjaGVyczogVENIMDAxLVRDSDAwMiwgcGFzc3dvcmQ6IFwidGVhY2hlcjEyM1wiYCk7XG4gIGNvbnNvbGUubG9nKGAgIEFkbWluOiAgICBUQ0gwMDMsIHBhc3N3b3JkOiBcImFkbWluMTIzXCJgKTtcbn0pO1xuIl19